---
title: 'E8 main document'
author: "Marissa Lee"
date: "October 23, 2015"
output: pdf_document
---

**Filename: E8_main.Rmd'**

_________________________________________________________________
# 0. Import, clean, merge, load fxns
```{r libraries, echo=FALSE}
knitr::opts_chunk$set(cache=TRUE)

#LIBRARIES
library(plyr)
library(reshape2)
library(ggplot2) #plotting
library(ggthemes) #ggplot accessories
library(GGally) #????
library(gtable)
library(gridExtra) #for grid.arrange fxn
library(lme4) #for mixed-effects models
library(lmerTest) #for lmer p-values
library(vegan) #for adonis fxn to do perMANOVAs
library(lavaan) #for structural equation modeling
library(doBy) #the orderBy fxn
library(merTools)
#library(bpca) #for 3d plots
#load other libraries
library(car) #Anova()
library(QuantPsyc) #lm.beta()
library(semPlot)
library(piecewiseSEM)

#CUSTOM FUNCTIONS
source('CODE/fxn_reshapeHelpers.R')
source('CODE/fxn_PCAhelpers.R')
source('CODE/fxn_NMDShelpers.R')
source('CODE/fxn_InvEffect.R') #calculate invasion effect in a mixed effects model
source('CODE/fxn_predictHelpers.R') #creates dataframes to feed into model predictions

#THEME
source('CODE/mytheme_data_a.R')

#IMPORT, CLEAN, MERGE
source('CODE/script_cleanMerge.R')
#saves plot 'pHist_depth.png'
#saves data 'data_a.txt' # aggregated mean(depth) for 2012 and 2013
#saves data 'data_d.txt' # removed variables that were only measured in 2011 (i.e. full soil depth 0-15cm measurements)

#decide what dataset to use
data.choice<-data_a
```

_________________________________________________________________
# 0. Visualize data
```{r visualize, echo=FALSE}
source('CODE/script_visualize.R')
#saves the following plots:
#plot N variables - NMDS, PCA x plot points, site vectors
#all plot variables - NMDS, PCA x plot points, site vectors
#reference plot and site variables - NMDS, PCA
#saves the following tables:
#PCA loadings for plot N variables, all plot variablers, reference plot and site variables
```

_________________________________________________________________
# 1. Q1: Do soil N pools and fluxes shift in response to the presence of Microstegium? 
A. Do an ordination of soil N pools and fluxes and test the role of invasion status with permMANOVA
B. Investigate individual relationships using mixed effects models with year+site as a random effect and identify N variables that increase/decrease across sites.
```{r q1, echo=FALSE, message=FALSE, warning=FALSE}
nVars #variables in the analyses

source('CODE/script_q1A.R')
#saves table 'permMANOVA_q1.txt' #result of permMANOVA of the ordination given plot invasion status

source('CODE/script_q1B.R')
#B. Mixed effects models (soil N pool or flux value ~ inv + (1|siteYear))
#saves table 'meanSummary_q1.txt' #summary of individual soil N pools and fluxes by year and invasion status
#saves table 'summarySummary_q1.txt' #summary of individual mixed effect models for each soil N pool or flux
#saves table 'posthocSummary_q1.txt' #post-hoc comparisons among years and invasion status
#saves plot 'pScat_q1.png' #panels of soil N pool or flux ~ inv
```

_________________________________________________________________
# 2. Q2: Do reference plot conditions and/or Microstegium biomass predict impact magnitudes?
A. Calculate impact magnitude for each target variable (nitrate, nitrification, other variables detected in Q1 ordination)
B. Test the role of reference plot conditions and Microstegium biomass on impacts individually using mixed effects models with year as a random effect
```{r q2, echo=FALSE, message=FALSE, warning=FALSE}
##A. Calculate impact, prep dataset

#1. decide of difference variables
diffVars<-c('noi_T','noi_B','ammonifd_T','ammonifd_B','nitrifd_T','nitrifd_B','minzd_T','minzd_B')

#2. decide on what variables to include in the reference ordination
allVars
#allVars2 #without PercBA_AM
#allVars.AggPAR
#allVars2.AggPAR #without PercBA_AM
useThese_refVars<-allVars

#3. decide whether to include PercBA_AM as a separate parameter
#externalPercBA_AM<-'y'
externalPercBA_AM<-'n'

#4. prep dataset
source('CODE/script_q2_prep.R')
#View(data.q2)


##B. Run models for each of the following (Inv. - Ref): nitrate, nitrif, ammonif, minz 

#1. decide on model formulation
modelFormulaCode<-'PC1*PC2*Mv'
#modelFormulaCode<-'PC1+PC2+Mv'
#modelFormulaCode<-'PC1*PC2*AM*Mv'
#modelFormulaCode<-'PC1+PC2+AM+Mv'


#2. run models
source('CODE/script_q2.R')
PC1var.c.o
PC2var.c.o
mod.df[mod.df$pval<0.05,]

#check out some other models that disaggregate the varibles that are in PC1 and PC2
source('CODE/extraScript_lookAtOtherModels.R')

#3. make plots

####################################
#a. delta nitrate (inv-ref)
####################################
df.mod<-mod.noi[['df.mod.used']]
modT<-mod.noi[['modT']]

#set up PC2 levels
df.mod$factorLevel<-NA
lowLabel<-'Low light, many trees (PC2)'
highLabel<-'High light, few trees (PC2)'
df.mod[df.mod$PC2 >= quantile(df.mod$PC2)[1] & df.mod$PC2 < quantile(df.mod$PC2)[3],'factorLevel']<-lowLabel
df.mod[df.mod$PC2 >= quantile(df.mod$PC2)[3] & df.mod$PC2 <= quantile(df.mod$PC2)[5],'factorLevel']<-highLabel
df.mod$factorLevel<-factor(df.mod$factorLevel, levels=c(lowLabel, highLabel))

#plot: diff noi_T ~ Mvbiomass by PC2 levels
#prediction data frames ...
df.pred<-InteractionPlot_DF(n=100, xVar='mv_g.m2_logt', 
                            factorVar='PC2', factorBin='factorLevel', 
                            constantVar='PC1', 
                            df=df.mod, mod=modT)

#remove the year intercept
mod.coefs<-coef(modT)$year
int2012<-mod.coefs[1,1]
int2013<-mod.coefs[2,1]
int.Diff<-int2012 - int2013
df.mod$select.diffVarT.minusYr<-df.mod$select.diffVarT
df.mod[df.mod$year==2012,'select.diffVarT.minusYr']<-df.mod[df.mod$year==2012,'select.diffVarT'] - int.Diff

#plot
pScat.noiDiff_MvPC2<-ggplot(data=df.pred, 
                            mapping=aes(x=mv_g.m2_logt, 
                                        y=ypred.minusYr, 
                                        ymin=CI.lwr.minusYr, ymax=CI.upr.minusYr))  +  
  geom_ribbon(alpha=0.4) +
  geom_line() +
  facet_grid(~factorLevel) +
  geom_abline(intercept=0,slope=0, linetype=3, color='gray50') + 
  mytheme + ylab(expression(paste(Delta," Nitrate 0-5cm (Inv.-Ref.)"))) + xlab('Microstegium biomass (log g/m2)') + 
  geom_point(data=df.mod, aes(y=select.diffVarT.minusYr, ymin=NULL, ymax=NULL)) 
pScat.noiDiff_MvPC2
#save plots
newfilename<-"pScat_noiDiff.png"
png(paste(figuresPath,newfilename, sep='/'), units='in', 
    width = fig.width*2, height = fig.height*1.2, res=fig.res)
pScat.noiDiff_MvPC2 + guides(linetype=FALSE, fill=FALSE)
dev.off()


####################################
#b. delta ammonification (inv-ref)
####################################
df.mod<-mod.ammonifd[['df.mod.used']]
modT<-mod.ammonifd[['modT']]

#set up PC1 levels
df.mod$factorLevel<-NA
lowLabel<-'Low moisture & OM (PC1)'
highLabel<-'High moisture & OM (PC1)'
df.mod[df.mod$PC1 >= quantile(df.mod$PC1)[1] & df.mod$PC1 < quantile(df.mod$PC1)[3],'factorLevel']<-lowLabel
df.mod[df.mod$PC1 >= quantile(df.mod$PC1)[3] & df.mod$PC1 <= quantile(df.mod$PC1)[5],'factorLevel']<-highLabel
df.mod$factorLevel<-factor(df.mod$factorLevel, levels=c(lowLabel, highLabel))

#set up PC2 levels
df.mod$factorLevel2<-NA
lowLabel<-'Low light, more trees (PC2)'
highLabel<-'High light, few trees (PC2)'
df.mod[df.mod$PC2 >= quantile(df.mod$PC2)[1] & df.mod$PC2 < quantile(df.mod$PC2)[3],'factorLevel2']<-lowLabel
df.mod[df.mod$PC2 >= quantile(df.mod$PC2)[3] & df.mod$PC2 <= quantile(df.mod$PC2)[5],'factorLevel2']<-highLabel
df.mod$factorLevel2<-factor(df.mod$factorLevel2, levels=c(lowLabel, highLabel))

#plot: diff ammonif_T ~ Mvbiomass by PC1 levels
#prediction data frames ...
df.pred1<-InteractionPlot_DF(n=100, xVar='mv_g.m2_logt', 
                            factorVar='PC1', factorBin='factorLevel', 
                            constantVar='PC2', 
                            df=df.mod, mod=modT)

#remove the year intercept
mod.coefs<-coef(modT)$year
int2012<-mod.coefs[1,1]
int2013<-mod.coefs[2,1]
int.Diff<-int2012 - int2013
df.mod$select.diffVarT.minusYr<-df.mod$select.diffVarT
df.mod[df.mod$year==2012,'select.diffVarT.minusYr']<-df.mod[df.mod$year==2012,'select.diffVarT'] - int.Diff

#plot
pScat.ammonifdDiff_MvPC1<-ggplot(data=df.pred1, 
                                 mapping=aes(x=mv_g.m2_logt, 
                                             y=ypred.minusYr, 
                                             ymin=CI.lwr.minusYr, ymax=CI.upr.minusYr))  +  
  geom_ribbon(alpha=0.4) +
  geom_line() +
  facet_grid(~factorLevel) +
  geom_abline(intercept=0,slope=0, linetype=3, color='gray50') + 
  mytheme + ylab(expression(paste(Delta," Ammonif. 0-5cm (Inv.-Ref.)"))) + 
  xlab('Microstegium biomass (log g/m2)') + 
  geom_point(data=df.mod, aes(y=select.diffVarT.minusYr, ymin=NULL, ymax=NULL))
pScat.ammonifdDiff_MvPC1

#plot: diff ammonifd_T ~ PC2 by PC1 levels
#prediction data frames ...
df.pred2<-InteractionPlot_DF(n=100, xVar='PC2', 
                            factorVar='PC1', factorBin='factorLevel', 
                            constantVar='mv_g.m2_logt', 
                            df=df.mod, mod=modT)
pScat.ammonifdDiff_PC2PC1<-ggplot(data=df.pred2, 
                                  mapping=aes(x=PC2, 
                                              y=ypred.minusYr, 
                                              ymin=CI.lwr.minusYr, ymax=CI.upr.minusYr))  +  
  geom_ribbon(alpha=0.4) +
  geom_line() +
  facet_grid(~factorLevel) +
  geom_abline(intercept=0,slope=0, linetype=3, color='gray50') + 
  mytheme + ylab(expression(paste(Delta," Ammonif. 0-5cm (Inv.-Ref.)"))) + 
  xlab('PC2 (increasing light, decreasing trees)') + 
  geom_point(data=df.mod, aes(y=select.diffVarT.minusYr, ymin=NULL, ymax=NULL))
pScat.ammonifdDiff_PC2PC1

#save plots
newfilename<-'pScat.ammonifdDiff.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*2, height = fig.height*2.2, res=fig.res)
grid.arrange(pScat.ammonifdDiff_MvPC1 + guides(linetype=FALSE, fill=FALSE),
             pScat.ammonifdDiff_PC2PC1+ guides(linetype=FALSE, fill=FALSE))
dev.off()


```

_________________________________________________________________
# 3. Q3: Do reference plot conditions predict Microstegium biomass?
A. Do an ordination of reference conditions and test the relationship between Microstegium biomass and reference conditions using permMANOVA.
B. Investigate relationship between PC scores and Microstegium biomass using mixed effects models with year as a random effect.
```{r q3, echo=FALSE, message=FALSE, warning=FALSE}
#A. Do an ordination of reference conditions and test the relationship between Microstegium biomass and reference conditions using permMANOVA.

#i) Identify reference plot condition variables
useThese_refVars<-allVars
data.refVars<-data.choice[data.choice$variable %in% useThese_refVars, c('plotid','plothalfid1','inv','year','variable','value')]
data.refVars$variable<-factor(data.refVars$variable, levels=useThese_refVars)
data.refVars<-subset(data.refVars, inv == 'N')
data.refVars.wide<-dcast(data.refVars, plotid + year ~ variable, value.var='value')
data.refVars.wide$plotYear<-paste(data.refVars.wide$plotid, data.refVars.wide$year, sep="_")
data.q3<-data.refVars.wide

#2) Ordinate reference conditions
data.q3.rm<-data.q3[!rowSums(is.na(data.q3))>0,]
tmp<-data.q3.rm[,useThese_refVars]
colnames(tmp)<-useThese_refVars
#cor(tmp) #look at correlation matrix
row.names(tmp)<-data.q3.rm$plotYear
tmp.scaled<-scale(tmp)
PCA.res<-prcomp(tmp.scaled)
pPCA_q3<-ggbiplot_custom(pcobj=PCA.res, df=data.q3.rm) #saved in 'script_visualize.R'
pPCA_q3
df.PCA<-data.frame(plotYear=row.names(PCA.res$x), PCA.res$x)

#add Mv biomass to dataset
colnames(data.mvVar.wide) #from 'script_q2_prep.R'
data.mvVar.wide$plotYear<-paste(data.mvVar.wide$plotid, data.mvVar.wide$year, sep="_")
data.q3.PCA<-merge(data.mvVar.wide, df.PCA[,c(1:3)])

#3) Do reference area and plot characteristics explain variation in Mv biomass? - perMANOVA on mv biomass
perMANOVA<-adonis(tmp.scaled ~ mv_g.m2, data = data.q3.PCA, method='eu')
aov.tab.permanova<-data.frame(perMANOVA$aov.tab)
aov.tab.permanova
#save anova table
newfilename<-'permMANOVA_q3.txt'
write.table(aov.tab.permanova, file=paste(figuresPath,newfilename, sep='/'), sep='\t')


#B. Do PC scores from the reference condition ordination predict mv biomass?
#1) Fit model
data.q3.PCA$year<-factor(data.q3.PCA$year)
df.mod<-data.q3.PCA
df.mod$PC2_neg1<-df.mod$PC2*-1

#If PercBA_AM should be included separately from reference conditions...Identify PercBA_AM and merge it into dataset
#externalPercBA_AM
if(externalPercBA_AM == 'y'){
  
  #merge
  df.mod<-merge(df.mod, data.AM.wide)

  #make a bin for %AM
  df.mod$MycBin<-NA
  df.mod[df.mod$PercBA_AM >=0 & df.mod$PercBA_AM <50,'MycBin']<-'AM'
  df.mod[df.mod$PercBA_AM >=50 & df.mod$PercBA_AM <=100,'MycBin']<-'ECM'
  
  mod<-lmer(mv_g.m2_logt~PC1*PC2*MycBin + (1|year), data=df.mod)
}else{
  mod<-lmer(mv_g.m2_logt~PC1*PC2_neg1 + (1|year), data=df.mod)
}
summary(mod)$coefficients
#save anova table
newfilename<-'summaryTable_q3.txt'
write.table(summary(mod)$coefficients, file=paste(figuresPath,newfilename, sep='/'), sep='\t')

#2) Plot
#set up prediction dataframes
df.pred<-XYPlot_DF(n=100, xVar='PC2_neg1', constantVar='PC1', df=df.mod, mod=mod)

#remove the year intercept
mod.coefs<-coef(mod)$year
int2012<-mod.coefs[1,1]
int2013<-mod.coefs[2,1]
int.Diff<-int2012 - int2013
df.mod$mv_g.m2_logt.minusYr<-df.mod$mv_g.m2_logt
df.mod[df.mod$year==2012,'mv_g.m2_logt.minusYr']<-df.mod[df.mod$year==2012,'mv_g.m2_logt'] - int.Diff

#plot
pScat.Mv_PC2<-ggplot(data=df.pred, 
                     mapping=aes(x=PC2_neg1, 
                                 y=ypred.minusYr, 
                                 ymin=CI.lwr.minusYr, ymax=CI.upr.minusYr))  +  
  geom_ribbon(alpha=0.4) +
  geom_line() +
  mytheme + ylab('Microstegium biomass (log g/m2)') + xlab('PC2*-1\n(increasing light, decreasing trees)') + 
  geom_point(data=df.mod, aes(y=mv_g.m2_logt.minusYr, ymin=NULL, ymax=NULL))
pScat.Mv_PC2

#save plot
newfilename<-'pScat_q3.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', 
    width = fig.width*1, height = fig.height*1.05, res=fig.res)
pScat.Mv_PC2
dev.off()

```

_________________________________________________________________
# 4. Q4: What is the relative importance of reference conditions on impact - direct and indirectly
```{r q4, echo=FALSE, message=FALSE, warning=FALSE}

################
# Model: Additive effects of PC1 and PC2 on invasion impact

#1. prep dataframe
df.mod<-mod.ammonifd[['df.mod.used']]
df.full<-merge(df.mod, data.q2)
diffVarShort<-'ammonifd_T'
select.diffVar<-paste('Diff',diffVarShort, sep='_')
selectCols<-c('plotYear','year','mv_g.m2_logt',select.diffVar,'PC1','PC2')
df<-df.full[,selectCols]
colnames(df)
colnames(df)<-c('plotYear','year','mv','impact','PC1','PC2')

#2. look at dataset
pairs(df)

#3. Fit SEM models

########
#mod1 = Piecewise SEM (no random intercept for year)
#fit the pieces
Mv_LM<-lm(mv ~ PC1 + PC2, data=df)
Imp_LM<-lm(impact ~ mv + PC1 + PC2, data=df)
#evaluate the pieces
Anova(Mv_LM) #PC2 is signif
Anova(Imp_LM) #Mv is signif
#standardized coefficients & r^2
lm.beta(Mv_LM) 
lm.beta(Imp_LM)
summary(Mv_LM)$r.squared
summary(Imp_LM)$r.squared
#draw model fit results
semPaths(Mv_LM+Imp_LM, layout="tree", "std", intercepts=FALSE)

########
#mod1r = Piecewise SEM with random intercept for year
mn<-mult.norm(df[,c('PC1','PC2','mv','impact')], chicrit = 0.005)
mn$Dsq > mn$CriticalDsq #Are Mahalanobis distances greater than the critical value?
#if the observation's Mahalanobis distance is NOT greater than the critical value, than the observation is NOT an outlier -- correct interpretation?

hist(df$impact) #should I add a constant to make all these values positive??
hist(df$mv) #this has been log-transformed
hist(df$PC1) #should I add a constant to make all these values positive??
hist(df$PC2) #should I add a constant to make all these values positive??

modlist <- list(
  lmer(mv ~ PC1 + PC2 + (1|year), data=df),
  lmer(impact ~ mv + PC1 + PC2 + (1|year), data=df)
  )

#can't test the fit because the model is fully saturated
sem.mod.fit<-sem.fit(modlist, data=df) 
sem.mod.fit

#non-standardized path coefs
coefs<-sem.coefs(modelList=modlist, data=df, standardize="none")
coefs

#standardized path coefs
sem.coefs(modelList=modlist, data=df, standardize="scale") #weird error message

#function to standardize path coefs
StdCoefs.manual<-function(sem.coef.obj, data){
  #1. pull non-standardized path coef
  unstd.coefs<-sem.coef.obj[,'estimate']
  
  #2. identify x and y data columns for that coef
  std.coefs<-list()
  i<-0
  for(i in 1:length(unstd.coefs)){
  
    #identify x and y variable names
    y.var.name<-sem.coef.obj[sem.coef.obj$estimate==unstd.coefs[i],'response']
    x.var.name<-sem.coef.obj[sem.coef.obj$estimate==unstd.coefs[i],'predictor']
    
    #identify x and y data
    y<-data[,as.character(y.var.name)]
    x<-data[,as.character(x.var.name)]
    
    #calculated standardized path coef
    std.coef<-unstd.coefs[i]*sd(x)/sd(y)
    std.coefs[[i]]<-std.coef
    
  }
  sem.coef.obj$std.estimate<-unlist(std.coefs)
  
  return(sem.coef.obj)
  }

coefs<-StdCoefs.manual(sem.coef.obj=coefs, data=df)
coefs

#R2 values
sem.model.fits(modlist)

########

#Model 2

#1. prep dataframe

#reshape full dataset
data.tmp<-QuickReshape1(variables=allVars, variableNames=allVars, select.inv='both')
data.tmp1<-data.tmp$data.vars.wide.rm
NonValCols.tmp1<-data.tmp$NonValCols

#make it wide
m.data.tmp2<-melt(data.tmp1, id.vars=NonValCols.tmp1)
m1.data.tmp2<-m.data.tmp2[,!colnames(m.data.tmp2) %in% c('plothalfid1','plotInvYear')]
df<-dcast(m1.data.tmp2, plotid+year+plotYear~inv+variable)

#merge with impact values
df.mod<-mod.ammonifd[['df.mod.used']]
df<-merge(df.mod, df)

#remove 5-15cm layer measurements
removeThese<-c(colnames(df)[grep('_B',colnames(df))], 'select.diffVarB')
dfT<-df[,!colnames(df) %in% removeThese] #remove columns with data from the 5-15cm soil depth

#remove invaded plot measuresment
#removeThese<-colnames(dfT)[grep('I_',colnames(dfT))]
#dfT1<-dfT[,!colnames(dfT) %in% removeThese] #remove columns with data from the 5-15cm soil depth

#remove reference plot measures that match impact
#dfT2<-dfT1[,!colnames(dfT1) %in% c('N_ammonifd_T')]

#remove reference plot measures that do not load heavily onto PC1 or 2
#soil comp (PC1) <- soilmoi, som, nitrifd
#canopy comp (PC2) <- PercBA_AM, nTrees, percpar, ph, litterbiom
#removeThese<-c('N_nh_T','N_noi_T','N_minzd_T','N_nat_g.m2')
#dfT3<-dfT2[,!colnames(dfT2) %in% removeThese] #remove columns with data from the 5-15cm soil depth


#look at dataset
colnames(dfT)
curr.nonValcols<-c('plotYear','year','plotid')
dfT4<-dfT[,c('year','mv_g.m2_logt','PC1','PC2','N_ammonifd_T','I_ammonifd_T')]
pairs(dfT4[,!colnames(dfT4) %in% curr.nonValcols])
str(dfT4)
dfT4$year<-factor(dfT4$year)
str(dfT4)
dfT4.rm<-dfT4[!rowSums(is.na(dfT4))>0,] #remove rows with NAs

#set up models
modlist <- list(
  lmer(mv_g.m2_logt ~ PC1 + PC2 + (1|year), data=dfT4.rm),
  lmer(I_ammonifd_T ~ N_ammonifd_T + mv_g.m2_logt + PC1 + PC2 + (1|year), data=dfT4.rm)
)

#can't test the fit ?????
sem.mod.fit<-sem.fit(modlist, data=dfT4.rm) 
sem.mod.fit

#non-standardized path coefs
coefs<-sem.coefs(modelList=modlist, data=dfT4.rm, standardize="none")
coefs

#standardized path coefs
coefs<-StdCoefs.manual(sem.coef.obj=coefs, data=dfT4.rm)
coefs

#R2 values
sem.model.fits(modlist)



```

_________________________________________________________________
# Trends over time
a. Does Microstegium biomass increase over time?
b. Do soil N pools and fluxes in reference (and invaded) plots shift over time?
c. Do impact magnitudes shift over time?
d. Does the influence of reference conditions on Microstegium biomass shift over time?

_________________________________________________________________
# Invasion front study design
a. What environmental factors besides soil N pools and fluxes differ among paired invaded and reference plots?
```{r extra, echo=FALSE, message=FALSE, warning=FALSE}

##############
#A. Do an ordination of all environmental variables by plot - this is already in 'script_visualize.R'
##############


##############
#B. Investigate individual relationships using mixed effects models with year+site as a random effect.
##############

#0) set up dataframe
plotVars
data.plotVars<-data.choice[data.choice$variable %in% plotVars, c('plotid','plothalfid1','inv','year','variable','value')]
data.plotVars$variable<-factor(data.plotVars$variable, levels=plotVars)
data.plotVars.wide<-dcast(data.plotVars, plothalfid1 + plotid + inv + year ~ variable, value.var='value')
data.plotVars.wide$plotInvYear<-paste(data.plotVars.wide$plothalfid1, 
                                      data.plotVars.wide$year, sep="_") #use this to identify rows
data.plotVars.wide$plotYear<-paste(as.character(data.plotVars.wide$plotid), 
                                   data.plotVars.wide$year, sep="_") #use this to block by plotid*year

#1) Run models
result<-InvEffect(Yvars=plotVars, YvarNames=plotVarNames, df=data.plotVars.wide)

#2) Calculate means and save
data.plotVars.long<-melt(data.plotVars.wide, measure.vars=plotVars, id.vars = c('inv','year','plotid'))
meanSummary<-ddply(data.plotVars.long, ~variable+inv, summarize,
                   mean=mean(value, na.rm=TRUE),
                   n=sum(!is.na(value)),
                   se=sd(value, na.rm=TRUE)/sqrt(n))
meanSummary[,c('mean','se')]<-round(meanSummary[,c('mean','se')], digits=2)
colnames(meanSummary)[colnames(meanSummary) == 'variable']<-'vars'
meanSummary
newfilename<-'meanSummary_plotVars.txt'
write.table(meanSummary, file=paste(figuresPath,newfilename, sep='/'), sep='\t')

#3) Save coefficient and anova summary tables
newfilename<-'summarySummary_plotVars.txt'
write.table(data.frame(result[['summarySummary']]), file=paste(figuresPath,newfilename, sep='/'), sep='\t')
#data.frame(result[['posthocSummary']])
newfilename<-'posthocSummary_plotVars.txt'
write.table(data.frame(result[['posthocSummary']]), file=paste(figuresPath,newfilename, sep='/'), sep='\t')

#4) Plot
#i) prep dataframe and params
meanSummary.pretty<-merge(meanSummary,plotVars.indx)
meanSummary.pretty<-orderBy(~basic.vars.order+var.depth, meanSummary.pretty)
meanSummary.pretty$basic.varNames.units<-factor(meanSummary.pretty$basic.varNames.units, levels = unique(meanSummary.pretty$basic.varNames.units))
meanSummary.pretty$depth<-factor(meanSummary.pretty$depth, levels=c('T','B','NA'))
limits <- aes(ymax = mean + se, ymin=mean - se)
meanSummary.pretty$name<-meanSummary.pretty$basic.varNames.units
meanSummary.pretty$name2 <- factor(meanSummary.pretty$name,
                                   levels=c(levels(meanSummary.pretty$name)[1:2],'',
                                            levels(meanSummary.pretty$name)[3:11]))

p<-ggplot(meanSummary.pretty, aes(x=inv, y=mean, linetype=depth, group=depth)) +
  geom_point(size=3) + ylab(NULL) + xlab('Plot type') +
  geom_errorbar(limits, width=0.2) + geom_line() + 
  facet_wrap(~name2, scales='free_y', ncol=3, drop=FALSE) + mytheme +
  scale_linetype_discrete(name='Soil depth',labels=c('0-5cm','5-15cm')) +
  scale_x_discrete(labels=c('Invaded','Reference'))
p

g <- ggplotGrob(p )
## remove empty panels
g$grobs[names(g$grobs) %in% c("panel3","strip_t3","axis_l3")] <- NULL
## remove them from the layout
g$layout <- g$layout[!(g$layout$name %in% c("panel-3","strip_t-3","axis_l-3")),]

## plot
grid.newpage()
grid.draw(g)
newfilename<-'pScat_plotVars.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*3.5, height = fig.height*4, res=fig.res)
grid.newpage()
grid.draw(g)
dev.off()
```

_________________________________________________________________
# %AM
a. Does Microstegium biomass vary with %AM?
b. Does %AM vary with multivariate soil N conditions in reference plots?









