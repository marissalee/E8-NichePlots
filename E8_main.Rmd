---
title: 'E8 main document'
author: "Marissa Lee"
date: "October 23, 2015"
output: pdf_document
---

**Filename: E8_main.Rmd'**

_________________________________________________________________
# 0. Import, clean, merge, load fxns
```{r libraries, echo=FALSE}
knitr::opts_chunk$set(cache=TRUE)

#LIBRARIES
library(plyr)
library(reshape2)
library(ggplot2) #plotting
library(ggthemes) #ggplot accessories
library(GGally) #????
library(gtable)
library(gridExtra) #for grid.arrange fxn
library(lme4) #for mixed-effects models
library(lmerTest) #for lmer p-values
library(ggbiplot) #for pretty biplots
library(vegan) #for adonis fxn to do perMANOVAs
library(lavaan) #for structural equation modeling
library(doBy) #the orderBy fxn
library(merTools)

#CUSTOM FUNCTIONS
source('CODE/fxn_reshapeHelpers.R')
source('CODE/fxn_PCAhelpers.R')
source('CODE/fxn_NMDShelpers.R')
source('CODE/fxn_InvEffect.R') #calculate invasion effect in a mixed effects model
source('CODE/fxn_predictHelpers.R') #creates dataframes to feed into model predictions

#THEME
source('CODE/mytheme.R')

#IMPORT, CLEAN, MERGE
source('CODE/script_cleanMerge.R')
#saves plot 'pHist_depth.png'
#saves data 'data_a.txt' # aggregated mean(depth) for 2012 and 2013
#saves data 'data_d.txt' # removed variables that were only measured in 2011 (i.e. full soil depth 0-15cm measurements)

#decide what dataset to use
data.choice<-data_d 
```

_________________________________________________________________
# 0. Visualize data
```{r visualize, echo=FALSE}
### soil N pools and fluxes in invaded and reference plots ###
nVars
#0) subset and reshape
variables<-nVars #for QuickReshape1()
variableNames<-nVarNames #for QuickReshape1()
reshapeResult<-QuickReshape1(variables, variableNames)
df.ord<-reshapeResult[['df.ord']]
data.vars.wide.rm<-reshapeResult[['data.vars.wide.rm']]
NonValCols<-reshapeResult[['NonValCols']]

#PCA
df.ord.scaled<-scale(df.ord)
PCA.res<-prcomp(df.ord.scaled)
data.PCA<-data.frame(plotInvYear=rownames(PCA.res$x), PCA.res$x)
data.vars.PCA<-data.PCA[,c(1:3)]
data.vars.PCA<-merge(data.vars.PCA, data.vars.wide.rm)
screeplot(PCA.res, type='lines')


library("bpca")


plots<-ggbiplot_q1(pcobj=PCA.res, df=data.vars.PCA)
plots[['pEllipseIN1']]
newfilename<-'PCA_plotNvars.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*3, height = fig.height*3, res=fig.res)
plots[['pEllipseIN1']] + xlim(c(-2.3,4))
dev.off()
#variable contributions to PC1 and PC2
PCvar<-PCA.var.contrib_q1(pca.obj=PCA.res)
PCvar
newfilename<-'PCvar_plotNvars.txt'
write.table(PCvar, file=paste(figuresPath,newfilename, sep='/'), sep='\t')

#NMDS
df.ord.pos <- apply(df.ord, 2, minShift)
mod_NMDS<-metaMDS(df.ord.pos, distance='euclidean',
                  autotransform=FALSE, noshare=FALSE, wascores = TRUE,
                  k=2) # The number of reduced dimensions
#NMDS.scree(df.ord.pos,distance='euclidean') #this takes forever
nmdsResult<-NMDSplots(nmds=mod_NMDS, data.vars.wide.rm=data.vars.wide.rm, NonValCols=NonValCols)
grid.arrange(nmdsResult[['p']], nmdsResult[['p.vecs']])
newfilename<-'NMDS_plotNvars.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*3.5, height = fig.height*3.5, res=fig.res)
grid.arrange(nmdsResult[['p']] + xlim(-8,8) + ylim(-4,4) + coord_equal(), 
             nmdsResult[['p.vecs']] + xlim(-8,8) + ylim(-4,4) + coord_equal())
dev.off()

#everything measured in invaded and reference plots
plotVars
#0) subset and reshape
variables<-plotVars #for QuickReshape1()
variableNames<-plotVarNames #for QuickReshape1()
reshapeResult<-QuickReshape1(variables, variableNames)
df.ord<-reshapeResult[['df.ord']]
data.vars.wide.rm<-reshapeResult[['data.vars.wide.rm']]
NonValCols<-reshapeResult[['NonValCols']]

#PCA
df.ord.scaled<-scale(df.ord)
PCA.res<-prcomp(df.ord.scaled)
data.PCA<-data.frame(plotInvYear=rownames(PCA.res$x), PCA.res$x)
data.vars.PCA<-data.PCA[,c(1:3)]
data.vars.PCA<-merge(data.vars.PCA, data.vars.wide.rm)
plots<-ggbiplot_q1(pcobj=PCA.res, df=data.vars.PCA)
plots[['pEllipseIN1']]
newfilename<-'PCA_plotallVars.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', 
    width = fig.width*2.5, height = fig.height*2, res=fig.res)
plots[['pEllipseIN1']] 
dev.off()
#variable contributions to PC1 and PC2
PCvar<-PCA.var.contrib_q1(pca.obj=PCA.res)
PCvar
newfilename<-'PCvar_plotallVars.txt'
write.table(PCvar, file=paste(figuresPath,newfilename, sep='/'), sep='\t')

#NMDS
df.ord.pos <- apply(df.ord, 2, minShift)
mod_NMDS<-metaMDS(df.ord.pos, distance='euclidean',
                  autotransform=FALSE, noshare=FALSE, wascores = TRUE,
                  k=2) # The number of reduced dimensions
nmdsResult<-NMDSplots(nmds=mod_NMDS, data.vars.wide.rm=data.vars.wide.rm,
                      NonValCols=NonValCols)
nmdsResult[['p']]
grid.arrange(nmdsResult[['p']] + xlim(-2000,1500) + ylim(-300, 100),
             nmdsResult[['p.vecs']] + xlim(-2000,1500) + ylim(-300, 100))

newfilename<-'NMDS_plotallVars.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*3, height = fig.height*3, res=fig.res)
grid.arrange(nmdsResult[['p']], nmdsResult[['p.vecs']])
dev.off()

#everything measured in reference plots only
allVars
#0) subset and reshape
variables<-allVars #for QuickReshape1()
variableNames<-allVarNames #for QuickReshape1()
reshapeResult<-QuickReshape1(variables, variableNames,refOnly='y')


df.ord<-reshapeResult[['df.ord']]
data.vars.wide.rm<-reshapeResult[['data.vars.wide.rm']]
NonValCols<-reshapeResult[['NonValCols']]

#PCA
df.ord.scaled<-scale(df.ord)
PCA.res<-prcomp(df.ord.scaled)
data.PCA<-data.frame(plotInvYear=rownames(PCA.res$x), PCA.res$x)
data.vars.PCA<-data.PCA[,c(1:3)]
data.vars.PCA<-merge(data.vars.PCA, data.vars.wide.rm)
plots<-ggbiplot_q3(pcobj=PCA.res, df=data.vars.PCA)
plots[['pBasic']]
newfilename<-'PCA_plotrefVars.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', 
    width = fig.width*2.5, height = fig.height*2, res=fig.res)
plots[['pBasic']]
dev.off()
#variable contributions to PC1 and PC2
PCvar<-PCA.var.contrib_q1(pca.obj=PCA.res)
PCvar
newfilename<-'PCvar_plotrefVars.txt'
write.table(PCvar, file=paste(figuresPath,newfilename, sep='/'), sep='\t')

#NMDS
df.ord.pos <- apply(df.ord, 2, minShift)
nmds<-metaMDS(df.ord.pos, distance='euclidean',
                  autotransform=FALSE, noshare=FALSE, wascores = TRUE,
                  k=2) # The number of reduced dimensions
#extract scores
variableScores <- data.frame(id=rownames(nmds$species), nmds$species)
variableScores$angle <- with(variableScores, (180/pi) * atan(MDS2 / MDS1))
variableScores$hjust <- with(variableScores, (1 - 1.1 * sign(MDS1)) / 2)
sampleScores <- data.frame(id=row.names(nmds$points), data.vars.wide.rm[,NonValCols], nmds$points)
p<-ggplot(sampleScores, aes(x=MDS1, y=MDS2)) + 
    geom_point(color='darkgray') + 
    geom_segment(mapping=aes(x=0, y=0, xend=MDS1, yend=MDS2), 
                 data=variableScores, arrow = arrow(length = unit(0.5, "cm")), color=1) +
    geom_text(mapping=aes(x=MDS1, y=MDS2, label=id, angle = angle, hjust = hjust), 
              data=variableScores, color=1, size=3) +
    mytheme
p
newfilename<-'NMDS_refVars.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*3, height = fig.height*3, res=fig.res)
p
dev.off()

```

_________________________________________________________________
# 1. Q1: Do soil N pools and fluxes shift in response to the presence of Microstegium? 
A. Do an ordination of soil N pools and fluxes and test the role of invasion status with permMANOVA
B. Investigate individual relationships using mixed effects models with year+site as a random effect and identify N variables that increase/decrease across sites.
```{r q1, echo=FALSE, message=FALSE, warning=FALSE}
vars #variables in the ordination
source('CODE/script_q1.R')

#A. Ordination
#saves plot 'pPCA_q1.png' #ordination of soil N pools and fluxes by plot
#saves plot 'pPCA_q1_nmds.png' #ordination of soil N pools and fluxes by plot
#saves table 'PCvar_q1.txt' #loadings of soil N pools and fluxes onto ordination PCs
#saves table 'permMANOVA_q1.txt' #result of permMANOVA of the ordination given plot invasion status

#B. Mixed effects models (soil N pool or flux value ~ inv + (1|siteYear))
#saves table 'meanSummary_q1.txt' #summary of individual soil N pools and fluxes by year and invasion status
#saves table 'summarySummary_q1.txt' #summary of individual mixed effect models for each soil N pool or flux
#saves table 'posthocSummary_q1.txt' #post-hoc comparisons among years and invasion status
#saves plot 'pScat_q1.png' #panels of soil N pool or flux ~ inv
```

_________________________________________________________________
# 2. Q2: Do reference plot conditions and/or Microstegium biomass predict impact magnitudes?
A. Calculate impact magnitude for each target variable (nitrate, nitrification, other variables detected in Q1 ordination)
B. Test the role of reference plot conditions and Microstegium biomass on impacts individually using mixed effects models with year as a random effect
```{r q2, echo=FALSE, message=FALSE, warning=FALSE}
##A. Calculate impact, prep dataset

#1. decide of difference variables
diffVars<-c('noi_T','noi_B','ammonifd_T','ammonifd_B','nitrifd_T','nitrifd_B','minzd_T','minzd_B')

#2. decide on what variables to include in the reference ordination
#refVars
#refVars2 #without PercBA_AM
#refVars.AggPAR
#refVars2.AggPAR #without PercBA_AM
useThese_refVars<-refVars

#3. decide whether to include PercBA_AM as a separate parameter
#externalPercBA_AM<-'y'
externalPercBA_AM<-'n'

#4. prep dataset
source('CODE/script_q2_prep.R')
#View(data.q2)


##B. Run models for each of the following (Inv. - Ref): nitrate, nitrif, ammonif, minz 

#1. decide on model formulation
modelFormulaCode<-'PC1*PC2*Mv'
#modelFormulaCode<-'PC1+PC2+Mv'
#modelFormulaCode<-'PC1*PC2*AM*Mv'
#modelFormulaCode<-'PC1+PC2+AM+Mv'


#2. run models
source('CODE/script_q2.R')
PC1var.c.o
PC2var.c.o
mod.df[mod.df$pval<0.05,]

#3. make plots

####################################
#a. delta nitrate (inv-ref)
####################################
df.mod<-mod.noi[['df.mod.used']]
modT<-mod.noi[['modT']]

#set up PC2 levels
df.mod$factorLevel<-NA
lowLabel<-'Low light, many trees (PC2)'
highLabel<-'High light, few trees (PC2)'
df.mod[df.mod$PC2 >= quantile(df.mod$PC2)[1] & df.mod$PC2 < quantile(df.mod$PC2)[3],'factorLevel']<-lowLabel
df.mod[df.mod$PC2 >= quantile(df.mod$PC2)[3] & df.mod$PC2 <= quantile(df.mod$PC2)[5],'factorLevel']<-highLabel
df.mod$factorLevel<-factor(df.mod$factorLevel, levels=c(lowLabel, highLabel))

#plot: diff noi_T ~ Mvbiomass by PC2 levels
#prediction data frames ...
df.pred<-InteractionPlot_DF(n=100, xVar='mv_g.m2_logt', 
                            factorVar='PC2', factorBin='factorLevel', 
                            constantVar='PC1', 
                            df=df.mod, mod=modT)

#remove the year intercept
mod.coefs<-coef(modT)$year
int2012<-mod.coefs[1,1]
int2013<-mod.coefs[2,1]
int.Diff<-int2012 - int2013
df.mod$select.diffVarT.minusYr<-df.mod$select.diffVarT
df.mod[df.mod$year==2012,'select.diffVarT.minusYr']<-df.mod[df.mod$year==2012,'select.diffVarT'] - int.Diff

#plot
pScat.noiDiff_MvPC2<-ggplot(data=df.pred, 
                            mapping=aes(x=mv_g.m2_logt, 
                                        y=ypred.minusYr, 
                                        ymin=CI.lwr.minusYr, ymax=CI.upr.minusYr))  +  
  geom_ribbon(alpha=0.4) +
  geom_line() +
  facet_grid(~factorLevel) +
  geom_abline(intercept=0,slope=0, linetype=3, color='gray50') + 
  mytheme + ylab(expression(paste(Delta," Nitrate 0-5cm (Inv.-Ref.)"))) + xlab('Microstegium biomass (log g/m2)') + 
  geom_point(data=df.mod, aes(y=select.diffVarT.minusYr, ymin=NULL, ymax=NULL)) 
pScat.noiDiff_MvPC2
#save plots
newfilename<-"pScat_noiDiff.png"
png(paste(figuresPath,newfilename, sep='/'), units='in', 
    width = fig.width*2, height = fig.height*1.2, res=fig.res)
pScat.noiDiff_MvPC2 + guides(linetype=FALSE, fill=FALSE)
dev.off()


####################################
#b. delta ammonification (inv-ref)
####################################
df.mod<-mod.ammonifd[['df.mod.used']]
modT<-mod.ammonifd[['modT']]

#set up PC1 levels
df.mod$factorLevel<-NA
lowLabel<-'Low moisture & OM (PC1)'
highLabel<-'High moisture & OM (PC1)'
df.mod[df.mod$PC1 >= quantile(df.mod$PC1)[1] & df.mod$PC1 < quantile(df.mod$PC1)[3],'factorLevel']<-lowLabel
df.mod[df.mod$PC1 >= quantile(df.mod$PC1)[3] & df.mod$PC1 <= quantile(df.mod$PC1)[5],'factorLevel']<-highLabel
df.mod$factorLevel<-factor(df.mod$factorLevel, levels=c(lowLabel, highLabel))

#set up PC2 levels
df.mod$factorLevel2<-NA
lowLabel<-'Low light, more trees (PC2)'
highLabel<-'High light, few trees (PC2)'
df.mod[df.mod$PC2 >= quantile(df.mod$PC2)[1] & df.mod$PC2 < quantile(df.mod$PC2)[3],'factorLevel2']<-lowLabel
df.mod[df.mod$PC2 >= quantile(df.mod$PC2)[3] & df.mod$PC2 <= quantile(df.mod$PC2)[5],'factorLevel2']<-highLabel
df.mod$factorLevel2<-factor(df.mod$factorLevel2, levels=c(lowLabel, highLabel))

#plot: diff ammonif_T ~ Mvbiomass by PC1 levels
#prediction data frames ...
df.pred1<-InteractionPlot_DF(n=100, xVar='mv_g.m2_logt', 
                            factorVar='PC1', factorBin='factorLevel', 
                            constantVar='PC2', 
                            df=df.mod, mod=modT)

#remove the year intercept
mod.coefs<-coef(modT)$year
int2012<-mod.coefs[1,1]
int2013<-mod.coefs[2,1]
int.Diff<-int2012 - int2013
df.mod$select.diffVarT.minusYr<-df.mod$select.diffVarT
df.mod[df.mod$year==2012,'select.diffVarT.minusYr']<-df.mod[df.mod$year==2012,'select.diffVarT'] - int.Diff

#plot
pScat.ammonifdDiff_MvPC1<-ggplot(data=df.pred1, 
                                 mapping=aes(x=mv_g.m2_logt, 
                                             y=ypred.minusYr, 
                                             ymin=CI.lwr.minusYr, ymax=CI.upr.minusYr))  +  
  geom_ribbon(alpha=0.4) +
  geom_line() +
  facet_grid(~factorLevel) +
  geom_abline(intercept=0,slope=0, linetype=3, color='gray50') + 
  mytheme + ylab(expression(paste(Delta," Ammonif. 0-5cm (Inv.-Ref.)"))) + 
  xlab('Microstegium biomass (log g/m2)') + 
  geom_point(data=df.mod, aes(y=select.diffVarT.minusYr, ymin=NULL, ymax=NULL))
pScat.ammonifdDiff_MvPC1

#plot: diff ammonifd_T ~ PC2 by PC1 levels
#prediction data frames ...
df.pred2<-InteractionPlot_DF(n=100, xVar='PC2', 
                            factorVar='PC1', factorBin='factorLevel', 
                            constantVar='mv_g.m2_logt', 
                            df=df.mod, mod=modT)
pScat.ammonifdDiff_PC2PC1<-ggplot(data=df.pred2, 
                                  mapping=aes(x=PC2, 
                                              y=ypred.minusYr, 
                                              ymin=CI.lwr.minusYr, ymax=CI.upr.minusYr))  +  
  geom_ribbon(alpha=0.4) +
  geom_line() +
  facet_grid(~factorLevel) +
  geom_abline(intercept=0,slope=0, linetype=3, color='gray50') + 
  mytheme + ylab(expression(paste(Delta," Ammonif. 0-5cm (Inv.-Ref.)"))) + 
  xlab('PC2 (increasing light, decreasing trees)') + 
  geom_point(data=df.mod, aes(y=select.diffVarT.minusYr, ymin=NULL, ymax=NULL))
pScat.ammonifdDiff_PC2PC1

#save plots
newfilename<-'pScat.ammonifdDiff.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*2, height = fig.height*2.2, res=fig.res)
grid.arrange(pScat.ammonifdDiff_MvPC1 + guides(linetype=FALSE, fill=FALSE),
             pScat.ammonifdDiff_PC2PC1+ guides(linetype=FALSE, fill=FALSE))
dev.off()


```

_________________________________________________________________
# 3. Q3: Do reference plot conditions predict Microstegium biomass?
A. Do an ordination of reference conditions and test the relationship between Microstegium biomass and reference conditions using permMANOVA.
B. Investigate relationship between PC scores and Microstegium biomass using mixed effects models with year as a random effect.
```{r q3, echo=FALSE, message=FALSE, warning=FALSE}
#A. Do an ordination of reference conditions and test the relationship between Microstegium biomass and reference conditions using permMANOVA.

#i) Identify reference plot condition variables
useThese_refVars<-refVars
data.refVars<-data.choice[data.choice$variable %in% useThese_refVars, c('plotid','plothalfid1','inv','year','variable','value')]
data.refVars$variable<-factor(data.refVars$variable, levels=useThese_refVars)
data.refVars<-subset(data.refVars, inv == 'N')
data.refVars.wide<-dcast(data.refVars, plotid + year ~ variable, value.var='value')
data.refVars.wide$plotYear<-paste(data.refVars.wide$plotid, data.refVars.wide$year, sep="_")
data.q3<-data.refVars.wide

#2) Ordinate reference conditions
data.q3.rm<-data.q3[!rowSums(is.na(data.q3))>0,]
tmp<-data.q3.rm[,useThese_refVars]
colnames(tmp)<-useThese_refVars
#cor(tmp) #look at correlation matrix

#PCA
row.names(tmp)<-data.q3.rm$plotYear
tmp.scaled<-scale(tmp)
PCA.res<-prcomp(tmp.scaled)
pPCA_q3<-ggbiplot_q3(pcobj=PCA.res, df=data.q3.rm)
pPCA_q3[['pBasic']]
#save plot
newfilename<-'pPCA_q3.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*2.5, height = fig.height*2, res=fig.res)
pPCA_q3[['pBasic']]
dev.off()
#variable contributions to PC1 and PC2
PCvar<-PCA.var.contrib_q1(pca.obj=PCA.res)
PCvar
newfilename<-'PCvar_q3.txt'
write.table(PCvar, file=paste(figuresPath,newfilename, sep='/'), sep='\t')
#make dataframe
df.PCA<-data.frame(plotYear=row.names(PCA.res$x), PCA.res$x)
data.q3.PCA<-merge(data.q3.rm, df.PCA[,c(1:3)])

#NMDS
#make all the values positive for NMDS
minShift <- function(x) {x + abs(min(x))}
df.ord.pos <- apply(tmp, 2, minShift)
mod_NMDS<-metaMDS(df.ord.pos, 
                  distance='euclidean',
                  autotransform=FALSE, noshare=FALSE, wascores = TRUE,
                  k=2) # The number of reduced dimensions
variableScores <- data.frame(id=rownames(mod_NMDS$species), mod_NMDS$species)
variableScores$angle <- with(variableScores, (180/pi) * atan(MDS2 / MDS1))
variableScores$hjust <- with(variableScores, (1 - 1.1 * sign(MDS1)) / 2)
sampleScores <- data.frame(id=row.names(mod_NMDS$points),
                           mod_NMDS$points)
p<-ggplot(sampleScores, aes(x=MDS1, y=MDS2)) + geom_point(color='darkgray', shape=1) +
  geom_segment(mapping=aes(x=0, y=0, xend=MDS1, yend=MDS2), data=variableScores, arrow = arrow(length = unit(0.5, "cm")), color=1) +
  geom_text(mapping=aes(x=MDS1, y=MDS2, label=id, angle = angle, hjust = hjust), data=variableScores, color=1, size=3) +
  mytheme + coord_equal() + ylim(-500,500)
newfilename<-'pPCA_q3_nmds.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*3, height = fig.height, res=fig.res)
p
dev.off()

#3) Do reference area and plot characteristics explain variation in Mv biomass? - perMANOVA on mv biomass
perMANOVA<-adonis(tmp.scaled ~ mv_g.m2_logt, data = data.q3.PCA, method='eu')
aov.tab.permanova<-data.frame(perMANOVA$aov.tab)
aov.tab.permanova
#save anova table
newfilename<-'permMANOVA_q3.txt'
write.table(aov.tab.permanova, file=paste(figuresPath,newfilename, sep='/'), sep='\t')


#B. Do PC scores from the reference condition ordination predict mv biomass?
#1) Fit model
data.q3.PCA$year<-factor(data.q3.PCA$year)
df.mod<-data.q3.PCA
df.mod$PC2_neg1<-df.mod$PC2*-1

#If PercBA_AM should be included separately from reference conditions...Identify PercBA_AM and merge it into dataset
#externalPercBA_AM
if(externalPercBA_AM == 'y'){
  
  #merge
  df.mod<-merge(df.mod, data.AM.wide)

  #make a bin for %AM
  df.mod$MycBin<-NA
  df.mod[df.mod$PercBA_AM >=0 & df.mod$PercBA_AM <50,'MycBin']<-'AM'
  df.mod[df.mod$PercBA_AM >=50 & df.mod$PercBA_AM <=100,'MycBin']<-'ECM'
  
  mod<-lmer(mv_g.m2_logt~PC1*PC2*MycBin + (1|year), data=df.mod)
}else{
  mod<-lmer(mv_g.m2_logt~PC1*PC2_neg1 + (1|year), data=df.mod)
}
summary(mod)$coefficients
#save anova table
newfilename<-'summaryTable_q3.txt'
write.table(summary(mod)$coefficients, file=paste(figuresPath,newfilename, sep='/'), sep='\t')

#2) Plot
#set up prediction dataframes
df.pred<-XYPlot_DF(n=100, xVar='PC2_neg1', constantVar='PC1', df=df.mod, mod=mod)

#remove the year intercept
mod.coefs<-coef(mod)$year
int2012<-mod.coefs[1,1]
int2013<-mod.coefs[2,1]
int.Diff<-int2012 - int2013
df.mod$mv_g.m2_logt.minusYr<-df.mod$mv_g.m2_logt
df.mod[df.mod$year==2012,'mv_g.m2_logt.minusYr']<-df.mod[df.mod$year==2012,'mv_g.m2_logt'] - int.Diff

#plot
pScat.Mv_PC2<-ggplot(data=df.pred, 
                     mapping=aes(x=PC2_neg1, 
                                 y=ypred.minusYr, 
                                 ymin=CI.lwr.minusYr, ymax=CI.upr.minusYr))  +  
  geom_ribbon(alpha=0.4) +
  geom_line() +
  mytheme + ylab('Microstegium biomass (log g/m2)') + xlab('PC2*-1\n(increasing light, decreasing trees)') + 
  geom_point(data=df.mod, aes(y=mv_g.m2_logt.minusYr, ymin=NULL, ymax=NULL))
pScat.Mv_PC2

#save plot
newfilename<-'pScat_q3.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', 
    width = fig.width*1, height = fig.height*1.05, res=fig.res)
pScat.Mv_PC2
dev.off()

```

_________________________________________________________________
# 4. Q4: What is the relative importance of reference conditions on impact - direct and indirectly
A. Nitrate model
```{r q4, echo=FALSE, message=FALSE, warning=FALSE}
# data.q4<-data.q2
# 
# #Identify the nitrate dataframe
# df<-data.q4
# diffVarShort<-'noi_T'
# 
# PathAnalysis<-function(df, diffVarShort){
#   
#   #select the impact variable
#   select.diffVar<-paste('Diff',diffVarShort, sep='_')
#   
#   #make reference ordination
#   refVars<-refVars[refVars != 'percpar']
#   select.refVars<-refVars[!refVars %in% diffVarShort]
#   df.ref<-data.frame(df[,select.refVars], year=df$year)
#   rownames(df.ref)<-df$plotYear
#   df.ref.rm<-df.ref[!rowSums(is.na(df.ref)),]
#   tmp<-df.ref.rm[,!(colnames(df.ref.rm) == 'year')]
#   tmp.scaled<-scale(tmp)
#   PCA.ref<-prcomp(tmp.scaled) #same as in q2
#   
#   #set up dataframe for path analysis
#   df.PCA.ref<-data.frame(plotYear=rownames(PCA.ref$x), PCA.ref$x)
#   df.sub<-data.frame(plotYear=df$plotYear, year=df$year, 
#                    select.diffVar=df[,select.diffVar], mv_g.m2_logt=df$mv_g.m2_logt)
#   df.mod<-merge(df.sub, df.PCA.ref[,c(1:3)])
#   
#   #path analysis
#   myModel <- '# direct effects
#               select.diffVar ~ c1*PC1 + c2*PC2
# 
#               #mediator
#               mv_g.m2_logt ~ a1*PC1 + a2*PC2
#               select.diffVar ~ b*mv_g.m2_logt
# 
#               #indirect effects via PC1
#               a1b := a1*b
# 
#               #indirect effects via PC2
#               a2b := a2*b
# 
#               #indirect effects 
#               a1a2b := a1*b + a2*b
# 
#               #total effects
#               c1c2a1a2b := c1 + c2 + a1*b + a2*b
#              '
# 
#   fit <- sem(myModel, data=df.mod)
#   result<-summary(fit)
#   
#   return(result)
# }
# 
# PathAnalysis(df=data.q4, diffVarShort = 'noi_T')
# PathAnalysis(df=data.q4, diffVarShort = 'nitrifd_T')
# PathAnalysis(df=data.q4, diffVarShort = 'ammonifd_T')
# PathAnalysis(df=data.q4, diffVarShort = 'minzd_T')

```

_________________________________________________________________
# Trends over time
a. Does Microstegium biomass increase over time?
b. Do soil N pools and fluxes in reference (and invaded) plots shift over time?
c. Do impact magnitudes shift over time?
d. Does the influence of reference conditions on Microstegium biomass shift over time?

_________________________________________________________________
# Invasion front study design
a. What environmental factors besides soil N pools and fluxes differ among paired invaded and reference plots?
```{r extra, echo=FALSE, message=FALSE, warning=FALSE}

##############
#A. Do an ordination of all environmental variable by plot
##############

#1) Subset and reshape]
plotVars
data.plotVars<-data.choice[data.choice$variable %in% plotVars, c('plotid','plothalfid1','inv','year','variable','value')]
data.plotVars$variable<-factor(data.plotVars$variable, levels=plotVars)
data.plotVars.wide<-dcast(data.plotVars, plothalfid1 + plotid + inv + year ~ variable, value.var='value')
data.plotVars.wide$plotInvYear<-paste(data.plotVars.wide$plothalfid1, 
                                      data.plotVars.wide$year, sep="_") #use this to identify rows
data.plotVars.wide$plotYear<-paste(as.character(data.plotVars.wide$plotid), 
                                   data.plotVars.wide$year, sep="_") #use this to block by plotid*year

row.names(data.plotVars.wide)<-data.plotVars.wide$plotInvYear
NonValCols<-c('plothalfid1','plotid','plotInvYear', 'plotYear','inv','year')
ValCols<-colnames(data.plotVars.wide)[!(colnames(data.plotVars.wide) %in% NonValCols)]
data.plotVars.wide.rm<-data.plotVars.wide[!rowSums(is.na(data.plotVars.wide))>0,] #remove rows with missing data
#cor(data.plotVars.wide.rm[,ValCols]) #look at correlation matrix

#2) Ordinate and save plot
df.ord<-data.plotVars.wide.rm[,ValCols]
colnames(df.ord)<-plotVarNames

#PCA
df.ord.scaled<-scale(df.ord)
PCA.res<-prcomp(df.ord.scaled)
data.PCA<-data.frame(plotInvYear=rownames(PCA.res$x), PCA.res$x)
data.vars.PCA<-merge(data.plotVars.wide.rm, data.PCA[,c(1:3)]) #add Mv biomass to this dataframe
data.vars.PCA$plotid<-ldply(strsplit(data.vars.PCA$plothalfid1, "_", fixed=TRUE))$V2
data.vars.PCA$year<-factor(data.vars.PCA$year)
plots<-ggbiplot_q1(pcobj=PCA.res, df=data.vars.PCA)
plots[['pEllipseIN1']]
newfilename<-'pPCA_allvars.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*2.5, height = fig.height*2, res=fig.res)
plots[['pEllipseIN1']]
dev.off()

#NMDS
#make all the values positive for NMDS
minShift <- function(x) {x + abs(min(x))}
df.ord.pos <- apply(df.ord, 2, minShift)
mod_NMDS<-metaMDS(df.ord.pos, 
                  distance='euclidean',
                  autotransform=FALSE, noshare=FALSE, wascores = TRUE,
                  k=2, trymax =50) # The number of reduced dimensions
mod_NMDS
stressplot(mod_NMDS)
goodness(mod_NMDS)

plot (mod_NMDS, display = 'sites', type = 't', main = 'Goodness of fit') # this function draws NMDS ordination diagram with sites
points (mod_NMDS, display = 'sites', cex = goodness (mod_NMDS)*200) # and this adds the points with size reflecting goodness of fit (bigger = worse fit)


variableScores <- data.frame(id=rownames(mod_NMDS$species), mod_NMDS$species)
variableScores$angle <- with(variableScores, (180/pi) * atan(MDS2 / MDS1))
variableScores$hjust <- with(variableScores, (1 - 1.1 * sign(MDS1)) / 2)
sampleScores <- data.frame(id=row.names(mod_NMDS$points),
                           data.plotVars.wide.rm[,NonValCols],
                           mod_NMDS$points)

sampleScores.m<-melt(sampleScores, measure.vars=c('MDS1','MDS2'))
sampleScores.c<-dcast(sampleScores.m, plotYear~inv+variable)
sampleScores.c
ord<-ordiellipse(mod_NMDS, sampleScores$inv, display = "sites", 
                 kind = "se", conf = 0.95, label = T)
veganCovEllipse<-function (cov, center = c(0, 0), scale = 1, npoints = 100) 
{
  theta <- (0:npoints) * 2 * pi/npoints
  Circle <- cbind(cos(theta), sin(theta))
  t(center + scale * t(Circle %*% chol(cov)))
}
df_ell <- data.frame()
for(g in unique(sampleScores$inv)){
  df_ell <- rbind(df_ell, 
                  cbind(as.data.frame(with(sampleScores[sampleScores$inv==g,],
                                           veganCovEllipse(ord[[g]]$cov,ord[[g]]$center,ord[[g]]$scale)))
                        ,inv=g))
}
NMDS.mean<-aggregate(sampleScores[,c('MDS1', 'MDS2')],list(inv=sampleScores$inv),mean)

p<-ggplot(sampleScores, aes(x=MDS1, y=MDS2)) + 
  geom_point(aes(shape=inv), color='darkgray') + 
  geom_path(data=df_ell, aes(x=NMDS1, y=NMDS2, linetype=inv), size=0.5, color='blue') +
  geom_segment(mapping=aes(x=0, y=0, xend=MDS1, yend=MDS2), 
               data=variableScores, arrow = arrow(length = unit(0.5, "cm")), color=1) +
  geom_text(mapping=aes(x=MDS1, y=MDS2, label=id, angle = angle, hjust = hjust), 
            data=variableScores, color=1, size=3) +
  mytheme + xlim(-2350,1500) + ylim(-210,50) +
  scale_shape_manual(name='Plot type', values=c(16,1), labels=c('Invaded','Reference'))+
  scale_linetype_manual(name='Plot type', values=c(1,2), labels=c('Invaded','Reference'))
p

#add site information
siteVars<-c('PercBA_AM','nTrees','BA_total','mv_g.m2')
data.siteVars<-data.choice[data.choice$variable %in% siteVars, c('plotid','inv','year','variable','value')]
data.siteVars$variable<-factor(data.siteVars$variable, levels=siteVars)
data.siteVars.wide<-dcast(data.siteVars, plotid + inv + year ~ variable, value.var='value')
data.siteVars.wide$plotYear<-paste(as.character(data.siteVars.wide$plotid), 
                                   data.siteVars.wide$year, sep="_") #use this to block by plotid*year
data.siteVars.wide1<-data.siteVars.wide[data.siteVars.wide$inv=='I',]
data.merge<-merge(sampleScores.c, data.siteVars.wide1)
data.merge$PercBA_AM_bin<-'ECM dominated'
data.merge[data.merge$PercBA_AM>50,'PercBA_AM_bin']<-'AM dominated'
mean_nTrees<-mean(data.merge$nTrees)
data.merge$nTrees_bin<-'Few trees'
data.merge[data.merge$nTrees>mean_nTrees,'nTrees_bin']<-'Many trees'
mean_BA_total<-mean(data.merge$BA_total)
data.merge$BA_total_bin<-'Low basal area'
data.merge[data.merge$BA_total>mean_BA_total,'BA_total_bin']<-'High basal area'
mean_mv<-mean(data.merge$mv_g.m2)
data.merge$mv_bin<-'Low Mv'
data.merge[data.merge$mv_g.m2>mean_mv,'mv_bin']<-'High Mv'

#without site info
p.vecs<-ggplot(sampleScores, aes(x=MDS1, y=MDS2)) + 
  geom_segment(mapping=aes(x=N_MDS1, y=N_MDS2, xend=I_MDS1, yend=I_MDS2), 
               data=data.merge, arrow = arrow(length = unit(0.25, "cm")), color='darkgray') +
  geom_path(data=df_ell, aes(x=NMDS1, y=NMDS2, linetype=inv), size=0.5, color='blue') +
  
  geom_segment(mapping=aes(x=0, y=0, xend=MDS1, yend=MDS2), 
               data=variableScores, arrow = arrow(length = unit(0.5, "cm")), color=1) +
  geom_text(mapping=aes(x=MDS1, y=MDS2, label=id, angle = angle, hjust = hjust), 
            data=variableScores, color=1, size=3) + 
  mytheme + xlim(-2350,1500) + ylim(-210,50) +
  scale_shape_manual(name='Plot type', values=c(16,1), labels=c('Invaded','Reference'))+
  scale_linetype_manual(name='Plot type', values=c(1,2), labels=c('Invaded','Reference'))
p.vecs  

#with site info -- MV
p.vecs.Mv<-ggplot(sampleScores, aes(x=MDS1, y=MDS2)) + 
  geom_segment(mapping=aes(x=N_MDS1, y=N_MDS2, xend=I_MDS1, yend=I_MDS2, color=mv_bin), 
               data=data.merge, arrow = arrow(length = unit(0.25, "cm"))) +
  geom_segment(mapping=aes(x=0, y=0, xend=MDS1, yend=MDS2), 
               data=variableScores, arrow = arrow(length = unit(0.5, "cm")), color=1) +
  geom_text(mapping=aes(x=MDS1, y=MDS2, label=id, angle = angle, hjust = hjust), 
            data=variableScores, color=1, size=3) + 
  mytheme + xlim(-2350,1500) + ylim(-210,50) +
  scale_shape_manual(name='Plot type', values=c(16,1), labels=c('Invaded','Reference'))+
  scale_linetype_manual(name='Plot type', values=c(1,2), labels=c('Invaded','Reference'))
p.vecs.Mv

#with site info -- nTrees
p.vecs.nTrees<-ggplot(sampleScores, aes(x=MDS1, y=MDS2)) + 
  geom_segment(mapping=aes(x=N_MDS1, y=N_MDS2, xend=I_MDS1, yend=I_MDS2, color=nTrees_bin), 
               data=data.merge, arrow = arrow(length = unit(0.25, "cm"))) +
  geom_segment(mapping=aes(x=0, y=0, xend=MDS1, yend=MDS2), 
               data=variableScores, arrow = arrow(length = unit(0.5, "cm")), color=1) +
  geom_text(mapping=aes(x=MDS1, y=MDS2, label=id, angle = angle, hjust = hjust), 
            data=variableScores, color=1, size=3) + 
  mytheme + xlim(-2350,1500) + ylim(-210,50) +
  scale_shape_manual(name='Plot type', values=c(16,1), labels=c('Invaded','Reference'))+
  scale_linetype_manual(name='Plot type', values=c(1,2), labels=c('Invaded','Reference'))
p.vecs.nTrees

#with site info -- PercBA_AM
p.vecs.AM<-ggplot(sampleScores, aes(x=MDS1, y=MDS2)) + 
  geom_segment(mapping=aes(x=N_MDS1, y=N_MDS2, xend=I_MDS1, yend=I_MDS2, color=PercBA_AM_bin), 
               data=data.merge, arrow = arrow(length = unit(0.25, "cm"))) +
  geom_segment(mapping=aes(x=0, y=0, xend=MDS1, yend=MDS2), 
               data=variableScores, arrow = arrow(length = unit(0.5, "cm")), color=1) +
  geom_text(mapping=aes(x=MDS1, y=MDS2, label=id, angle = angle, hjust = hjust), 
            data=variableScores, color=1, size=3) + 
  mytheme + xlim(-2350,1500) + ylim(-210,50) +
  scale_shape_manual(name='Plot type', values=c(16,1), labels=c('Invaded','Reference'))+
  scale_linetype_manual(name='Plot type', values=c(1,2), labels=c('Invaded','Reference'))
p.vecs.AM

newfilename<-'pPCA_allvars_nmds.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*3, height = fig.height*3, res=fig.res)
grid.arrange(p, p.vecs)
dev.off()

newfilename<-'pPCA_allvars_nmds_siteInfo.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*3, height = fig.height*5, res=fig.res)
grid.arrange(p.vecs.Mv, p.vecs.nTrees, p.vecs.AM)
dev.off()
  
  
##############
#B. Investigate individual relationships using mixed effects models with year+site as a random effect.
##############

#1) Run models
Yvars<-plotVars
YvarNames<-plotVarNames
df<-data.vars.PCA
result<-InvEffect(Yvars=Yvars, YvarNames=YvarNames, df=df)

#2) Calculate means and save
data.vars.PCA.long<-melt(data.vars.PCA, measure.vars=plotVars, id.vars = c('inv','year','plotid'))
meanSummary<-ddply(data.vars.PCA.long, ~variable+inv, summarize,
                   mean=mean(value),
                   n=length(value),
                   se=sd(value)/sqrt(n))
meanSummary[,c('mean','se')]<-round(meanSummary[,c('mean','se')], digits=2)
colnames(meanSummary)[colnames(meanSummary) == 'variable']<-'vars'
newfilename<-'meanSummary_allvars.txt'
write.table(meanSummary, file=paste(figuresPath,newfilename, sep='/'), sep='\t')

#3) Save coefficient and anova summary tables
data.frame(result[['summarySummary']])
newfilename<-'summarySummary_extra.txt'
write.table(data.frame(result[['summarySummary']]), file=paste(figuresPath,newfilename, sep='/'), sep='\t')
#data.frame(result[['posthocSummary']])
newfilename<-'posthocSummary_extra.txt'
write.table(data.frame(result[['posthocSummary']]), file=paste(figuresPath,newfilename, sep='/'), sep='\t')

#4) Plot
#i) prep dataframe and params
meanSummary.pretty<-merge(meanSummary, plotVars.indx)
meanSummary.pretty$plotVarNames<-factor(meanSummary.pretty$plotVarNames,levels=plotVarNames)
meanSummary.pretty$depth<-factor(meanSummary.pretty$depth, levels=depth_order)
meanSummary.pretty$depth<-mapvalues(meanSummary.pretty$depth, from = depth_order, to = c('0-5cm','5-15cm'))
meanSummary.pretty$inv<-mapvalues(meanSummary.pretty$inv, from = inv_order, to = invNames)
limits <- aes(ymax = mean + se, ymin=mean - se)

plotVars.sub<-c('soilmoi_T','soilmoi_B','som_T','som_B','ph_T','ph_B')
meanSummary.pretty.sub<-subset(meanSummary.pretty, vars %in% plotVars.sub)
meanSummary.pretty.sub$basicVars<-c(rep('Soil pH',4), 
                                    rep('Soil moisture (%)',4), 
                                    rep('Org. Matter (%)',4))
#ii) facet each soil response variable
p1<-ggplot(meanSummary.pretty.sub, aes(x=inv, y=mean, linetype=depth, group=depth)) +
  geom_point(size=3) + ylab('Measurement value') + xlab(NULL) +
  geom_errorbar(limits, width=0.2) + geom_line() + 
  facet_wrap(~basicVars, scales='free_y') + mytheme

plotVars.sub<-c('nat_g.m2','litter_g.m2','percpar')
meanSummary.pretty.sub<-subset(meanSummary.pretty, vars %in% plotVars.sub)
meanSummary.pretty.sub$plotVarNames<-c(rep('Litter biomass (g/m2)',2), 
                                       rep('Understory biomass (g/m2)',2), 
                                       rep('Light avail. (%)',2))

#ii) facet each soil response variable
p2<-ggplot(meanSummary.pretty.sub, aes(x=inv, y=mean)) +
  geom_point(size=3) + ylab('Measurement value') + xlab(NULL) +
  geom_errorbar(limits, width=0.2) + geom_line() + 
  facet_wrap(~plotVarNames, scales='free_y') + mytheme


#iv) put panels together and save
grid.arrange(p1 + guides(linetype=FALSE),
             p2,
             nrow=2)
newfilename<-'pScat_allvars.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*3, height = fig.height*2, res=fig.res)
grid.arrange(p1+ guides(linetype=FALSE),
             p2,
             nrow=2)
dev.off()

##############
#D. Identify N variables that increase/decrease across sites.
##############
data.frame(result[['posthocSummary']])
paste('Soil moisture is higher in invaded plots')
paste('Litter biomass is lower in invaded plots')

```

_________________________________________________________________
# %AM
a. Does Microstegium biomass vary with %AM?
b. Does %AM vary with multivariate soil N conditions in reference plots?









