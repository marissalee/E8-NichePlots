---
title: 'E8 main document'
author: "Marissa Lee"
date: "October 23, 2015"
output: pdf_document
---

_________________________________________________________________
# 0. Import, clean, merge, load fxns
```{r libraries, echo=FALSE}
knitr::opts_chunk$set(cache=TRUE)

#LIBRARIES
library(plyr)
library(reshape2)
library(ggplot2) #plotting
library(ggthemes) #ggplot accessories
library(GGally) #????
library(gtable)
library(gridExtra) #for grid.arrange fxn
library(lme4) #for mixed-effects models
library(lmerTest) #for lmer p-values
library(vegan) #for adonis fxn to do perMANOVAs
library(lavaan) #for structural equation modeling
library(doBy) #the orderBy fxn
library(merTools)
#library(bpca) #for 3d plots
#load other libraries
library(car) #Anova()
library(QuantPsyc) #lm.beta()
library(semPlot)
library(piecewiseSEM)
#citation('piecewiseSEM')

#CUSTOM FUNCTIONS
source('CODE/fxn_reshapeHelpers.R')
source('CODE/fxn_PCAhelpers.R')
source('CODE/fxn_NMDShelpers.R')
source('CODE/fxn_ScaleFit_q2.R')
source('CODE/fxn_InvEffect.R') #calculate invasion effect in a mixed effects model
source('CODE/fxn_predictHelpers.R') #creates dataframes to feed into model predictions

#THEME
source('CODE/mytheme.R')

#IMPORT, CLEAN, MERGE
source('CODE/script_cleanMerge.R')
#saves plot 'pHist_depth.png'
#saves data 'data_a.txt' # aggregated mean(depth) for 2012 and 2013
#saves data 'data_d.txt' # removed variables that were only measured in 2011 (i.e. full soil depth 0-15cm measurements)

#decide what dataset to use
data.choice<-data_d

#summarize mv biomass
colnames(data.choice)
unique(data.choice$variable)
data.choice %>% 
  filter(variable=="mv_g.m2") %>%
  group_by(inv) %>%
  summarize(mean=mean(value))

```

_________________________________________________________________
# 0. Visualize data
```{r visualize, echo=FALSE}
source('CODE/script_visualize.R')
#saves the following plots:
#plot N variables - NMDS, PCA x plot points, site vectors
#all plot variables - NMDS, PCA x plot points, site vectors
#reference plot and site variables - NMDS, PCA
#saves the following tables:
#PCA loadings for plot N variables, all plot variablers, reference plot and site variables
```

_________________________________________________________________
# 1. Q1: Do soil N pools and fluxes shift in response to the presence of Microstegium? 
A. Do an ordination of soil N pools and fluxes and test the role of invasion status with permMANOVA
B. Investigate individual relationships using mixed effects models with year+site as a random effect and identify N variables that increase/decrease across sites.
```{r q1, echo=FALSE, message=FALSE, warning=FALSE}
nVars #variables in the analyses

source('CODE/script_q1A.R')
#saves table 'permMANOVA_q1.txt' #result of permMANOVA of the ordination given plot invasion status

source('CODE/script_q1B.R')
#B. Mixed effects models (soil N pool or flux value ~ inv + (1|siteYear))
#saves table 'meanSummary_q1.txt' #summary of individual soil N pools and fluxes by year and invasion status
#saves table 'summarySummary_q1.txt' #summary of individual mixed effect models for each soil N pool or flux
#saves table 'posthocSummary_q1.txt' #post-hoc comparisons among years and invasion status
#saves plot 'pScat_q1.png' #panels of soil N pool or flux ~ inv
```

_________________________________________________________________
# 2. Q2: Do reference plot conditions and/or Microstegium biomass predict impact magnitudes?
A. Calculate impact magnitude for each target variable (nitrate, nitrification, other variables detected in Q1 ordination)
B. Test the role of reference plot conditions and Microstegium biomass on impacts individually using mixed effects models with year as a random effect
```{r q2, echo=FALSE, message=FALSE, warning=FALSE}
##A. Calculate impact, prep dataset

#1. decide of difference variables
diffVars<-c('noi_T','noi_B','ammonifd_T','ammonifd_B','nitrifd_T','nitrifd_B','minzd_T','minzd_B')

#2. decide on what variables to include in the reference ordination
allVars
#allVars2 #without PercBA_AM
#allVars.AggPAR
#allVars2.AggPAR #without PercBA_AM
useThese_refVars<-allVars

#3. decide whether to include PercBA_AM as a separate parameter
#externalPercBA_AM<-'y'
externalPercBA_AM<-'n'

#4. prep dataset
source('CODE/script_q2_prep.R')
#View(data.q2)
write.table(data.q2, file="DATA/DATA_SYNTHESIZED/data_d_q2.txt", sep="\t")

#for the traditional multivariate regression approach
#see E8_multipleRegressions.Rmd


##B,ii. Run models for each of the following (Inv. - Ref): nitrate, nitrif, ammonif, minz 

#1. decide on model formulation
modelFormulaCode<-'PC1*PC2*Mv'
#modelFormulaCode<-'PC1+PC2+Mv'
#modelFormulaCode<-'PC1*PC2*AM*Mv'
#modelFormulaCode<-'PC1+PC2+AM+Mv'


#2. run models
source('CODE/script_q2.R')
PC1var.c.o
PC2var.c.o
mod.df[mod.df$pval<0.05,]

#check out some other models that disaggregate the varibles that are in PC1 and PC2
#source('CODE/extraScript_lookAtOtherModels.R')
#warnings()

#3. make plots
shapeVec<-c(16,1)
linetypeVec<-c(1,2)
fillVec<-c("#a1bdec","#8a9aa9")

####################################
#a. delta nitrate (inv-ref)
####################################
df.mod<-mod.noi[['df.mod.used']]
modT<-mod.noi[['modT']]

#set up PC2 levels
df.mod<-SetupFactors(df=df.mod, catVar='PC2.use', labelNames=c('Low forest openness (PC2)', 'High forest openness (PC2)'))

#figure out what the range of the PC2 factors correspond to
curr.RefVars<-c('nTrees','percpar')
curr.PC<-'PC2.use'
#low
df.tmp<-df.mod[df.mod$factorLevel=='Low forest openness (PC2)',]
PullPCVals(df=df.tmp, orig.df=data.choice, PC=curr.PC, RefVars=curr.RefVars, min.or.max='min')
PullPCVals(df=df.tmp, orig.df=data.choice, PC=curr.PC, RefVars=curr.RefVars, min.or.max='max')
#high
df.tmp<-df.mod[df.mod$factorLevel=='High forest openness (PC2)',]
PullPCVals(df=df.tmp, orig.df=data.choice, PC=curr.PC, RefVars=curr.RefVars, min.or.max='min')
PullPCVals(df=df.tmp, orig.df=data.choice, PC=curr.PC, RefVars=curr.RefVars, min.or.max='max')

#plot: diff noi_T ~ Mvbiomass by PC2 levels
#prediction data frames ...
df.pred<-InteractionPlot_DF(n=100, xVar='mv_g.m2_logt', 
                            factorVar='PC2.use', factorBin='factorLevel', 
                            constantVar='PC1', 
                            df=df.mod, mod=modT, re.pred=TRUE)
df.pred$year<-factor(df.pred$year)

#plot
pScat.noiDiff_MvPC2<-ggplot(data=df.pred, 
                            mapping=aes(x=mv_g.m2_logt, 
                                        y=ypred, 
                                        ymin=CI.lwr, ymax=CI.upr, 
                                        shape=year, linetype=year, fill=year))  +  
  geom_ribbon(alpha=0.8) +
  geom_line() +
  facet_grid(~factorLevel) +
  geom_abline(intercept=0,slope=0, linetype=3, color='gray50') + 
  mytheme + ylab(expression(paste(Delta," Nitrate 0-5cm (Inv.-Ref.)"))) + 
  xlab('Microstegium biomass (log g/m2)') + 
  geom_point(data=df.mod, aes(y=select.diffVarT, ymin=NULL, ymax=NULL)) +
  scale_shape_manual(values=shapeVec) +
  scale_linetype_manual(values=linetypeVec) +
  scale_fill_manual(values=fillVec)
pScat.noiDiff_MvPC2


#plot: diff noi_T ~ PC1 by PC2 levels
#prediction data frames ...
df.pred<-InteractionPlot_DF(n=100, xVar='PC1', 
                            factorVar='PC2.use', factorBin='factorLevel', 
                            constantVar='mv_g.m2_logt', 
                            df=df.mod, mod=modT, re.pred=TRUE)
df.pred$year<-factor(df.pred$year)

#plot
pScat.noiDiff_PC1PC2<-ggplot(data=df.pred, 
                            mapping=aes(x=PC1, 
                                        y=ypred, 
                                        ymin=CI.lwr, ymax=CI.upr, 
                                        shape=year, linetype=year, fill=year))  +  
  geom_ribbon(alpha=0.8) +
  geom_line() +
  facet_grid(~factorLevel) +
  geom_abline(intercept=0,slope=0, linetype=3, color='gray50') + 
  mytheme + ylab(expression(paste(Delta," Nitrate 0-5cm (Inv.-Ref.)"))) + 
  xlab('Soil moisture and OM (PC1)') + 
  geom_point(data=df.mod, aes(y=select.diffVarT, ymin=NULL, ymax=NULL)) +
  scale_shape_manual(values=shapeVec) +
  scale_linetype_manual(values=linetypeVec) +
  scale_fill_manual(values=fillVec)
pScat.noiDiff_PC1PC2

#save plots
newfilename<-"pScat_noiDiff_Xmv.pdf"
pdf(paste(figuresPath,newfilename, sep='/'), 
    width = fig.width*2, height = fig.height*1.2)
pScat.noiDiff_MvPC2 + guides(shape=FALSE, linetype=FALSE, fill=FALSE)
dev.off()

newfilename<-"pScat_noiDiff_Xpc1.pdf"
pdf(paste(figuresPath,newfilename, sep='/'),  
    width = fig.width*2, height = fig.height*1.2)
pScat.noiDiff_PC1PC2+ guides(shape=FALSE, linetype=FALSE, fill=FALSE)
dev.off()

newfilename<-"pScat_noiDiff_both.pdf"
pdf(paste(figuresPath,newfilename, sep='/'), 
    width = fig.width*2, height = fig.height*2.2)
grid.arrange(pScat.noiDiff_MvPC2 + guides(shape=FALSE, linetype=FALSE, fill=FALSE), 
             pScat.noiDiff_PC1PC2 + guides(shape=FALSE, linetype=FALSE, fill=FALSE))
dev.off()




####################################
#b. delta ammonification (inv-ref)
####################################
df.mod<-mod.ammonifd[['df.mod.used']]
modT<-mod.ammonifd[['modT']]

#set up PC1 levels
df.mod<-SetupFactors(df=df.mod, catVar='PC1', labelNames=c('Low moisture & OM (PC1)', 'High moisture & OM (PC1)'))

#figure out what the range of the PC1 factors correspond to
curr.RefVars<-c('soilmoi_T','soilmoi_B','som_T','som_B')
curr.PC<-'PC1'
#low
df.tmp<-df.mod[df.mod$factorLevel=='Low moisture & OM (PC1)',]
PullPCVals(df=df.tmp, orig.df=data.choice, PC=curr.PC, RefVars=curr.RefVars, min.or.max='min')
PullPCVals(df=df.tmp, orig.df=data.choice, PC=curr.PC, RefVars=curr.RefVars, min.or.max='max')
#high
df.tmp<-df.mod[df.mod$factorLevel=='High moisture & OM (PC1)',]
PullPCVals(df=df.tmp, orig.df=data.choice, PC=curr.PC, RefVars=curr.RefVars, min.or.max='min')
PullPCVals(df=df.tmp, orig.df=data.choice, PC=curr.PC, RefVars=curr.RefVars, min.or.max='max')


#plot: diff ammonif_T ~ Mvbiomass by PC1 levels
#prediction data frames ...
df.pred1<-InteractionPlot_DF(n=100, xVar='mv_g.m2_logt', 
                            factorVar='PC1', factorBin='factorLevel', 
                            constantVar='PC2.use', 
                            df=df.mod, mod=modT, re.pred=TRUE)
#str(df.pred1)
df.pred1$year<-factor(df.pred1$year)

#plot
pScat.ammonifdDiff_MvPC1<-ggplot(data=df.pred1, 
                                 mapping=aes(x=mv_g.m2_logt, 
                                             y=ypred, 
                                             ymin=CI.lwr, ymax=CI.upr, 
                                             shape=year, linetype=year, fill=year))  +  
  geom_ribbon(alpha=0.8) +
  geom_line(color='black') +
  facet_grid(~factorLevel) +
  geom_abline(intercept=0,slope=0, linetype=3, color='gray50') + 
  mytheme + ylab(expression(paste(Delta," Ammonif. 0-5cm (Inv.-Ref.)"))) + 
  xlab('Microstegium biomass (log g/m2)') + 
  geom_point(data=df.mod, aes(y=select.diffVarT, ymin=NULL, ymax=NULL)) +
  scale_shape_manual(values=shapeVec) +
  scale_linetype_manual(values=linetypeVec) +
  scale_fill_manual(values=fillVec)
pScat.ammonifdDiff_MvPC1


#plot just the high PC1 panel
df.mod_highPC1<-subset(df.mod, factorLevel == 'High moisture & OM (PC1)')
df.pred1_highPC1<-subset(df.pred1, factorLevel == 'High moisture & OM (PC1)')
pScat.ammonifdDiff_Mv.high.PC1<-ggplot(data=df.pred1_highPC1, 
                                 mapping=aes(x=mv_g.m2_logt, 
                                             y=ypred, 
                                             ymin=CI.lwr, ymax=CI.upr, 
                                             shape=year, linetype=year, fill=year))  +  
  geom_ribbon(alpha=0.8) +
  geom_line() +
  geom_abline(intercept=0,slope=0, linetype=3, color='gray50') + 
  mytheme + ylab(expression(paste(Delta," Ammonif. 0-5cm (Inv.-Ref.)"))) + 
  xlab('Microstegium biomass (log g/m2)') + 
  geom_point(data=df.mod_highPC1, aes(y=select.diffVarT, ymin=NULL, ymax=NULL))+
  scale_shape_manual(values=shapeVec) +
  scale_linetype_manual(values=linetypeVec) +
  scale_fill_manual(values=fillVec)
pScat.ammonifdDiff_Mv.high.PC1


#plot: diff ammonifd_T ~ PC2 by PC1 levels
#prediction data frames ...
df.pred2<-InteractionPlot_DF(n=100, xVar='PC2.use', 
                            factorVar='PC1', factorBin='factorLevel', 
                            constantVar='mv_g.m2_logt', 
                            df=df.mod, mod=modT, re.pred=TRUE)
#str(df.pred2)
df.pred2$year<-factor(df.pred2$year)
pScat.ammonifdDiff_PC2PC1<-ggplot(data=df.pred2, 
                                  mapping=aes(x=PC2.use, 
                                              y=ypred, 
                                              ymin=CI.lwr, ymax=CI.upr, 
                                             shape=year, linetype=year, fill=year))  +  
  geom_ribbon(alpha=0.8) +
  geom_line() +
  facet_grid(~factorLevel) +
  geom_abline(intercept=0,slope=0, linetype=3, color='gray50') + 
  mytheme + ylab(expression(paste(Delta," Ammonif. 0-5cm (Inv.-Ref.)"))) + 
  xlab('Forest openness (PC2)') + 
  geom_point(data=df.mod, aes(y=select.diffVarT, ymin=NULL, ymax=NULL))+
  scale_shape_manual(values=shapeVec) +
  scale_linetype_manual(values=linetypeVec) +
  scale_fill_manual(values=fillVec)
pScat.ammonifdDiff_PC2PC1

#plot just the high PC1 panel
df.pred2_highPC1<-subset(df.pred2, factorLevel == 'High moisture & OM (PC1)')
pScat.ammonifdDiff_PC2.high.PC1<-ggplot(data=df.pred2_highPC1, 
                                  mapping=aes(x=PC2.use, 
                                              y=ypred, 
                                              ymin=CI.lwr, ymax=CI.upr, 
                                             shape=year, linetype=year, fill=year))  +  
  geom_ribbon(alpha=0.8) +
  geom_line() +
  geom_abline(intercept=0,slope=0, linetype=3, color='gray50') + 
  mytheme + ylab(expression(paste(Delta," Ammonif. 0-5cm (Inv.-Ref.)"))) + 
  xlab('Forest openness (PC2)') + 
  geom_point(data=df.mod_highPC1, aes(y=select.diffVarT, ymin=NULL, ymax=NULL))+
  scale_shape_manual(values=shapeVec) +
  scale_linetype_manual(values=linetypeVec) +
  scale_fill_manual(values=fillVec)
pScat.ammonifdDiff_PC2.high.PC1


#plot: diff ammonifd_T ~ PC1
#prediction data frames ...
df.pred3<-XYPlot_DF(n=100, xVar='PC1', 
                            constantVar=c('mv_g.m2_logt','PC2.use'), 
                            df=df.mod, mod=modT, re.pred=TRUE)
#str(df.pred3)
df.pred3$year<-factor(df.pred3$year)
pScat.ammonifdDiff_PC1<-ggplot(data=df.pred3, 
                                  mapping=aes(x=PC1, 
                                              y=ypred, 
                                              ymin=CI.lwr, ymax=CI.upr, 
                                             shape=year, linetype=year, fill=year))  +  
  geom_ribbon(alpha=0.8) +
  geom_line() +
  geom_abline(intercept=0,slope=0, linetype=3, color='gray50') + 
  mytheme + ylab(expression(paste(Delta," Ammonif. 0-5cm (Inv.-Ref.)"))) + 
  xlab('Soil moisture and OM (PC1)') + 
  geom_point(data=df.mod, aes(y=select.diffVarT, ymin=NULL, ymax=NULL))+
  scale_shape_manual(values=shapeVec) +
  scale_linetype_manual(values=linetypeVec) +
  scale_fill_manual(values=fillVec)
pScat.ammonifdDiff_PC1


#save plots

newfilename<-'pScat_ammonifdDiff_Xmv.pdf'
pdf(paste(figuresPath,newfilename, sep='/'),  
    width = fig.width*2, height = fig.height*1.2)
pScat.ammonifdDiff_MvPC1+ guides(shape=FALSE, linetype=FALSE, fill=FALSE)
dev.off()

newfilename<-'pScat_ammonifdDiff_XPC2.pdf'
pdf(paste(figuresPath,newfilename, sep='/'), 
    width = fig.width*2, height = fig.height*1.2)
pScat.ammonifdDiff_PC2PC1+ guides(shape=FALSE, linetype=FALSE, fill=FALSE)
dev.off()

newfilename<-'pScat_ammonifdDiff_bothHigh.pdf'
pdf(paste(figuresPath,newfilename, sep='/'),  
    width = fig.width*2, height = fig.height*2.2)
grid.arrange(pScat.ammonifdDiff_Mv.high.PC1+ guides(shape=FALSE, linetype=FALSE, fill=FALSE),
             pScat.ammonifdDiff_PC2.high.PC1+ guides(shape=FALSE, linetype=FALSE, fill=FALSE), 
             ncol=2)
dev.off()

newfilename<-'pScat_ammonifdDiff_XPC1.pdf'
pdf(paste(figuresPath,newfilename, sep='/'), 
    width = fig.width*2, height = fig.height*1.2)
pScat.ammonifdDiff_PC1+ guides(shape=FALSE, linetype=FALSE, fill=FALSE)
dev.off()

newfilename<-'pScat_ammonifdDiff_both.png'
pdf(paste(figuresPath,newfilename, sep='/'), 
    width = fig.width*2, height = fig.height*3.2)
grid.arrange(pScat.ammonifdDiff_MvPC1+ guides(shape=FALSE, linetype=FALSE, fill=FALSE),
             pScat.ammonifdDiff_PC2PC1+ guides(shape=FALSE, linetype=FALSE, fill=FALSE),
             pScat.ammonifdDiff_PC1+ guides(shape=FALSE, linetype=FALSE, fill=FALSE))
dev.off()


newfilename<-'pScat_ammonifdDiff_mainFig.pdf'
pdf(paste(figuresPath,newfilename, sep='/'), 
    width = fig.width*2, height = fig.height*2.2)
grid.arrange(pScat.ammonifdDiff_MvPC1+ guides(shape=FALSE, linetype=FALSE, fill=FALSE),
             pScat.ammonifdDiff_PC2PC1+ guides(shape=FALSE, linetype=FALSE, fill=FALSE))
dev.off()

newfilename<-'pScat_ammonifdDiff_suppFig.pdf'
pdf(paste(figuresPath,newfilename, sep='/'), 
    width = fig.width*1, height = fig.height*1.05)
pScat.ammonifdDiff_PC1+ guides(shape=FALSE, linetype=FALSE, fill=FALSE)
dev.off()




####################################
#c. delta nitrification (inv-ref)
####################################
df.mod<-mod.nitrifd[['df.mod.used']]
modT<-mod.nitrifd[['modT']]

#set up PC1 levels
df.mod<-SetupFactors(df=df.mod, catVar='PC1', labelNames=c('Low moisture & OM (PC1)', 'High moisture & OM (PC1)'))

#plot: diff nitrifd_T ~ Mvbiomass by PC1 levels
#prediction data frames ...
df.pred1<-InteractionPlot_DF(n=100, xVar='mv_g.m2_logt', 
                            factorVar='PC1', factorBin='factorLevel', 
                            constantVar='PC2.use', 
                            df=df.mod, mod=modT, re.pred=TRUE)
#str(df.pred1)
df.pred1$year<-factor(df.pred1$year)

#plot
pScat.nitrifdDiff_MvPC1<-ggplot(data=df.pred1, 
                                 mapping=aes(x=mv_g.m2_logt, 
                                             y=ypred, 
                                             ymin=CI.lwr, ymax=CI.upr, 
                                             shape=year, linetype=year, fill=year))  +  
  geom_ribbon(alpha=0.8) +
  geom_line() +
  facet_grid(~factorLevel) +
  geom_abline(intercept=0,slope=0, linetype=3, color='gray50') + 
  mytheme + ylab(expression(paste(Delta," Nitrif. 0-5cm (Inv.-Ref.)"))) + 
  xlab('Microstegium biomass (log g/m2)') + 
  geom_point(data=df.mod, aes(y=select.diffVarT, ymin=NULL, ymax=NULL))+
  scale_shape_manual(values=shapeVec) +
  scale_linetype_manual(values=linetypeVec) +
  scale_fill_manual(values=fillVec)
pScat.nitrifdDiff_MvPC1

#save plots

newfilename<-'pScat_nitrifdDiff_Xmv.pdf'
pdf(paste(figuresPath,newfilename, sep='/'), 
    width = fig.width*2, height = fig.height*1.2)
pScat.nitrifdDiff_MvPC1+ guides(shape=FALSE, linetype=FALSE, fill=FALSE)
dev.off()

####################################
#d. delta mineralization (inv-ref)
####################################
df.mod<-mod.minzd[['df.mod.used']]
modT<-mod.minzd[['modT']]

#set up PC1 levels
df.mod<-SetupFactors(df=df.mod, catVar='PC1', labelNames=c('Low moisture & OM (PC1)', 'High moisture & OM (PC1)'))

#plot: diff minzd_T ~ Mvbiomass by PC1 levels
#prediction data frames ...
df.pred1<-InteractionPlot_DF(n=100, xVar='mv_g.m2_logt', 
                            factorVar='PC1', factorBin='factorLevel', 
                            constantVar='PC2.use', 
                            df=df.mod, mod=modT, re.pred=TRUE)
#str(df.pred1)
df.pred1$year<-factor(df.pred1$year)

#plot
pScat.minzdDiff_MvPC1<-ggplot(data=df.pred1, 
                                 mapping=aes(x=mv_g.m2_logt, 
                                             y=ypred, 
                                             ymin=CI.lwr, ymax=CI.upr, 
                                             shape=year, linetype=year, fill=year))  +  
  geom_ribbon(alpha=0.8) +
  geom_line() +
  facet_grid(~factorLevel) +
  geom_abline(intercept=0,slope=0, linetype=3, color='gray50') + 
  mytheme + ylab(expression(paste(Delta," Mineraliz. 0-5cm (Inv.-Ref.)"))) + 
  xlab('Microstegium biomass (log g/m2)') + 
  geom_point(data=df.mod, aes(y=select.diffVarT, ymin=NULL, ymax=NULL))+
  scale_shape_manual(values=shapeVec) +
  scale_linetype_manual(values=linetypeVec) +
  scale_fill_manual(values=fillVec)
pScat.minzdDiff_MvPC1


#plot: diff minzd_T ~ PC2 by PC1 levels
#prediction data frames ...
df.pred1<-InteractionPlot_DF(n=100, xVar='PC2.use', 
                            factorVar='PC1', factorBin='factorLevel', 
                            constantVar='mv_g.m2_logt', 
                            df=df.mod, mod=modT, re.pred=TRUE)
df.pred1$year<-factor(df.pred1$year)

#plot
pScat.minzdDiff_PC2PC1<-ggplot(data=df.pred1, 
                                 mapping=aes(x=PC2.use, 
                                             y=ypred, 
                                             ymin=CI.lwr, ymax=CI.upr, 
                                             shape=year, linetype=year, fill=year))  +  
  geom_ribbon(alpha=0.8) +
  geom_line() +
  facet_grid(~factorLevel) +
  geom_abline(intercept=0,slope=0, linetype=3, color='gray50') + 
  mytheme + ylab(expression(paste(Delta," Mineraliz. 0-5cm (Inv.-Ref.)"))) + 
  xlab('Forest openness (PC2)') + 
  geom_point(data=df.mod, aes(y=select.diffVarT, ymin=NULL, ymax=NULL))+
  scale_shape_manual(values=shapeVec) +
  scale_linetype_manual(values=linetypeVec) +
  scale_fill_manual(values=fillVec)
pScat.minzdDiff_PC2PC1



#plot: diff minzd_T ~ PC1
#prediction data frames ...
df.pred3<-XYPlot_DF(n=100, xVar='PC1', 
                            constantVar=c('mv_g.m2_logt','PC2.use'), 
                            df=df.mod, mod=modT, re.pred=TRUE)
df.pred3$year<-factor(df.pred3$year)

pScat.minzdDiff_PC1<-ggplot(data=df.pred3, 
                                  mapping=aes(x=PC1, 
                                              y=ypred, 
                                              ymin=CI.lwr, ymax=CI.upr, 
                                             shape=year, linetype=year, fill=year))  +  
  geom_ribbon(alpha=0.8) +
  geom_line() +
  geom_abline(intercept=0,slope=0, linetype=3, color='gray50') + 
  mytheme + ylab(expression(paste(Delta," Mineraliz. 0-5cm (Inv.-Ref.)"))) + 
  xlab('Soil moisture and OM (PC1)') + 
  geom_point(data=df.mod, aes(y=select.diffVarT, ymin=NULL, ymax=NULL))+
  scale_shape_manual(values=shapeVec) +
  scale_linetype_manual(values=linetypeVec) +
  scale_fill_manual(values=fillVec)
pScat.minzdDiff_PC1


#save plots

newfilename<-'pScat_minzdDiff_Xmv.pdf'
pdf(paste(figuresPath,newfilename, sep='/'), 
    width = fig.width*2, height = fig.height*1.2)
pScat.minzdDiff_MvPC1+ guides(shape=FALSE, linetype=FALSE, fill=FALSE)
dev.off()

newfilename<-'pScat_minzdDiff_XPC2.pdf'
pdf(paste(figuresPath,newfilename, sep='/'),  
    width = fig.width*2, height = fig.height*1.2)
pScat.minzdDiff_PC2PC1+ guides(shape=FALSE, linetype=FALSE, fill=FALSE)
dev.off()

newfilename<-'pScat_minzdDiff_XPC1.pdf'
pdf(paste(figuresPath,newfilename, sep='/'), 
    width = fig.width*2, height = fig.height*1.2)
pScat.minzdDiff_PC1+ guides(shape=FALSE, linetype=FALSE, fill=FALSE)
dev.off()

newfilename<-'pScat_minzdDiff_both.pdf'
pdf(paste(figuresPath,newfilename, sep='/'), 
    width = fig.width*2, height = fig.height*3.2)
grid.arrange(pScat.minzdDiff_MvPC1+ guides(shape=FALSE, linetype=FALSE, fill=FALSE),
             pScat.minzdDiff_PC2PC1+ guides(shape=FALSE, linetype=FALSE, fill=FALSE),
             pScat.minzdDiff_PC1+ guides(shape=FALSE, linetype=FALSE, fill=FALSE))
dev.off()


```

_________________________________________________________________
# 3. Q3: Do reference plot conditions predict Microstegium biomass?
A. Do an ordination of reference conditions and test the relationship between Microstegium biomass and reference conditions using permMANOVA.
B. Investigate relationship between PC scores and Microstegium biomass using mixed effects models with year as a random effect.
```{r q3, echo=FALSE, message=FALSE, warning=FALSE}
#A. Do an ordination of reference conditions and test the relationship between Microstegium biomass and reference conditions using permMANOVA.

#i) Identify reference plot condition variables
useThese_refVars<-allVars
data.refVars<-data.choice[data.choice$variable %in% useThese_refVars, c('plotid','plothalfid1','inv','year','variable','value')]
data.refVars$variable<-factor(data.refVars$variable, levels=useThese_refVars)
data.refVars<-subset(data.refVars, inv == 'N')
data.refVars.wide<-dcast(data.refVars, plotid + year ~ variable, value.var='value')
data.refVars.wide$plotYear<-paste(data.refVars.wide$plotid, data.refVars.wide$year, sep="_")
data.q3<-data.refVars.wide

#2) Ordinate reference conditions
data.q3.rm<-data.q3[!rowSums(is.na(data.q3))>0,]
tmp<-data.q3.rm[,useThese_refVars]
colnames(tmp)<-useThese_refVars
#cor(tmp) #look at correlation matrix
row.names(tmp)<-data.q3.rm$plotYear
tmp.scaled<-scale(tmp)
PCA.res<-prcomp(tmp.scaled)
pPCA_q3<-ggbiplot_custom(pcobj=PCA.res, df=data.q3.rm) #saved in 'script_visualize.R'
pPCA_q3
sort(PCA.res$rotation[,1]) #PC1 loadings
sort(PCA.res$rotation[,2]) #PC2 loadings.. more trees, less light
df.PCA<-data.frame(plotYear=row.names(PCA.res$x), PCA.res$x)
df.PCA$PC2_neg1<-df.PCA$PC2*-1 #less tree, more light (forest openness)

#add Mv biomass to dataset
colnames(data.mvVar.wide) #from 'script_q2_prep.R'
data.mvVar.wide$plotYear<-paste(data.mvVar.wide$plotid, data.mvVar.wide$year, sep="_")
data.q3.PCA<-merge(data.mvVar.wide, df.PCA[,c('plotYear','PC1','PC2_neg1')])

#3) Do reference area and plot characteristics explain variation in Mv biomass? - perMANOVA on mv biomass
perMANOVA<-adonis(tmp.scaled ~ mv_g.m2, data = data.q3.PCA, method='eu')
aov.tab.permanova<-data.frame(perMANOVA$aov.tab)
aov.tab.permanova
#save anova table
newfilename<-'permMANOVA_q3.txt'
write.table(aov.tab.permanova, file=paste(figuresPath,newfilename, sep='/'), sep='\t')


#B. Do PC scores from the reference condition ordination predict mv biomass?
#1) Fit model
data.q3.PCA$year<-factor(data.q3.PCA$year)
df.mod<-data.q3.PCA

#If PercBA_AM should be included separately from reference conditions...Identify PercBA_AM and merge it into dataset
#externalPercBA_AM
if(externalPercBA_AM == 'y'){
  
  #merge
  df.mod<-merge(df.mod, data.AM.wide)

  #make a bin for %AM
  df.mod$MycBin<-NA
  df.mod[df.mod$PercBA_AM >=0 & df.mod$PercBA_AM <50,'MycBin']<-'AM'
  df.mod[df.mod$PercBA_AM >=50 & df.mod$PercBA_AM <=100,'MycBin']<-'ECM'
  
  mod<-lmer(mv_g.m2_logt~PC1*PC2*MycBin + (1|year), data=df.mod)
}else{
  mod<-lmer(mv_g.m2_logt~PC1*PC2_neg1 + (1|year), data=df.mod)
}
summary(mod)$coefficients
#save anova table
newfilename<-'summaryTable_q3.txt'
write.table(summary(mod)$coefficients, file=paste(figuresPath,newfilename, sep='/'), sep='\t')

#2) Plot
#set up PC1 levels
df.mod<-SetupFactors(df=df.mod, catVar='PC1', labelNames=c('Low moisture & OM (PC1)', 'High moisture & OM (PC1)'))

#set up prediction dataframes
df.pred<-XYPlot_DF(n=100, xVar='PC2_neg1', constantVar='PC1', df=df.mod, mod=mod, re.pred=TRUE)
df.pred$year<-factor(df.pred$year)

#plot
pScat.Mv_PC2<-ggplot(data=df.pred, 
                     mapping=aes(x=PC2_neg1, 
                                 y=ypred, 
                                 ymin=CI.lwr, ymax=CI.upr, 
                                 shape=year, linetype=year, fill=year))  +  
  geom_ribbon(alpha=0.8) +
  geom_line() +
  mytheme + ylab('Microstegium biomass (log g/m2)') + xlab('Forest openness (PC2)') + 
  geom_point(data=df.mod, aes(y=mv_g.m2_logt, ymin=NULL, ymax=NULL))+
  scale_shape_manual(values=shapeVec) +
  scale_linetype_manual(values=linetypeVec) +
  scale_fill_manual(values=fillVec)
pScat.Mv_PC2

#make a plot with just high PC1 data
df.mod_highPC1<-subset(df.mod, factorLevel == 'High moisture & OM (PC1)')
pScat.Mv_PC2.high.PC1<-ggplot(data=df.pred, 
                                  mapping=aes(x=PC2_neg1, 
                                              y=ypred, 
                                              ymin=CI.lwr, ymax=CI.upr, 
                                 shape=year, linetype=year, fill=year))  +  
  geom_ribbon(alpha=0.8) +
  geom_line() +
  mytheme + ylab('Microstegium biomass (log g/m2)') + xlab('Forest openness (PC2)') +
  geom_point(data=df.mod_highPC1, aes(y=mv_g.m2_logt, ymin=NULL, ymax=NULL))+
  scale_shape_manual(values=shapeVec) +
  scale_linetype_manual(values=linetypeVec) +
  scale_fill_manual(values=fillVec)
pScat.Mv_PC2.high.PC1


#save plots

newfilename<-'pScat_q3.pdf'
pdf(paste(figuresPath,newfilename, sep='/'),
    width = fig.width*1, height = fig.height*1.05)
pScat.Mv_PC2 + guides(shape=FALSE, linetype=FALSE, fill=FALSE)
dev.off()

newfilename<-'pScat_3panelFig.pdf'
pdf(paste(figuresPath,newfilename, sep='/'), 
    width = fig.width*2, height = fig.height*2)
grid.arrange(pScat.Mv_PC2.high.PC1+ guides(shape=FALSE, linetype=FALSE, fill=FALSE), 
             textGrob(''),
             pScat.ammonifdDiff_PC2.high.PC1+ guides(shape=FALSE, linetype=FALSE, fill=FALSE),
             pScat.ammonifdDiff_Mv.high.PC1+ guides(shape=FALSE, linetype=FALSE, fill=FALSE)
             , ncol=2)
dev.off()




```

_________________________________________________________________
# 4. Q4: What is the relative importance of reference conditions on impact - direct and indirectly
```{r q4, echo=FALSE, message=FALSE, warning=FALSE}
library(nlme)
source('CODE/fxn_FitSEM.R') #function to fix piecewise SEM and save all the necessary info in a list

################
# Diff Nitrate
str(mod.noi)
sem.noi<-FitSEM(df.mod=mod.noi[['df.mod.used']], 
                diffVarShort='noi_T')
sem.noi$sem_fit
sem.noi$coef_nonstd
sem.noi$coef_std
sem.noi$r2

################
# Diff Ammonification
sem.ammonifd<-FitSEM(df.mod=mod.ammonifd[['df.mod.used']], 
                diffVarShort='ammonifd_T')
sem.ammonifd$sem_fit
sem.ammonifd$coef_nonstd
sem.ammonifd$coef_std
sem.ammonifd$r2

################
# Diff Nitrification
sem.nitrifd<-FitSEM(df.mod=mod.nitrifd[['df.mod.used']], 
                diffVarShort='nitrifd_T')
sem.nitrifd$sem_fit
sem.nitrifd$coef_nonstd
sem.nitrifd$coef_std
sem.nitrifd$r2

################
# Diff Mineralization
sem.minzd<-FitSEM(df.mod=mod.minzd[['df.mod.used']], 
                diffVarShort='minzd_T')
sem.minzd$sem_fit
sem.minzd$coef_nonstd
sem.minzd$coef_std
sem.minzd$r2

```

_________________________________________________________________
# Trends over time
a. Does Microstegium biomass increase over time?
b. Do soil N pools and fluxes in reference (and invaded) plots shift over time?
c. Do impact magnitudes shift over time?
d. Does the influence of reference conditions on Microstegium biomass shift over time?

_________________________________________________________________
# Invasion front study design
a. What environmental factors besides soil N pools and fluxes differ among paired invaded and reference plots?
```{r extra, echo=FALSE, message=FALSE, warning=FALSE}

##############
#A. Do an ordination of all environmental variables by plot - this is already in 'script_visualize.R'
##############


##############
#B. Investigate individual relationships using mixed effects models with year+site as a random effect.
##############

#0) set up dataframe
plotVars
data.plotVars<-data.choice[data.choice$variable %in% plotVars, c('plotid','plothalfid1','inv','year','variable','value')]
data.plotVars$variable<-factor(data.plotVars$variable, levels=plotVars)
data.plotVars.wide<-dcast(data.plotVars, plothalfid1 + plotid + inv + year ~ variable, value.var='value')
data.plotVars.wide$plotInvYear<-paste(data.plotVars.wide$plothalfid1, 
                                      data.plotVars.wide$year, sep="_") #use this to identify rows
data.plotVars.wide$plotYear<-paste(as.character(data.plotVars.wide$plotid), 
                                   data.plotVars.wide$year, sep="_") #use this to block by plotid*year

#1) Run models
result<-InvEffect(Yvars=plotVars, YvarNames=plotVarNames, df=data.plotVars.wide)


#2) Calculate means and save
data.plotVars.long<-melt(data.plotVars.wide, measure.vars=plotVars, id.vars = c('inv','year','plotid'))
meanSummary<-ddply(data.plotVars.long, ~variable+inv+year, summarize,
                   mean=mean(value, na.rm=TRUE),
                   n=sum(!is.na(value)),
                   se=sd(value, na.rm=TRUE)/sqrt(n))
meanSummary[,c('mean','se')]<-round(meanSummary[,c('mean','se')], digits=2)
colnames(meanSummary)[colnames(meanSummary) == 'variable']<-'vars'
meanSummary
newfilename<-'meanSummary_plotVars.txt'
write.table(meanSummary, file=paste(figuresPath,newfilename, sep='/'), sep='\t')

#3) Save coefficient and anova summary tables
newfilename<-'summarySummary_plotVars.txt'
write.table(data.frame(result[['summarySummary']]), file=paste(figuresPath,newfilename, sep='/'), sep='\t')
#data.frame(result[['posthocSummary']])
newfilename<-'posthocSummary_plotVars.txt'
write.table(data.frame(result[['posthocSummary']]), file=paste(figuresPath,newfilename, sep='/'), sep='\t')

#4) Plot
#i) prep dataframe and params
meanSummary.pretty<-merge(meanSummary,plotVars.indx)
meanSummary.pretty<-orderBy(~basic.vars.order+var.depth, meanSummary.pretty)
meanSummary.pretty$basic.varNames.units<-factor(meanSummary.pretty$basic.varNames.units, levels = unique(meanSummary.pretty$basic.varNames.units))
meanSummary.pretty$depth<-factor(meanSummary.pretty$depth, levels=c('T','B','NA'))
limits <- aes(ymax = mean + se, ymin=mean - se)
meanSummary.pretty$name<-meanSummary.pretty$basic.varNames.units
meanSummary.pretty$name2 <- factor(meanSummary.pretty$name,
                                   levels=c(levels(meanSummary.pretty$name)[1:2],'',
                                            levels(meanSummary.pretty$name)[3:11]))
meanSummary.pretty$year<-factor(meanSummary.pretty$year)
meanSummary.pretty$group<-paste(meanSummary.pretty$year, meanSummary.pretty$depth, sep=", ")
meanSummary.pretty1<-subset(meanSummary.pretty, basic.vars %in% c('soilmoi','som','ph',NA))

meanSummary.pretty1$inv
meanSummary.pretty1$inv<-factor(meanSummary.pretty1$inv, levels=c("N","I"))            
shapeVec<-c(1,16,16, 1,16,16)
linetypeVec<-c(2,1,1, 2,1,1)
colorVec<-c("black","black","black","darkgray","darkgray","darkgray")

p<-ggplot(meanSummary.pretty1, aes(x=inv, y=mean, 
                                  shape=group, color=group, linetype=group,
                            group=group)) +
  geom_point(size=3) + ylab(NULL) + xlab('Plot type') +
  scale_x_discrete(labels=c('Reference','Invaded')) +
  geom_errorbar(limits, width=0.2) + geom_line() + 
  facet_wrap(~name2, scales='free_y', ncol=3, drop=TRUE) + mytheme +
  scale_shape_manual(name='Year and depth', values=shapeVec) + 
  scale_color_manual(name='Year and depth', values=colorVec) +
  scale_linetype_manual(name='Year and depth', values=linetypeVec)
p


## plot
newfilename<-'pScat_plotVars.pdf'
pdf(paste(figuresPath,newfilename, sep='/'),
    width = fig.width*4, height = fig.height*3)
p 
dev.off()
```

_________________________________________________________________
# %AM
a. Does Microstegium biomass vary with %AM?
b. Does %AM vary with multivariate soil N conditions in reference plots?









