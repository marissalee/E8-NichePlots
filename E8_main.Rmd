---
title: 'E8 main document'
author: "Marissa Lee"
date: "October 23, 2015"
output: pdf_document
---

**Filename: E8_main.Rmd'**

_________________________________________________________________
# 0. Import, clean, merge, load fxns
```{r libraries, echo=FALSE}
knitr::opts_chunk$set(cache=TRUE)

#LIBRARIES
library(plyr)
library(reshape2)
library(ggplot2) #plotting
library(ggthemes) #ggplot accessories
library(GGally) #????
library(gtable)
library(gridExtra) #for grid.arrange fxn
library(lme4) #for mixed-effects models
library(lmerTest) #for lmer p-values
library(vegan) #for adonis fxn to do perMANOVAs
library(lavaan) #for structural equation modeling
library(doBy) #the orderBy fxn
library(merTools)
#library(bpca) #for 3d plots 

#CUSTOM FUNCTIONS
source('CODE/fxn_reshapeHelpers.R')
source('CODE/fxn_PCAhelpers.R')
source('CODE/fxn_NMDShelpers.R')
source('CODE/fxn_InvEffect.R') #calculate invasion effect in a mixed effects model
source('CODE/fxn_predictHelpers.R') #creates dataframes to feed into model predictions

#THEME
source('CODE/mytheme.R')

#IMPORT, CLEAN, MERGE
source('CODE/script_cleanMerge.R')
#saves plot 'pHist_depth.png'
#saves data 'data_a.txt' # aggregated mean(depth) for 2012 and 2013
#saves data 'data_d.txt' # removed variables that were only measured in 2011 (i.e. full soil depth 0-15cm measurements)

#decide what dataset to use
data.choice<-data_d 
```

_________________________________________________________________
# 0. Visualize data
```{r visualize, echo=FALSE}
source('CODE/script_visualize.R')
#saves the following plots:
#plot N variables - NMDS, PCA x plot points, site vectors
#all plot variables - NMDS, PCA x plot points, site vectors
#reference plot and site variables - NMDS, PCA
#saves the following tables:
#PCA loadings for plot N variables, all plot variablers, reference plot and site variables
```

_________________________________________________________________
# 1. Q1: Do soil N pools and fluxes shift in response to the presence of Microstegium? 
A. Do an ordination of soil N pools and fluxes and test the role of invasion status with permMANOVA
B. Investigate individual relationships using mixed effects models with year+site as a random effect and identify N variables that increase/decrease across sites.
```{r q1, echo=FALSE, message=FALSE, warning=FALSE}
nVars #variables in the analyses

source('CODE/script_q1A.R')
#saves table 'permMANOVA_q1.txt' #result of permMANOVA of the ordination given plot invasion status

source('CODE/script_q1B.R')
#B. Mixed effects models (soil N pool or flux value ~ inv + (1|siteYear))
#saves table 'meanSummary_q1.txt' #summary of individual soil N pools and fluxes by year and invasion status
#saves table 'summarySummary_q1.txt' #summary of individual mixed effect models for each soil N pool or flux
#saves table 'posthocSummary_q1.txt' #post-hoc comparisons among years and invasion status
#saves plot 'pScat_q1.png' #panels of soil N pool or flux ~ inv
```

_________________________________________________________________
# 2. Q2: Do reference plot conditions and/or Microstegium biomass predict impact magnitudes?
A. Calculate impact magnitude for each target variable (nitrate, nitrification, other variables detected in Q1 ordination)
B. Test the role of reference plot conditions and Microstegium biomass on impacts individually using mixed effects models with year as a random effect
```{r q2, echo=FALSE, message=FALSE, warning=FALSE}
##A. Calculate impact, prep dataset

#1. decide of difference variables
diffVars<-c('noi_T','noi_B','ammonifd_T','ammonifd_B','nitrifd_T','nitrifd_B','minzd_T','minzd_B')

#2. decide on what variables to include in the reference ordination
allVars
#allVars2 #without PercBA_AM
#allVars.AggPAR
#allVars2.AggPAR #without PercBA_AM
useThese_refVars<-allVars

#3. decide whether to include PercBA_AM as a separate parameter
#externalPercBA_AM<-'y'
externalPercBA_AM<-'n'

#4. prep dataset
source('CODE/script_q2_prep.R')
#View(data.q2)


##B. Run models for each of the following (Inv. - Ref): nitrate, nitrif, ammonif, minz 

#1. decide on model formulation
modelFormulaCode<-'PC1*PC2*Mv'
#modelFormulaCode<-'PC1+PC2+Mv'
#modelFormulaCode<-'PC1*PC2*AM*Mv'
#modelFormulaCode<-'PC1+PC2+AM+Mv'


#2. run models
source('CODE/script_q2.R')
PC1var.c.o
PC2var.c.o
mod.df[mod.df$pval<0.05,]

#look at other models

#reshape data.choice
data.T<-subset(data.choice, depth == 'T')
data.T1<-data.choice[data.choice$variable %in% c(allVars,'mv_g.m2'), 
                          c('plotid','plothalfid1','inv','year','variable','value')]
data.T1$variable<-factor(data.T1$variable, levels=c(allVars,'mv_g.m2'))
data.T1.wide<-dcast(data.T1, plotid + year ~ variable + inv, value.var='value')
df<-data.T1.wide

#nitrate
#reference
mod<-lmer(noi_T_N ~ nTrees_N + nitrifd_T_N + ph_T_N + soilmoi_T_N +
             (1|year), data=df)
summary(mod)
mod<-lmer(nitrifd_T_N ~ nTrees_N +
             (1|year), data=df)
summary(mod)
mod<-lmer(ph_T_N ~ nTrees_N +
             (1|year), data=df)
summary(mod)
mod<-lmer(soilmoi_T_N ~ nTrees_N + litter_g.m2_N +
             (1|year), data=df)
summary(mod)
mod<-lmer(litter_g.m2_N ~ nTrees_N +
             (1|year), data=df)
summary(mod)
#invaded
mod<-lmer(noi_T_I ~ nTrees_N + nitrifd_T_I + ph_T_I + soilmoi_T_I + mv_g.m2_I +
             (1|year), data=df)
summary(mod)
mod<-lmer(nitrifd_T_I ~ nTrees_N + mv_g.m2_I +
             (1|year), data=df)
summary(mod)
mod<-lmer(ph_T_I ~ nTrees_N + mv_g.m2_I +
             (1|year), data=df)
summary(mod)
mod<-lmer(soilmoi_T_I ~ nTrees_N + litter_g.m2_I + mv_g.m2_I +
             (1|year), data=df)
summary(mod)
mod<-lmer(litter_g.m2_I ~ nTrees_N + mv_g.m2_I +
             (1|year), data=df)
summary(mod)
## mv biomass
df$mv_g.m2_I_logt<-log(df$mv_g.m2_I+0.01)
mod<-lmer(mv_g.m2_I_logt ~ nTrees_N + noi_T_N + nitrifd_T_N + ph_T_N + soilmoi_T_N + litter_g.m2_N +
             (1|year), data=df)
summary(mod)

#ammonification
#reference
mod<-lmer(ammonifd_T_N ~ nTrees_N + nhi_T_N + som_T_N + ph_T_N + soilmoi_T_N +
             (1|year), data=df)
summary(mod)
mod<-lmer(nhi_T_N ~ nTrees_N +
             (1|year), data=df)
summary(mod)
mod<-lmer(som_T_N ~ nTrees_N +
             (1|year), data=df)
summary(mod)
mod<-lmer(ph_T_N ~ nTrees_N +
             (1|year), data=df)
summary(mod)
mod<-lmer(soilmoi_T_N ~ nTrees_N + litter_g.m2_N +
             (1|year), data=df)
summary(mod)
mod<-lmer(litter_g.m2_N ~ nTrees_N +
             (1|year), data=df)
summary(mod)
#invaded
mod<-lmer(ammonifd_T_I ~ nTrees_N + nhi_T_I + som_T_I + ph_T_I + soilmoi_T_I + mv_g.m2_I +
             (1|year), data=df)
summary(mod)
mod<-lmer(nhi_T_N ~ nTrees_N +mv_g.m2_I +
             (1|year), data=df)
summary(mod)
mod<-lmer(som_T_N ~ nTrees_N +mv_g.m2_I +
             (1|year), data=df)
summary(mod)
mod<-lmer(ph_T_N ~ nTrees_N +mv_g.m2_I +
             (1|year), data=df)
summary(mod)
mod<-lmer(soilmoi_T_N ~ nTrees_N + litter_g.m2_N + mv_g.m2_I +
             (1|year), data=df)
summary(mod)
mod<-lmer(litter_g.m2_N ~ nTrees_N + mv_g.m2_I +
             (1|year), data=df)
summary(mod)
#Mv biomass
mod<-lmer(mv_g.m2_I_logt ~ nTrees_N + ammonifd_T_N + nhi_T_N + som_T_N + 
            soilmoi_T_N + litter_g.m2_N +
             (1|year), data=df)
summary(mod)



#nitrate
modT<-lmer(noi_T ~ mv_g.m2_logt +  nTrees + litter_g.m2 +
             mv_g.m2_logt:nTrees + mv_g.m2_logt:litter_g.m2 + 
             (1|year), data=data.q2)
summary(modT)
meanVal<-mean(data.q2$litter_g.m2)
data.q2$litterBin<-'Low litter'
data.q2[data.q2$litter_g.m2>meanVal,'litterBin']<-'High litter'
data.q2$litterBin<-factor(data.q2$litterBin, levels=c('Low litter','High litter'))
ggplot(data.q2, aes(x=mv_g.m2_logt, y=noi_T)) + 
  geom_point() + facet_grid(~litterBin)

modB<-lmer(noi_B ~ mv_g.m2_logt +  nTrees + litter_g.m2 + 
             mv_g.m2_logt:nTrees + mv_g.m2_logt:litter_g.m2 + 
             (1|year), data=data.q2)
summary(modB)
meanVal<-mean(data.q2$litter_g.m2)
data.q2$litterBin<-'Low litter'
data.q2[data.q2$litter_g.m2>meanVal,'litterBin']<-'High litter'
data.q2$litterBin<-factor(data.q2$litterBin, levels=c('Low litter','High litter'))
ggplot(data.q2, aes(x=mv_g.m2_logt, y=noi_B)) + 
  geom_point() + facet_grid(~litterBin) 


#ammonification
modT<-lmer(ammonifd_T ~ mv_g.m2_logt + soilmoi_T + 
              mv_g.m2_logt:soilmoi_T +
             (1|year), data=data.q2)
summary(modT)
meanVal<-mean(data.q2$soilmoi_T)
data.q2$soilmoiBin<-'Low moisture'
data.q2[data.q2$soilmoi_T>meanVal,'soilmoiBin']<-'High moisture'
data.q2$soilmoiBin<-factor(data.q2$soilmoiBin, levels=c('Low moisture','High moisture'))
ggplot(data.q2, aes(x=mv_g.m2_logt, y=ammonifd_T, size=soilmoi_T)) + 
  geom_point() + facet_grid(~soilmoiBin) + geom_smooth(method='lm')

modT<-lmer(ammonifd_T ~ mv_g.m2_logt + soilmoi_T + PercBA_AM + 
              mv_g.m2_logt:soilmoi_T + PercBA_AM:soilmoi_T + mv_g.m2_logt:PercBA_AM +
             (1|year), data=data.q2)
summary(modT)

#3. make plots

####################################
#a. delta nitrate (inv-ref)
####################################
df.mod<-mod.noi[['df.mod.used']]
modT<-mod.noi[['modT']]

#set up PC2 levels
df.mod$factorLevel<-NA
lowLabel<-'Low light, many trees (PC2)'
highLabel<-'High light, few trees (PC2)'
df.mod[df.mod$PC2 >= quantile(df.mod$PC2)[1] & df.mod$PC2 < quantile(df.mod$PC2)[3],'factorLevel']<-lowLabel
df.mod[df.mod$PC2 >= quantile(df.mod$PC2)[3] & df.mod$PC2 <= quantile(df.mod$PC2)[5],'factorLevel']<-highLabel
df.mod$factorLevel<-factor(df.mod$factorLevel, levels=c(lowLabel, highLabel))

#plot: diff noi_T ~ Mvbiomass by PC2 levels
#prediction data frames ...
df.pred<-InteractionPlot_DF(n=100, xVar='mv_g.m2_logt', 
                            factorVar='PC2', factorBin='factorLevel', 
                            constantVar='PC1', 
                            df=df.mod, mod=modT)

#remove the year intercept
mod.coefs<-coef(modT)$year
int2012<-mod.coefs[1,1]
int2013<-mod.coefs[2,1]
int.Diff<-int2012 - int2013
df.mod$select.diffVarT.minusYr<-df.mod$select.diffVarT
df.mod[df.mod$year==2012,'select.diffVarT.minusYr']<-df.mod[df.mod$year==2012,'select.diffVarT'] - int.Diff

#plot
pScat.noiDiff_MvPC2<-ggplot(data=df.pred, 
                            mapping=aes(x=mv_g.m2_logt, 
                                        y=ypred.minusYr, 
                                        ymin=CI.lwr.minusYr, ymax=CI.upr.minusYr))  +  
  geom_ribbon(alpha=0.4) +
  geom_line() +
  facet_grid(~factorLevel) +
  geom_abline(intercept=0,slope=0, linetype=3, color='gray50') + 
  mytheme + ylab(expression(paste(Delta," Nitrate 0-5cm (Inv.-Ref.)"))) + xlab('Microstegium biomass (log g/m2)') + 
  geom_point(data=df.mod, aes(y=select.diffVarT.minusYr, ymin=NULL, ymax=NULL)) 
pScat.noiDiff_MvPC2
#save plots
newfilename<-"pScat_noiDiff.png"
png(paste(figuresPath,newfilename, sep='/'), units='in', 
    width = fig.width*2, height = fig.height*1.2, res=fig.res)
pScat.noiDiff_MvPC2 + guides(linetype=FALSE, fill=FALSE)
dev.off()


####################################
#b. delta ammonification (inv-ref)
####################################
df.mod<-mod.ammonifd[['df.mod.used']]
modT<-mod.ammonifd[['modT']]

#set up PC1 levels
df.mod$factorLevel<-NA
lowLabel<-'Low moisture & OM (PC1)'
highLabel<-'High moisture & OM (PC1)'
df.mod[df.mod$PC1 >= quantile(df.mod$PC1)[1] & df.mod$PC1 < quantile(df.mod$PC1)[3],'factorLevel']<-lowLabel
df.mod[df.mod$PC1 >= quantile(df.mod$PC1)[3] & df.mod$PC1 <= quantile(df.mod$PC1)[5],'factorLevel']<-highLabel
df.mod$factorLevel<-factor(df.mod$factorLevel, levels=c(lowLabel, highLabel))

#set up PC2 levels
df.mod$factorLevel2<-NA
lowLabel<-'Low light, more trees (PC2)'
highLabel<-'High light, few trees (PC2)'
df.mod[df.mod$PC2 >= quantile(df.mod$PC2)[1] & df.mod$PC2 < quantile(df.mod$PC2)[3],'factorLevel2']<-lowLabel
df.mod[df.mod$PC2 >= quantile(df.mod$PC2)[3] & df.mod$PC2 <= quantile(df.mod$PC2)[5],'factorLevel2']<-highLabel
df.mod$factorLevel2<-factor(df.mod$factorLevel2, levels=c(lowLabel, highLabel))

#plot: diff ammonif_T ~ Mvbiomass by PC1 levels
#prediction data frames ...
df.pred1<-InteractionPlot_DF(n=100, xVar='mv_g.m2_logt', 
                            factorVar='PC1', factorBin='factorLevel', 
                            constantVar='PC2', 
                            df=df.mod, mod=modT)

#remove the year intercept
mod.coefs<-coef(modT)$year
int2012<-mod.coefs[1,1]
int2013<-mod.coefs[2,1]
int.Diff<-int2012 - int2013
df.mod$select.diffVarT.minusYr<-df.mod$select.diffVarT
df.mod[df.mod$year==2012,'select.diffVarT.minusYr']<-df.mod[df.mod$year==2012,'select.diffVarT'] - int.Diff

#plot
pScat.ammonifdDiff_MvPC1<-ggplot(data=df.pred1, 
                                 mapping=aes(x=mv_g.m2_logt, 
                                             y=ypred.minusYr, 
                                             ymin=CI.lwr.minusYr, ymax=CI.upr.minusYr))  +  
  geom_ribbon(alpha=0.4) +
  geom_line() +
  facet_grid(~factorLevel) +
  geom_abline(intercept=0,slope=0, linetype=3, color='gray50') + 
  mytheme + ylab(expression(paste(Delta," Ammonif. 0-5cm (Inv.-Ref.)"))) + 
  xlab('Microstegium biomass (log g/m2)') + 
  geom_point(data=df.mod, aes(y=select.diffVarT.minusYr, ymin=NULL, ymax=NULL))
pScat.ammonifdDiff_MvPC1

#plot: diff ammonifd_T ~ PC2 by PC1 levels
#prediction data frames ...
df.pred2<-InteractionPlot_DF(n=100, xVar='PC2', 
                            factorVar='PC1', factorBin='factorLevel', 
                            constantVar='mv_g.m2_logt', 
                            df=df.mod, mod=modT)
pScat.ammonifdDiff_PC2PC1<-ggplot(data=df.pred2, 
                                  mapping=aes(x=PC2, 
                                              y=ypred.minusYr, 
                                              ymin=CI.lwr.minusYr, ymax=CI.upr.minusYr))  +  
  geom_ribbon(alpha=0.4) +
  geom_line() +
  facet_grid(~factorLevel) +
  geom_abline(intercept=0,slope=0, linetype=3, color='gray50') + 
  mytheme + ylab(expression(paste(Delta," Ammonif. 0-5cm (Inv.-Ref.)"))) + 
  xlab('PC2 (increasing light, decreasing trees)') + 
  geom_point(data=df.mod, aes(y=select.diffVarT.minusYr, ymin=NULL, ymax=NULL))
pScat.ammonifdDiff_PC2PC1

#save plots
newfilename<-'pScat.ammonifdDiff.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*2, height = fig.height*2.2, res=fig.res)
grid.arrange(pScat.ammonifdDiff_MvPC1 + guides(linetype=FALSE, fill=FALSE),
             pScat.ammonifdDiff_PC2PC1+ guides(linetype=FALSE, fill=FALSE))
dev.off()


```

_________________________________________________________________
# 3. Q3: Do reference plot conditions predict Microstegium biomass?
A. Do an ordination of reference conditions and test the relationship between Microstegium biomass and reference conditions using permMANOVA.
B. Investigate relationship between PC scores and Microstegium biomass using mixed effects models with year as a random effect.
```{r q3, echo=FALSE, message=FALSE, warning=FALSE}
#A. Do an ordination of reference conditions and test the relationship between Microstegium biomass and reference conditions using permMANOVA.

#i) Identify reference plot condition variables
useThese_refVars<-allVars
data.refVars<-data.choice[data.choice$variable %in% useThese_refVars, c('plotid','plothalfid1','inv','year','variable','value')]
data.refVars$variable<-factor(data.refVars$variable, levels=useThese_refVars)
data.refVars<-subset(data.refVars, inv == 'N')
data.refVars.wide<-dcast(data.refVars, plotid + year ~ variable, value.var='value')
data.refVars.wide$plotYear<-paste(data.refVars.wide$plotid, data.refVars.wide$year, sep="_")
data.q3<-data.refVars.wide

#2) Ordinate reference conditions
data.q3.rm<-data.q3[!rowSums(is.na(data.q3))>0,]
tmp<-data.q3.rm[,useThese_refVars]
colnames(tmp)<-useThese_refVars
#cor(tmp) #look at correlation matrix
row.names(tmp)<-data.q3.rm$plotYear
tmp.scaled<-scale(tmp)
PCA.res<-prcomp(tmp.scaled)
pPCA_q3<-ggbiplot_custom(pcobj=PCA.res, df=data.q3.rm) #saved in 'script_visualize.R'
pPCA_q3
df.PCA<-data.frame(plotYear=row.names(PCA.res$x), PCA.res$x)

#add Mv biomass to dataset
colnames(data.mvVar.wide) #from 'script_q2_prep.R'
data.mvVar.wide$plotYear<-paste(data.mvVar.wide$plotid, data.mvVar.wide$year, sep="_")
data.q3.PCA<-merge(data.mvVar.wide, df.PCA[,c(1:3)])

#3) Do reference area and plot characteristics explain variation in Mv biomass? - perMANOVA on mv biomass
perMANOVA<-adonis(tmp.scaled ~ mv_g.m2, data = data.q3.PCA, method='eu')
aov.tab.permanova<-data.frame(perMANOVA$aov.tab)
aov.tab.permanova
#save anova table
newfilename<-'permMANOVA_q3.txt'
write.table(aov.tab.permanova, file=paste(figuresPath,newfilename, sep='/'), sep='\t')


#B. Do PC scores from the reference condition ordination predict mv biomass?
#1) Fit model
data.q3.PCA$year<-factor(data.q3.PCA$year)
df.mod<-data.q3.PCA
df.mod$PC2_neg1<-df.mod$PC2*-1

#If PercBA_AM should be included separately from reference conditions...Identify PercBA_AM and merge it into dataset
#externalPercBA_AM
if(externalPercBA_AM == 'y'){
  
  #merge
  df.mod<-merge(df.mod, data.AM.wide)

  #make a bin for %AM
  df.mod$MycBin<-NA
  df.mod[df.mod$PercBA_AM >=0 & df.mod$PercBA_AM <50,'MycBin']<-'AM'
  df.mod[df.mod$PercBA_AM >=50 & df.mod$PercBA_AM <=100,'MycBin']<-'ECM'
  
  mod<-lmer(mv_g.m2_logt~PC1*PC2*MycBin + (1|year), data=df.mod)
}else{
  mod<-lmer(mv_g.m2_logt~PC1*PC2_neg1 + (1|year), data=df.mod)
}
summary(mod)$coefficients
#save anova table
newfilename<-'summaryTable_q3.txt'
write.table(summary(mod)$coefficients, file=paste(figuresPath,newfilename, sep='/'), sep='\t')

#2) Plot
#set up prediction dataframes
df.pred<-XYPlot_DF(n=100, xVar='PC2_neg1', constantVar='PC1', df=df.mod, mod=mod)

#remove the year intercept
mod.coefs<-coef(mod)$year
int2012<-mod.coefs[1,1]
int2013<-mod.coefs[2,1]
int.Diff<-int2012 - int2013
df.mod$mv_g.m2_logt.minusYr<-df.mod$mv_g.m2_logt
df.mod[df.mod$year==2012,'mv_g.m2_logt.minusYr']<-df.mod[df.mod$year==2012,'mv_g.m2_logt'] - int.Diff

#plot
pScat.Mv_PC2<-ggplot(data=df.pred, 
                     mapping=aes(x=PC2_neg1, 
                                 y=ypred.minusYr, 
                                 ymin=CI.lwr.minusYr, ymax=CI.upr.minusYr))  +  
  geom_ribbon(alpha=0.4) +
  geom_line() +
  mytheme + ylab('Microstegium biomass (log g/m2)') + xlab('PC2*-1\n(increasing light, decreasing trees)') + 
  geom_point(data=df.mod, aes(y=mv_g.m2_logt.minusYr, ymin=NULL, ymax=NULL))
pScat.Mv_PC2

#save plot
newfilename<-'pScat_q3.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', 
    width = fig.width*1, height = fig.height*1.05, res=fig.res)
pScat.Mv_PC2
dev.off()

```

_________________________________________________________________
# 4. Q4: What is the relative importance of reference conditions on impact - direct and indirectly
```{r q4, echo=FALSE, message=FALSE, warning=FALSE}

#Model 1
#1. prep dataframe
df.mod<-mod.ammonifd[['df.mod.used']]
df.full<-merge(df.mod, data.q2)
diffVarShort<-'ammonifd_T'
select.diffVar<-paste('Diff',diffVarShort, sep='_')
selectCols<-c('plotYear','year','mv_g.m2_logt',select.diffVar,'PC1','PC2')
df<-df.full[,selectCols]
colnames(df)
colnames(df)<-c('plotYear','year','mv','impact','PC1','PC2')

#2. look at dataset
pairs(df)

#3. load libraries
library(car) #Anova()
library(QuantPsyc) #lm.beta()

#4.SEM
#a. fit the pieces
Mv_LM<-lm(mv ~ PC1 + PC2, data=df)
Imp_LM<-lm(impact ~ mv + PC1 + PC2, data=df)

#b. evaluate the pieces
Anova(Mv_LM) #PC2 is signif
Anova(Imp_LM) #Mv is signif

#c. standardized coefficients & r^2
lm.beta(Mv_LM) 
lm.beta(Imp_LM)
summary(Mv_LM)$r.squared
summary(Imp_LM)$r.squared

library(semPlot)
semPaths(Mv_LM+Imp_LM, layout="tree", "std", intercepts=FALSE)


########

#Model 2

#1. prep dataframe
allVars

variables<-allVars

data.vars<-data.choice[data.choice$variable %in% variables, c('plotid','plothalfid1','inv','year','variable','value')]

data.vars$variable<-factor(data.vars$variable, levels=variables)
data.vars.wide<-dcast(data.vars, plothalfid1 + plotid + inv+ year ~ variable, value.var='value')
View(data.vars.wide)

data.vars.wide$plotInvYear<-paste(data.vars.wide$plothalfid1, data.vars.wide$year, sep="_") #use this to identify rows
data.vars.wide$plotYear<-paste(data.vars.wide$plotid, data.vars.wide$year, sep="_") #use this to block by plotid*year
row.names(data.vars.wide)<-data.vars.wide$plotInvYear

NonValCols<-c('plothalfid1','plotid','plotInvYear', 'plotYear','inv','year')
ValCols<-colnames(data.vars.wide)[!(colnames(data.vars.wide) %in% NonValCols)]
  
  if(refOnly=='y'){
    data.vars.wide<-data.vars.wide[data.vars.wide$inv=='N',]
  }

  data.vars.wide.rm<-data.vars.wide[!rowSums(is.na(data.vars.wide))>0,] #remove rows with missing data
  df.ord<-data.vars.wide.rm[,ValCols]
  colnames(df.ord)<-variableNames
  
  corel<-cor(data.vars.wide.rm[,ValCols]) #look at correlation matrix
  
  results<-list(df.ord=df.ord, corel=corel, 
                NonValCols=NonValCols, ValCols=ValCols, 
                data.vars.wide.rm=data.vars.wide.rm)









#2. look at dataset
pairs(df)



```

_________________________________________________________________
# Trends over time
a. Does Microstegium biomass increase over time?
b. Do soil N pools and fluxes in reference (and invaded) plots shift over time?
c. Do impact magnitudes shift over time?
d. Does the influence of reference conditions on Microstegium biomass shift over time?

_________________________________________________________________
# Invasion front study design
a. What environmental factors besides soil N pools and fluxes differ among paired invaded and reference plots?
```{r extra, echo=FALSE, message=FALSE, warning=FALSE}

##############
#A. Do an ordination of all environmental variables by plot - this is already in 'script_visualize.R'
##############


##############
#B. Investigate individual relationships using mixed effects models with year+site as a random effect.
##############

#0) set up dataframe
plotVars
data.plotVars<-data.choice[data.choice$variable %in% plotVars, c('plotid','plothalfid1','inv','year','variable','value')]
data.plotVars$variable<-factor(data.plotVars$variable, levels=plotVars)
data.plotVars.wide<-dcast(data.plotVars, plothalfid1 + plotid + inv + year ~ variable, value.var='value')
data.plotVars.wide$plotInvYear<-paste(data.plotVars.wide$plothalfid1, 
                                      data.plotVars.wide$year, sep="_") #use this to identify rows
data.plotVars.wide$plotYear<-paste(as.character(data.plotVars.wide$plotid), 
                                   data.plotVars.wide$year, sep="_") #use this to block by plotid*year

#1) Run models
result<-InvEffect(Yvars=plotVars, YvarNames=plotVarNames, df=data.plotVars.wide)

#2) Calculate means and save
data.plotVars.long<-melt(data.plotVars.wide, measure.vars=plotVars, id.vars = c('inv','year','plotid'))
meanSummary<-ddply(data.plotVars.long, ~variable+inv, summarize,
                   mean=mean(value, na.rm=TRUE),
                   n=sum(!is.na(value)),
                   se=sd(value, na.rm=TRUE)/sqrt(n))
meanSummary[,c('mean','se')]<-round(meanSummary[,c('mean','se')], digits=2)
colnames(meanSummary)[colnames(meanSummary) == 'variable']<-'vars'
meanSummary
newfilename<-'meanSummary_plotVars.txt'
write.table(meanSummary, file=paste(figuresPath,newfilename, sep='/'), sep='\t')

#3) Save coefficient and anova summary tables
newfilename<-'summarySummary_plotVars.txt'
write.table(data.frame(result[['summarySummary']]), file=paste(figuresPath,newfilename, sep='/'), sep='\t')
#data.frame(result[['posthocSummary']])
newfilename<-'posthocSummary_plotVars.txt'
write.table(data.frame(result[['posthocSummary']]), file=paste(figuresPath,newfilename, sep='/'), sep='\t')

#4) Plot
#i) prep dataframe and params
meanSummary.pretty<-merge(meanSummary,plotVars.indx)
meanSummary.pretty<-orderBy(~basic.vars.order+var.depth, meanSummary.pretty)
meanSummary.pretty$basic.varNames.units<-factor(meanSummary.pretty$basic.varNames.units, levels = unique(meanSummary.pretty$basic.varNames.units))
meanSummary.pretty$depth<-factor(meanSummary.pretty$depth, levels=c('T','B','NA'))
limits <- aes(ymax = mean + se, ymin=mean - se)
meanSummary.pretty$name<-meanSummary.pretty$basic.varNames.units
meanSummary.pretty$name2 <- factor(meanSummary.pretty$name,
                                   levels=c(levels(meanSummary.pretty$name)[1:2],'',
                                            levels(meanSummary.pretty$name)[3:11]))

p<-ggplot(meanSummary.pretty, aes(x=inv, y=mean, linetype=depth, group=depth)) +
  geom_point(size=3) + ylab(NULL) + xlab('Plot type') +
  geom_errorbar(limits, width=0.2) + geom_line() + 
  facet_wrap(~name2, scales='free_y', ncol=3, drop=FALSE) + mytheme +
  scale_linetype_discrete(name='Soil depth',labels=c('0-5cm','5-15cm')) +
  scale_x_discrete(labels=c('Invaded','Reference'))
p

g <- ggplotGrob(p )
## remove empty panels
g$grobs[names(g$grobs) %in% c("panel3","strip_t3","axis_l3")] <- NULL
## remove them from the layout
g$layout <- g$layout[!(g$layout$name %in% c("panel-3","strip_t-3","axis_l-3")),]

## plot
grid.newpage()
grid.draw(g)
newfilename<-'pScat_plotVars.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*3.5, height = fig.height*4, res=fig.res)
grid.newpage()
grid.draw(g)
dev.off()
```

_________________________________________________________________
# %AM
a. Does Microstegium biomass vary with %AM?
b. Does %AM vary with multivariate soil N conditions in reference plots?









