---
title: 'E8: Part1'
author: "Marissa Lee"
date: "October 23, 2015"
output: pdf_document
---

**Filename: E8_1.Rmd'**
**This markdown file does the following tasks:**
0. Clean and merge
1. Q1: How does invader biomass vary across resource availability in the reference plots?

```{r libraries, echo=TRUE}
knitr::opts_chunk$set(cache=TRUE)

library(plyr)
library(reshape2)
library(ggplot2) #plotting
library(ggthemes) #ggplot accessories
library(GGally) #????
library(gridExtra) #for grid.arrange fxn
library(lme4) #for mixed-effects models
library(lmerTest) #for lmer p-values
library(ggbiplot) #for pretty biplots
library(vegan) #for adonis fxn to do perMANOVAs
library(lavaan) #for structural equation modeling
source('CODE/fxn_ggbiplot_q1.R')
source('CODE/mytheme.R')
source('CODE/fxn_FitPlot.R')

figuresPath<-file.path(getwd()[1], "FIGURES_TABLES") #where to put the saved plots
fig.height<-2.5 #inches
fig.width<- 2.5 #inches
fig.res<-300

synthdataPath<-file.path(getwd()[1], "DATA", "DATA_SYNTHESIZED") #where to put the clean dataframes

soilData<-read.table("DATA/e8_plothalfSoilData.txt", header=TRUE, sep="\t", stringsAsFactors = FALSE)
vegData<-read.table("DATA/e8_plothalfVegData.txt", header=TRUE, sep="\t", stringsAsFactors = FALSE)
plotLoc<-read.table("DATA/e8_plotLoc.txt", header=TRUE, sep="\t", stringsAsFactors = FALSE)
plotTrees<-read.table("DATA/e8_plotTrees.txt", header=TRUE, sep="\t", stringsAsFactors = FALSE)

soilData.dict<-read.table("DATA/e8_plothalfSoilData_dictionary.txt", header=TRUE, sep="\t", stringsAsFactors = FALSE)
vegData.dict<-read.table("DATA/e8_plothalfVegData_dictionary.txt", header=TRUE, sep="\t", stringsAsFactors = FALSE)
plotLoc.dict<-read.table("DATA/e8_plotLoc_dictionary.txt", header=TRUE, sep="\t", stringsAsFactors = FALSE)
plotTrees.dict<-read.table("DATA/e8_plotTrees_dictionary.txt", header=TRUE, sep="\t", stringsAsFactors = FALSE)
timeline<-read.table("DATA/e8_timeline.txt", header=TRUE, sep="\t", stringsAsFactors = FALSE)

```

_________________________________________________________________
# 0. Clean and merge
Add identifiers, remove extra columns, merge raw datasets
Deal with soil N data in years where 0-5cm and 5-15cm layers were measured separately.  
```{r merge, echo=TRUE, message=FALSE, warning=FALSE}
##############
#A. Clean and merge
##############

# SOIL DATA
soilData$plothalfid1<-paste(soilData$inv,soilData$plotid, sep="_") #add new identifiers
removeCols<-c('plothalfid','site','rep') #prune columns
soilData.pruned<-soilData[,!colnames(soilData) %in% removeCols]
#reshape so that each depth x meas has its own column
soilData_melted <- melt(soilData.pruned,
                        id.vars=c("plotid","plothalfid1",
                                  "inv","depth","year"),
                        variable.name = "measCat")
soilData_melted$measCat2<-paste(soilData_melted$measCat, soilData_melted$depth, sep = '_')
soilData_cast <- dcast(soilData_melted, plotid + plothalfid1 + inv + year ~ measCat2, value.var="value")
soilData_c<-soilData_cast 

# VEG DATA
vegData$plothalfid1<-paste(vegData$inv,vegData$plotid, sep="_") #add new identifiers
vegData.pruned<-vegData[,!colnames(vegData) %in% removeCols] #prune columns
vegData.pruned$total<-vegData.pruned$mv+vegData.pruned$nat #make a total understory biomass variable
vegData.dict[c(2,4),c('v7','v8','v9')]
paste('Dry biomass values are currently in units of g/.1875m2')
ConvertBiom<-function(currVal){newVal <- currVal / 0.1875}
vegData.pruned$mv_g.m2<-ConvertBiom(vegData.pruned$mv)
vegData.pruned$nat_g.m2<-ConvertBiom(vegData.pruned$nat)
vegData.pruned$litter_g.m2<-ConvertBiom(vegData.pruned$litter)
vegData.pruned$total_g.m2<-ConvertBiom(vegData.pruned$total)
colsOldUnits<-c('mv','nat','litter','total')
vegData_c<-vegData.pruned[,!colnames(vegData.pruned) %in% colsOldUnits] #prune columns

#add vegData
soilVegData<-merge(soilData_c, vegData_c) #merge soilData_cast and vegData

# TREE DATA
plotTrees$basalArea.m2<-(plotTrees$dbh * plotTrees$dbh) * 0.00007854 #calculate basal area/m2 from each tree's dbh value
#summarize the total basal area/m2 per plot and that which is made up by either AM- or ECM-associated trees
plotTrees.summ<-ddply(plotTrees, ~plotid, summarize,
                      nTrees=length(plotid),
                      BA_total=sum(basalArea.m2, na.rm=T),
                      BA_AM=sum(basalArea.m2[myc=='A'], na.rm=T),
                      BA_ECM=sum(basalArea.m2[myc=='E'], na.rm=T),
                      PercBA_AM=(BA_AM/BA_total)*100,
                      PercBA_ECM=(BA_ECM/BA_total)*100)
#update the number of trees (there was a cell that was counted even for plots where there were no trees
plotTrees.summ[plotTrees.summ$plotid %in% c(12,15),'nTrees']<-0
plotTrees.summ[plotTrees.summ$plotid %in% c(12,15),c('PercBA_AM','PercBA_ECM')]<-NA
tmp<-plotTrees.summ[,c('plotid','nTrees','BA_total','PercBA_AM')]
trees_c<-tmp

#add tree data 
data<-merge(soilVegData, trees_c) 

#get rid of the plots without trees
data<-data[data$nTrees != 0,]
#str(data)


##############
#B. Deal with soil N data in years where 0-5cm and 5-15cm layers were measured separately 
##############
# Plot histogram of values by depth

#subset by year
data.1213<-subset(data, year %in% c(2012, 2013))

#reshape
data.1213_melted <- melt(data.1213,id.vars=c("plotid","plothalfid1","inv","year"))
data.1213_melted$value<-as.numeric(data.1213_melted$value)

#subset by _B and _T
data.1213_melted_soilVars<-data.1213_melted[grepl("_B",data.1213_melted$variable) | grepl("_T",data.1213_melted$variable),]

#add back the separate measCat and depth columns
tmp<-ldply(strsplit(as.character(data.1213_melted_soilVars$variable),"_", fixed=T))
colnames(tmp)<-c('measCat','depth')
data.1213_melted_soilVars<-cbind(data.1213_melted_soilVars, tmp)

#correct the dataframe structure
data.1213_melted_soilVars$measCat<-factor(data.1213_melted_soilVars$measCat, levels=measCat_order)
data.1213_melted_soilVars$depth<-factor(data.1213_melted_soilVars$depth, levels=depth_order)
data.1213_melted_soilVars$inv<-factor(data.1213_melted_soilVars$inv, levels=inv_order)

#plot
pHist.depth<-ggplot(data.1213_melted_soilVars, aes(x=value, fill=depth)) + 
  geom_bar() + mytheme + facet_wrap(measCat~year, scales='free') +
  ggtitle("Histogram of soil measurement values by soil depth and year")
pHist.depth  

#save plot
newfilename<-'pHist_depth.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*4, height = fig.height*4, res=fig.res)
pHist.depth
dev.off()


##############
#C. DATASET A : Aggregate values, put aggregated values into full dataset and replace empty _F rows
##############

#aggregate by depth
summ.data.1213_melted_soilVars<-ddply(data.1213_melted_soilVars, ~plotid+plothalfid1+inv+year+measCat, summarize,
                      new.value=mean(value, na.rm=T),
                      n=length(plothalfid1),
                      note='aggregated by depth')

#make a dataset without the dis-aggregated data
data_melted <- melt(data,id.vars=c("plotid","plothalfid1","inv","year")) #melt down the full dataset, including 2011 data
data_melted$value<-as.numeric(data_melted$value) #make values numeric again
uniqWo.B<-unique(data_melted$variable)[!grepl("_B",unique(data_melted$variable))] #isolate only the variables that do NOT included the non-aggregated data
uniqWo.BT<-uniqWo.B[!grepl("_T",uniqWo.B)] #ditto
data_m_woBT<-data_melted[data_melted$variable %in% uniqWo.BT,] #subset data by 'correct' variables
selectvars<-unique(data_m_woBT$variable)[grepl("_F",unique(data_m_woBT$variable))] #select measCat variables with "_F"
data_m_woBT_e<-data_m_woBT[!(data_m_woBT$year %in% c(2012,2013) & data_m_woBT$variable %in% selectvars), ] #remove rows without data because it has not yet been aggregated
data_m_woBT_e$note<-NA

#make a dataset with the correctly-aggregated data and comparable column names to data_m_woBT
summ.data.1213_melted_soilVars<-rename(summ.data.1213_melted_soilVars, replace=c("new.value" = "value")) #rename new.value -> value
summ.data.1213_melted_soilVars$variable<-paste(summ.data.1213_melted_soilVars$measCat, '_F',sep="")#measCat items should be ammended with '_F' to indicate that the values are representative of the full soil core depth... put this in a new column called 'variable'
summ.data.1213_melted_soilVars<-summ.data.1213_melted_soilVars[,c('plotid','plothalfid1','inv','year','variable','value','note')]#get rid of 'n' and 'measCat' columns

#merge
data_a<-rbind(data_m_woBT_e, summ.data.1213_melted_soilVars)
#ddply(data_a, ~year+variable, summarize, n=length(plotid)) #check the dataframe structure
#ddply(data_a, ~inv+variable, summarize, n=length(plotid)) #check the dataframe structure

#add a column that categorizes the variable types
data_a$varType<-NA
data_a[grepl("_F", data_a$variable),'varType']<-'measCat'
data_a[data_a$variable %in% c('mv_g.m2','nat_g.m2','litter_g.m2','total_g.m2'),'varType']<-'understoryBiom'
data_a[data_a$variable %in% c('percpar','soiltemp','soilBasin'),'varType']<-'environParam'
data_a[data_a$variable %in% c('nTrees','BA_total','PercBA_AM'),'varType']<-'overstoryParam'

#add a column that identifies whether the variable type is measured on the plot half or the plot level
plotlevel.vars<-c('soilBasin','nTrees','BA_total','PercBA_AM')
plothalflevel.vars<-unique(data_a$variable)[!unique(data_a$variable) %in% plotlevel.vars]
data_a$measLevel<-NA
data_a[data_a$variable %in% plotlevel.vars,'measLevel']<-'plot'
data_a[data_a$variable %in% plothalflevel.vars,'measLevel']<-'plothalf'

#Ammend variable names with "_N" or "_I" depending on the plothalf
data_a$variable1<-paste(data_a$variable, data_a$inv, sep="_")
data_a[data_a$measLevel=='plot','variable1']<-as.character(data_a[data_a$measLevel=='plot','variable'])

#save and export
newfilename<-'data_a.txt'
write.table(data_a, file=paste(synthdataPath,newfilename, sep='/'), sep='\t')


##############
#D. DATASET D : Keep 2012 and 2013 values dis-aggregated and remove 2011 _F values, remove biomass values from 2011 since time point was past peak biomass
##############
#start with data.1213_melted
data_d<-data.1213_melted[!grepl("_F", data.1213_melted$variable),] #remove variables that were only measured in 2011
data_d<-data_d[data_d$variable != 'soiltemp',] #remove variables that were only measured in 2011

#add a column that categorizes the depth types
data_d$depth<-NA
data_d[grepl("_B", data_d$variable),'depth']<-'B'
data_d[grepl("_T", data_d$variable),'depth']<-'T'

#add a column that categorizes the variable types
data_d$varType<-NA
data_d[grepl("_B", data_d$variable),'varType']<-'measCat'
data_d[grepl("_T", data_d$variable),'varType']<-'measCat'
data_d[data_d$variable %in% c('mv_g.m2','nat_g.m2','litter_g.m2','total_g.m2'),'varType']<-'understoryBiom'
data_d[data_d$variable %in% c('percpar'),'varType']<-'environParam'
data_d[data_d$variable %in% c('nTrees','BA_total','PercBA_AM'),'varType']<-'overstoryParam'

#add a column that identifies whether the variable type is measured on the plot half or the plot level
plotlevel.vars<-c('nTrees','BA_total','PercBA_AM')
plothalflevel.vars<-unique(data_d$variable)[!unique(data_d$variable) %in% plotlevel.vars]
data_d$measLevel<-NA
data_d[data_d$variable %in% plotlevel.vars,'measLevel']<-'plot'
data_d[data_d$variable %in% plothalflevel.vars,'measLevel']<-'plothalf'

#Ammend variable names with "_N" or "_I" depending on the plothalf
data_d$variable1<-paste(data_d$variable, data_d$inv, sep="_")
data_d[data_d$measLevel=='plot','variable1']<-as.character(data_d[data_d$measLevel=='plot','variable'])

#save and export
newfilename<-'data_d.txt'
write.table(data_d, file=paste(synthdataPath,newfilename, sep='/'), sep='\t')


#######
# DATA CHOICE : decide which dataset to use
data.choice<-data_a
data.choice<-subset(data.choice, year != 2011)
#######

```

_________________________________________________________________
# 1. Q1: Do soil N pools and fluxes shift in response to the presence of Microstegium? 
A. Do an ordination of soil N pools and fluxes.
B. Test the role of invasion status with permMANOVA
C. Investigate individual relationships using mixed effects models with year+site as a random effect.
D. Identify N variables that increase/decrease across sites.
```{r q1, echo=TRUE, message=FALSE, warning=FALSE}

##############
#A. Do an ordination of soil N pools and fluxes.
##############

#1) Name the plot variable to ordinate
vars<-c('nhi_F','noi_F','ammonifd_F','nitrifd_F','minzd_F') #make vector of terms
varNames<-c('NH4+','NO3-','Ammonif.','Nitrif.','Mineraliz.')

#2) Subset and reshape
data.vars<-data.choice[data.choice$variable %in% vars, c('plotid','plothalfid1','inv','year','variable','value')]
data.vars$variable<-factor(data.vars$variable, levels=vars)
data.vars.wide<-dcast(data.vars, plothalfid1 + inv+ year ~ variable, value.var='value')
data.vars.wide$plotInvYear<-paste(data.vars.wide$plothalfid1, data.vars.wide$year, sep="_") #use this to identify rows
data.vars.wide$plotYear<-paste(data.vars.wide$plotid, data.vars.wide$year, sep="_") #use this to block by plotid*year
row.names(data.vars.wide)<-data.vars.wide$plotInvYear
NonValCols<-c('plothalfid1','plotInvYear', 'plotYear','inv','year')
ValCols<-colnames(data.vars.wide)[!(colnames(data.vars.wide) %in% NonValCols)]

#3) Remove rows with missing data and look at correlation matrix
data.vars.wide.rm<-data.vars.wide[!rowSums(is.na(data.vars.wide))>0,]
cor(data.vars.wide.rm[,ValCols])

#4) Ordinate and save plot
df.ord<-data.vars.wide.rm[,ValCols]
colnames(df.ord)<-varNames
df.ord.scaled<-scale(df.ord)
PCA.res<-prcomp(df.ord.scaled)
data.PCA<-data.frame(plotInvYear=rownames(PCA.res$x), PCA.res$x)
data.vars.PCA<-merge(data.vars.wide.rm, data.PCA[,c(1:3)]) #add Mv biomass to this dataframe
data.vars.PCA$plotid<-ldply(strsplit(data.vars.PCA$plothalfid1, "_", fixed=TRUE))$V2
data.vars.PCA$year<-factor(data.vars.PCA$year)

#make plot
plots<-ggbiplot_q1(pcobj=PCA.res, df=data.vars.PCA)
plots[['pBasic']]
newfilename<-'pPCA_invPlot.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*2, height = fig.height*2, res=fig.res)
plots[['pBasic']]
dev.off()


##############
#B. Test the role of invasion status with permMANOVA
##############
plots[['pEllipseIN']]
sum(rownames(data.vars.wide.rm) != rownames(df.ord.scaled)) # if this is 0, then rownames match
permMANOVA<-adonis(df.ord.scaled ~ inv, data = data.vars.wide.rm, method='eu')
aov.tab.permmanova<-data.frame(permMANOVA$aov.tab)
aov.tab.permmanova
newfilename<-'permMANOVA_invPlot.txt'
write.table(aov.tab.permmanova, file=paste(figuresPath,newfilename, sep='/'), sep='\t')


##############
#C. Investigate individual relationships using mixed effects models with year+site as a random effect.
##############

#1) Make a fxn to run the models with invasion status predicting different y variables

InvEffect<-function(Yvars, YvarNames, df){
  
  summary.list<-list()
  posthoc.list<-list()
  anova.list<-list()
  figure.list<-list()
  i<-0
  for(i in 1:length(Yvars)){
    
    curr.Yvar<-Yvars[i]
    y<-df[,curr.Yvar]
    
    #regression model
    mod<-lmer(y~inv*year + (1|plotid), data=df)
    summary.list[[i]]<-summary(mod)
    anova.list[[i]]<-anova(mod)
    
    #post-hoc tests
    posthoc.list[[i]]<-difflsmeans(mod)$diffs.lsmeans.table
  
    #plot
    df$year<-factor(df$year)
    p<-ggplot(df, aes_string(x='inv', y=curr.Yvar, color='year')) + geom_boxplot() + 
      mytheme + xlab(NULL) + ylab(NULL) + ggtitle(YvarNames[i]) + guides(color=FALSE)
    figure.list[[i]]<-p
  }
  names(posthoc.list)<-Yvars
  names(summary.list)<-Yvars
  names(anova.list)<-Yvars
  names(figure.list)<-Yvars
  
  #posthoc summary
  posthocSummary<-ldply(lapply(posthoc.list, data.frame))
  posthocSummary[,-1]<-round(posthocSummary[,-1], digits=4)
  posthocSummary<-rename(posthocSummary, c(.id='yVar'))
  posthocSummary$terms<-unlist(lapply(posthoc.list, row.names))
  
  #summary summary
  summarySummary<-ldply(lapply(summary.list, 'coefficients'))
  summarySummary[,-1]<-round(summarySummary[,-1], digits=4)
  summarySummary<-rename(summarySummary, c(.id='yVar'))
  summarySummary$terms<-unlist(lapply(lapply(summary.list, 'coefficients'), row.names))
  
  #anova summary
  anovaSummary<-ldply(lapply(anova.list, data.frame))
  anovaSummary[,-1]<-round(anovaSummary[,-1], digits=4)
  anovaSummary<-rename(anovaSummary, c(.id='yVar', Pr..F.='pValue'))
  anovaSummary$terms<-unlist(lapply(anova.list, row.names))
  
  results<-list(summarySummary=summarySummary, posthocSummary=posthocSummary,
                anovaSummary=anovaSummary, figures=figure.list)
  return(results)
}

#2) Run models
Yvars<-c('nhi_F','noi_F','ammonifd_F','nitrifd_F','minzd_F')
YvarNames<-c('Ammonium (ug/G)','Nitrate (ug/G)','Ammonification (ug/G*d)','Nitrification (ug/G*d)','Mineralization (ug/G*d)')
result<-InvEffect(Yvars=Yvars, YvarNames=YvarNames, df=data.vars.PCA)
  
#3) Calculate means and save
data.vars.PCA.long<-melt(data.vars.PCA, measure.vars=c('nhi_F','noi_F','ammonifd_F','nitrifd_F','minzd_F'), id.vars = c('inv','year','plotid'))
meanSummary<-ddply(data.vars.PCA.long, ~variable+inv+year, summarize,
                   mean=mean(value),
                   n=length(value),
                   se=sd(value)/sqrt(n))
meanSummary[,c('mean','se')]<-round(meanSummary[,c('mean','se')], digits=2)
newfilename<-'meanSummary_inv.txt'
write.table(meanSummary, file=paste(figuresPath,newfilename, sep='/'), sep='\t')

#3) Save coefficient and anova summary tables
data.frame(result[['summarySummary']])
newfilename<-'summarySummary_inv.txt'
write.table(data.frame(result[['summarySummary']]), file=paste(figuresPath,newfilename, sep='/'), sep='\t')
data.frame(result[['posthocSummary']])
newfilename<-'posthocSummary_inv.txt'
write.table(data.frame(result[['posthocSummary']]), file=paste(figuresPath,newfilename, sep='/'), sep='\t')
data.frame(result[['anovaSummary']])
newfilename<-'anovaSummary_inv.txt'
write.table(data.frame(result[['anovaSummary']]), file=paste(figuresPath,newfilename, sep='/'), sep='\t')

#4) Plot
meanSummary$variable<-mapvalues(meanSummary$variable, from=Yvars, to=YvarNames)
limits <- aes(ymax = mean + se, ymin=mean - se)
p<-ggplot(meanSummary, aes(x=year, y=mean, group=inv, linetype=inv, shape=inv)) + 
  geom_line() + geom_point() + geom_errorbar(limits, width=0.2) + 
  facet_wrap(~variable, scale='free', ncol=2) + 
  mytheme + xlab('Year') + ylab('Plot value') + 
  scale_linetype_discrete(name='Invasion status') + scale_shape_manual(name='Invasion status', values=c(16,1))
newfilename<-'pScat_inv.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*2, height = fig.height*2.5, res=fig.res)
p
dev.off()

##############
#D. Identify N variables that increase/decrease across sites.
##############
data.frame(result[['posthocSummary']])
paste('Net potential ammonification is higher in the invaded plots in the second year. In other words, more ammonium is being released than immobilized on average.')
paste('Although net ammonification is higher in invaded plots, ammonium pools do not differ.  This may be because (1) this is an ammonification potential measure and/or (2) plant uptake is a strong control on standing ammonium pools')

```

_________________________________________________________________
# 2. Q2: Do reference plot conditions and/or Microstegium biomass predict impact magnitudes?
A. Calculate impact magnitude for each target variable (nitrate, nitrification, other variables detected in Q1 ordination)
B. Test the role of reference plot conditions and Microstegium biomass on impacts individually using mixed effects models with year as a random effect
```{r q2, echo=TRUE, message=FALSE, warning=FALSE}

##############
#A. Calculate impact magnitude for each target variable (nitrate, nitrification, ammonification)
##############

#reshape dataframe
data.vars.wideIN <- dcast(data.vars, plotid + year + variable ~ inv, value.var="value")

#calculate diff
data.vars.wideIN$Diff<-data.vars.wideIN$I - data.vars.wideIN$N

#subset select diff variables and reshape
diffVars<-c('noi_F','nitrifd_F','ammonifd_F')
data.diffVars<-data.vars.wideIN[data.vars.wideIN$variable %in% diffVars, c('plotid','year','variable','Diff')]
data.diffVars.wide<-dcast(data.diffVars, plotid + year ~ variable, value.var='Diff')
colnames(data.diffVars.wide)[-c(1:2)]<-paste('Diff', colnames(data.diffVars.wide)[-c(1:2)], sep="_")


##############
#B. Test the role of reference plot conditions and Microstegium biomass on impacts individually using mixed effects models with year as a random effect
##############

#1. Identify reference plot condition variables
refVars<-c('nhi_F', 'noi_F', 'ammonifd_F', 'nitrifd_F', 'minzd_F','soilmoi_F','som_F',
        'nat_g.m2','litter_g.m2','percpar','nTrees','BA_total','PercBA_AM')
data.refVars<-data.choice[data.choice$variable %in% refVars, c('plotid','plothalfid1','inv','year','variable','value')]
data.refVars$variable<-factor(data.refVars$variable, levels=refVars)
data.refVars<-subset(data.refVars, inv == 'N')
data.refVars.wide<-dcast(data.refVars, plotid + year ~ variable, value.var='value')

#2. Identify microstegium biomass
mvVar<-c('mv_g.m2')
data.mvVar<-data.choice[data.choice$variable %in% mvVar, c('plotid','plothalfid1','inv','year','variable','value')]
data.mvVar<-subset(data.mvVar, inv == 'I')
data.mvVar.wide<-dcast(data.mvVar, plotid + year ~ variable, value.var='value')
pHist.mv<-ggplot(data.mvVar.wide, aes(x=log(mv_g.m2)))+geom_histogram() #log-transform mv biomass to improve normality
data.mvVar.wide$mv_g.m2_logt<-log(data.mvVar.wide$mv_g.m2)

#3. Merge the reference plot condition columns and the microstegium biomass columns
data.q2.indp<-merge(data.refVars.wide, data.mvVar.wide)

#4. Merge the impact variables and the independant variables
data.q2<-merge(data.diffVars.wide, data.q2.indp)
data.q2$plotYear<-paste(data.q2$plotid,data.q2$year, sep="_")

#5. Make a fxn to run the models with reference conditions (excluding linked response variable) and Microstegium biomass predicting different y variables
ExplainDiffVar<-function(diffVarShort, refVars, df){
  
  #identify variables
  select.diffVar<-paste('Diff',diffVarShort, sep='_')
  select.refVars<-refVars[!refVars %in% diffVarShort]
  
  #identify select.refVars dataframe and ordinate
  df.ref<-data.frame(df[,select.refVars], year=df$year)
  rownames(df.ref)<-df$plotYear
  df.ref.rm<-df.ref[!rowSums(is.na(df.ref)),]
  tmp<-df.ref.rm[,!(colnames(df.ref.rm) == 'year')]
  tmp.scaled<-scale(tmp)
  PCA.ref<-prcomp(tmp.scaled)
  pPCA.ref<-ggbiplot(PCA.ref, groups=factor(df.ref.rm$year), ellipse=FALSE) + mytheme
  pPCA.ref
  
  #identify model dataframe
  df.PCA.ref<-data.frame(plotYear=rownames(PCA.ref$x), PCA.ref$x)
  df.sub<-data.frame(plotYear=df$plotYear, year=df$year, select.diffVar=df[,select.diffVar], mv_g.m2_logt=df$mv_g.m2_logt)
  df.mod<-merge(df.sub, df.PCA.ref[,c(1:3)])
  
  #fit model
  df.mod.scaled<-df.mod
  df.mod.scaled[,c('PC1','PC2','mv_g.m2_logt')]<-scale(df.mod.scaled[,c('PC1','PC2','mv_g.m2_logt')])
  mod<-lmer(select.diffVar ~ PC1 * PC2 * mv_g.m2_logt + (1|year), data=df.mod.scaled)
  summaryMod<-summary(mod)
  
  results<-list(refVars=select.refVars, pPCA.ref=pPCA.ref, df.mod.scaled=df.mod.scaled, df.mod=df.mod, mod=mod, summaryMod=summaryMod)
  
  return(results)
}

#A. Predict nitrate diff
result<-ExplainDiffVar(diffVarShort='noi_F', refVars=refVars, df=data.q2)
result[['pPCA.ref']]
newfilename<-'pPCAref_noiDiff.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*2, height = fig.height*2, res=fig.res)
result[['pPCA.ref']]
dev.off()
paste('PC1 represents increasing nhi, minz, som')
paste('PC2 represents decreasing light, increasing trees and litter')
result[['summaryMod']]
newfilename<-'summaryTable_noiDiff.txt'
write.table(data.frame(result[['summaryMod']]$coefficients), file=paste(figuresPath,newfilename, sep='/'), sep='\t')
paste('Marginally significant interaction between PC1 and PC2 on the effect size of nitrate')
#plot
df.plot<-result[['df.mod.scaled']]
df.plot$year<-factor(df.plot$year)
mod<-result[['mod']]
#plot PC1 ~ DiffVal with different lines for..
MakeNewDat<-function(df, select.year, select.PC2level){
  year<-df[df$year==select.year,c('year')]
  mv_g.m2_logt<-rep(mean(df[df$year==select.year,c('mv_g.m2_logt')]), length(year))
  PC1<-df[df$year==select.year,c('PC1')]
  yObs<-df[df$year==select.year,c('select.diffVar')]
  if(select.PC2level == 'high'){
    PC2.val<-max(df[df$year==select.year,c('PC2')])
  }
  if(select.PC2level == 'low'){
    PC2.val<-min(df[df$year==select.year,c('PC2')])
  }
  PC2<-rep(PC2.val, length(year))
  PC2.level<-rep(select.PC2level, length(year))
  df.group<-data.frame(year, mv_g.m2_logt, PC1, PC2, PC2.level, yObs)
return(df.group)
}
select.year.vec<-c(2012, 2012, 2013, 2013)
select.PC2level.vec<-c('high','low','high','low')
df.group.list<-list()
i<-0
for(i in 1:length(select.year.vec)){
  df.group.list[[i]]<-MakeNewDat(df=df.plot, select.year=select.year.vec[i], select.PC2level = select.PC2level.vec[i])
}
names(df.group.list)<-paste(select.PC2level.vec,select.year.vec, sep="_")
predData.list.fit<-llply(df.group.list, predict, object=mod)
predData.list<-llply(df.group.list, predictInterval, merMod=mod, n.sims = 999)
df.tmp.list<-list()
i<-0
for(i in 1:length(df.group.list)){
  df.tmp<-data.frame(df.group.list[[i]], predData.list[[i]], ypred=predData.list.fit[[i]])
  df.tmp.list[[i]]<-df.tmp
}
names(df.tmp.list)<-names(df.group.list)
df.pred<-ldply(df.tmp.list)
df.pred$.id<-factor(df.pred$.id)
pScat.noiDiff<-ggplot(df.pred, aes(x=PC1, y=ypred, color=.id))  +  mytheme +
  scale_color_manual(name='PC2 levels', values=c('red','darkred','blue','black'), labels=c('Low light, 2012','Low light, 2013','High light PC2, 2012','High light PC2, 2013')) +
  geom_line() + geom_point(aes(x=PC1, y=yObs), color=1) + geom_abline(intercept=0,slope=0, linetype=2) + 
  ylab('Difference in nitrate (Inv. - Ref.)') + xlab('PC1 - increasing N pools, mineralization, organic matter, moisture')
pScat.noiDiff 
newfilename<-'pScat.noiDiff.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*2, height = fig.height*2, res=fig.res)
pScat.noiDiff 
dev.off()

#B. Predict nitrification diff
result<-ExplainDiffVar(diffVarShort='nitrifd_F', refVars=refVars, df=data.q2)
result[['pPCA.ref']]
newfilename<-'pPCAref_nitrifDiff.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*2, height = fig.height*2, res=fig.res)
result[['pPCA.ref']]
dev.off()
paste('PC1 represents increasing nhi, minz, som')
paste('PC2 represents increasing light, decreasing trees and litter')
result[['summaryMod']]
newfilename<-'summaryTable_nitrifDiff.txt'
write.table(data.frame(result[['summaryMod']]$coefficients), file=paste(figuresPath,newfilename, sep='/'), sep='\t')
paste('Significant negative interaction effect of PC1 x Mv biomass')
#plot
df.plot<-result[['df.mod.scaled']]
df.plot$year<-factor(df.plot$year)
mod<-result[['mod']]
#plot PC1 ~ DiffVal with different lines for..
MakeNewDat<-function(df, select.year, select.PC1level){
  year<-df[df$year==select.year,c('year')]
  PC2<-rep(mean(df[df$year==select.year,c('PC2')]), length(year))
  mv_g.m2_logt<-df[df$year==select.year,c('mv_g.m2_logt')]
  yObs<-df[df$year==select.year,c('select.diffVar')]
  if(select.PC1level == 'high'){
    PC1.val<-max(df[df$year==select.year,c('PC1')])
  }
  if(select.PC1level == 'low'){
    PC1.val<-min(df[df$year==select.year,c('PC1')])
  }
  PC1<-rep(PC1.val, length(year))
  PC1level<-rep(select.PC1level, length(year))
  df.group<-data.frame(year, mv_g.m2_logt, PC1, PC2, PC1level, yObs)
  
  return(df.group)
}
select.year.vec<-c(2012, 2012, 2013, 2013)
select.PC1level.vec<-c('high','low','high','low')
df.group.list<-list()
i<-0
for(i in 1:length(select.year.vec)){
  df.group.list[[i]]<-MakeNewDat(df=df.plot, select.year=select.year.vec[i], select.PC1level = select.PC1level.vec[i])
}
names(df.group.list)<-paste(select.PC1level.vec,select.year.vec, sep="_")
predData.list.fit<-llply(df.group.list, predict, object=mod)
predData.list<-llply(df.group.list, predictInterval, merMod=mod, n.sims = 999)
df.tmp.list<-list()
i<-0
for(i in 1:length(df.group.list)){
  df.tmp<-data.frame(df.group.list[[i]], predData.list[[i]], ypred=predData.list.fit[[i]])
  df.tmp.list[[i]]<-df.tmp
}
names(df.tmp.list)<-names(df.group.list)
df.pred<-ldply(df.tmp.list)
df.pred$.id<-factor(df.pred$.id)
pScat.nitrifDiff<-ggplot(df.pred, aes(x=mv_g.m2_logt, y=ypred, color=.id))  +  mytheme +
  scale_color_manual(name='PC1 levels', values=c('red','darkred','blue','black'), labels=c('High N, 2012','High N, 2013','Low N, 2012','Low N, 2013')) +
  geom_line() + geom_point(aes(x=mv_g.m2_logt, y=yObs), color=1) + geom_abline(intercept=0,slope=0, linetype=2) + 
  ylab('Difference in nitrification (Inv. - Ref.)') + xlab('Microstegium biomass (transformed)')
pScat.nitrifDiff
newfilename<-'pScat.nitrifDiff.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*2, height = fig.height*2, res=fig.res)
pScat.nitrifDiff
dev.off()

#C. Predict ammonification diff
result<-ExplainDiffVar(diffVarShort='ammonifd_F', refVars=refVars, df=data.q2)
result[['pPCA.ref']]
newfilename<-'pPCAref_ammonifDiff.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*2, height = fig.height*2, res=fig.res)
result[['pPCA.ref']]
dev.off()
paste('PC1 represents increasing nhi, minz, som')
paste('PC2 represents decreasing light, increasing trees and litter')
result[['summaryMod']]
newfilename<-'summaryTable_ammonifDiff.txt'
write.table(data.frame(result[['summaryMod']]$coefficients), file=paste(figuresPath,newfilename, sep='/'), sep='\t')
paste('Significant positive interaction effect of PC1 x Mv biomass')
paste('Marginally significant positive effect of Mv biomass')
paste('Marginally significant positive interaction effect of PC1 x PC2')
#plot Diff~Mv + factor(PC1)
df.plot<-result[['df.mod.scaled']]
df.plot$year<-factor(df.plot$year)
mod<-result[['mod']]
#plot PC1 ~ DiffVal with different lines for..
select.year.vec<-c(2012, 2012, 2013, 2013)
select.PC1level.vec<-c('high','low','high','low')
df.group.list<-list()
i<-0
for(i in 1:length(select.year.vec)){
  df.group.list[[i]]<-MakeNewDat(df=df.plot, select.year=select.year.vec[i], select.PC1level = select.PC1level.vec[i])
}
names(df.group.list)<-paste(select.PC1level.vec,select.year.vec, sep="_")
predData.list.fit<-llply(df.group.list, predict, object=mod)
predData.list<-llply(df.group.list, predictInterval, merMod=mod, n.sims = 999)
df.tmp.list<-list()
i<-0
for(i in 1:length(df.group.list)){
  df.tmp<-data.frame(df.group.list[[i]], predData.list[[i]], ypred=predData.list.fit[[i]])
  df.tmp.list[[i]]<-df.tmp
}
names(df.tmp.list)<-names(df.group.list)
df.pred<-ldply(df.tmp.list)
df.pred$.id<-factor(df.pred$.id)
pScat.ammonifDiff<-ggplot(df.pred, aes(x=mv_g.m2_logt, y=ypred, color=.id))  +  mytheme +
  scale_color_manual(name='PC1 levels', values=c('red','darkred','blue','black'), labels=c('High N, 2012','High N, 2013','Low N, 2012','Low N, 2013')) +
  geom_line() + geom_point(aes(x=mv_g.m2_logt, y=yObs), color=1) + geom_abline(intercept=0,slope=0, linetype=2) + 
  ylab('Difference in ammonification (Inv. - Ref.)') + xlab('Microstegium biomass (transformed)')
pScat.ammonifDiff
newfilename<-'pScat.ammonifDiff.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*2, height = fig.height*2, res=fig.res)
pScat.ammonifDiff
dev.off()
```

_________________________________________________________________
# 3. Q3: Do reference plot conditions predict Microstegium biomass?
A. Do an ordination of reference conditions.
B. Test the relationship between Microstegium biomass and reference conditions using permMANOVA.
C. Investigate individual relationships using mixed effects models with year as a random effect.
```{r q3, echo=TRUE, message=FALSE, warning=FALSE}
#1. Identify dataframe with (x) reference plot condition variables and (y) Microstegium biomass
#refVars
data.q3<-data.q2.indp
data.q3$plotYear<-paste(data.q3$plotid, data.q3$year, sep="_")

#2. Ordinate reference conditions
data.q3.rm<-data.q3[!rowSums(is.na(data.q3))>0,]
tmp<-data.q3.rm[,refVars]
cor(tmp) #look at correlation matrix
row.names(tmp)<-data.q3.rm$plotYear
tmp.scaled<-scale(tmp)
PCA.res<-prcomp(tmp.scaled)
ggbiplot(PCA.res, groups=factor(data.q3.rm$year), ellipse = T) + mytheme
ggbiplot_q3(pcobj=PCA.res, df=data.q3.rm)
df.PCA<-data.frame(plotYear=row.names(PCA.res$x), PCA.res$x)
data.q3.PCA<-merge(data.q3.rm, df.PCA[,c(1:3)])

#3. Do reference area and plot characteristics explain variation in Mv biomass?
#a) perMANOVA on mv biomass
perMANOVA<-adonis(tmp.scaled ~ mv_g.m2_logt, data = data.q3.PCA, method='eu')
aov.tab.permanova<-data.frame(perMANOVA$aov.tab)
aov.tab.permanova
#save anova table
newfilename<-'permMANOVA_RefxMv.txt'
write.table(aov.tab.permanova, file=paste(figuresPath,newfilename, sep='/'), sep='\t')

#b) mixed effects model that uses 1st two PC scores to predict mv biomass
data.q3.PCA$year<-factor(data.q3.PCA$year)
mod<-lmer(mv_g.m2_logt~PC1*PC2 + (1|year), data=data.q3.PCA)
summary(mod)$coefficients
#save anova table
newfilename<-'summaryTable_mvPC.txt'
write.table(summary(mod)$coefficients, file=paste(figuresPath,newfilename, sep='/'), sep='\t')
#plot --- REDO SO THAT IT MATCHES THE FORMAT ABOVE
pScat_PC2.mv<-ggplot(data.q3.PCA, aes(x=PC2, y=mv_g.m2_logt, color=year)) + 
  geom_point() + mytheme + geom_smooth(method='lm') + ylab('Microstegium (log trans. g/m2)')
#save plot
newfilename<-'pScat_RefPC2xMv.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*1.5, height = fig.height*1, res=fig.res)
pScat_PC2.mv
dev.off()

#c) Look at how Mv biomass corresponds with variables associated with PC2

df.mod.scaled<-data.q3.PCA
df.mod.scaled[,c('percpar','nTrees',
                 'PercBA_AM','nat_g.m2',
                 'litter_g.m2')]<-scale(df.mod.scaled[,c('percpar','nTrees',
                                                         'PercBA_AM','nat_g.m2',
                                                         'litter_g.m2')])
  mod<-lmer(mv_g.m2_logt~percpar+nTrees+PercBA_AM+nat_g.m2+litter_g.m2+ (1|year), data=df.mod.scaled) 
  summaryMod<-summary(mod)
  summaryMod
  
p1<-ggplot(data.q3.PCA, aes(x=percpar, y=mv_g.m2_logt, color=year))+geom_point() +
  mytheme + scale_color_manual(name='Year',values=c('black','darkblue')) +
  ylab(NULL) + xlab('Light availability') + guides(color=FALSE)
p2<-ggplot(data.q3.PCA, aes(x=nTrees, y=mv_g.m2_logt, color=year))+geom_point() +
  mytheme + scale_color_manual(name='Year',values=c('black','darkblue'))+
  ylab(NULL) + xlab('Number of trees') + guides(color=FALSE)
p3<-ggplot(data.q3.PCA, aes(x=PercBA_AM, y=mv_g.m2_logt, color=year))+geom_point() + 
  mytheme + scale_color_manual(name='Year',values=c('black','darkblue'))+
  ylab(NULL) + xlab('%AM basal area') + guides(color=FALSE)
p4<-ggplot(data.q3.PCA, aes(x=litter_g.m2, y=mv_g.m2_logt, color=year))+geom_point() + 
  mytheme + scale_color_manual(name='Year',values=c('black','darkblue'))+
  ylab(NULL) + xlab('Litter biomass') + guides(color=FALSE)
p5<-ggplot(data.q3.PCA, aes(x=nat_g.m2, y=mv_g.m2_logt, color=year))+geom_point() + 
  mytheme + scale_color_manual(name='Year',values=c('black','darkblue'))+
  ylab(NULL) + xlab('Understory plant biomass') + guides(color=FALSE)

ylabel<-textGrob('Microstegium biomass (log trans. g/m2)', rot=90)
xlabel<-textGrob('')

newfilename<-'pScat_RefsxMv.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*2, height = fig.height*3, res=fig.res)
grid.arrange(
  ylabel, 
  arrangeGrob(p1,p2,p3,p4,p5),
  textGrob(""),
  xlabel,
      widths = unit.c(unit(2, "lines"), unit(1, "npc") - unit(2, "lines")), 
      heights = unit.c(unit(1, "npc") - unit(0, "lines"), unit(0, "lines")), 
      nrow=2, ncol=2
)
dev.off()

```

_________________________________________________________________
# 3. Q4: What is the relative importance of reference conditions on impact - direct and indirectly
A. Nitrate model
```{r q4, echo=TRUE, message=FALSE, warning=FALSE}
data.q4<-data.q2

#Identify the nitrate dataframe
df<-data.q4
diffVarShort<-'noi_F'

PathAnalysis<-function(df, diffVarShort){
  
  #select the impact variable
  select.diffVar<-paste('Diff',diffVarShort, sep='_')
  
  #make reference ordination
  refVars<-refVars[refVars != 'percpar']
  select.refVars<-refVars[!refVars %in% diffVarShort]
  df.ref<-data.frame(df[,select.refVars], year=df$year)
  rownames(df.ref)<-df$plotYear
  df.ref.rm<-df.ref[!rowSums(is.na(df.ref)),]
  tmp<-df.ref.rm[,!(colnames(df.ref.rm) == 'year')]
  tmp.scaled<-scale(tmp)
  PCA.ref<-prcomp(tmp.scaled) #same as in q2
  
  #set up dataframe for path analysis
  df.PCA.ref<-data.frame(plotYear=rownames(PCA.ref$x), PCA.ref$x)
  df.sub<-data.frame(plotYear=df$plotYear, year=df$year, 
                   select.diffVar=df[,select.diffVar], mv_g.m2_logt=df$mv_g.m2_logt)
  df.mod<-merge(df.sub, df.PCA.ref[,c(1:3)])
  
  #path analysis
  myModel <- '# direct effects
              select.diffVar ~ c1*PC1 + c2*PC2

              #mediator
              mv_g.m2_logt ~ a1*PC1 + a2*PC2
              select.diffVar ~ b*mv_g.m2_logt

              #indirect effects via PC1
              a1b := a1*b

              #indirect effects via PC2
              a2b := a2*b

              #indirect effects 
              a1a2b := a1*b + a2*b

              #total effects
              c1c2a1a2b := c1 + c2 + a1*b + a2*b
             '

  fit <- sem(myModel, data=df.mod)
  result<-summary(fit)
  
  return(result)
}

PathAnalysis(df=data.q4, diffVarShort = 'noi_F')
PathAnalysis(df=data.q4, diffVarShort = 'nitrifd_F')
PathAnalysis(df=data.q4, diffVarShort = 'ammonifd_F')
```

_________________________________________________________________
# Trends over time
a. Does Microstegium biomass increase over time?
b. Do soil N pools and fluxes in reference (and invaded) plots shift over time?
c. Do impact magnitudes shift over time?
d. Does the influence of reference conditions on Microstegium biomass shift over time?

_________________________________________________________________
# Invasion front study design
a. What environmental factors besides soil N pools and fluxes differ among paired invaded and reference plots?

_________________________________________________________________
# %AM
a. Does Microstegium biomass vary with %AM?
b. Does %AM vary with multivariate soil N conditions in reference plots?









