---
title: 'E8: Part1'
author: "Marissa Lee"
date: "October 23, 2015"
output: pdf_document
---

**Filename: E8_bothDepths_percparAgg.Rmd'**
Uses data_d

_________________________________________________________________
# 0. Clean and merge
```{r libraries, echo=FALSE}
knitr::opts_chunk$set(cache=TRUE)

#LIBRARIES
library(plyr)
library(reshape2)
library(ggplot2) #plotting
library(ggthemes) #ggplot accessories
library(GGally) #????
library(gtable)
library(gridExtra) #for grid.arrange fxn
library(lme4) #for mixed-effects models
library(lmerTest) #for lmer p-values
library(ggbiplot) #for pretty biplots
library(vegan) #for adonis fxn to do perMANOVAs
library(lavaan) #for structural equation modeling
library(doBy) #the orderBy fxn

#FIGURES
source('CODE/mytheme.R')
figuresPath<-file.path(getwd()[1], "FIGURES_TABLES") #where to put the saved plots
fig.height<-2.5 #inches
fig.width<- 2.5 #inches
fig.res<-300

#SYNTHESIZED DATAFRAMES
synthdataPath<-file.path(getwd()[1], "DATA", "DATA_SYNTHESIZED") #where to put the clean dataframes

#IMPORT RAW DATA
soilData<-read.table("DATA/e8_plothalfSoilData.txt", header=TRUE, sep="\t", stringsAsFactors = FALSE)
vegData<-read.table("DATA/e8_plothalfVegData.txt", header=TRUE, sep="\t", stringsAsFactors = FALSE)
plotLoc<-read.table("DATA/e8_plotLoc.txt", header=TRUE, sep="\t", stringsAsFactors = FALSE)
plotTrees<-read.table("DATA/e8_plotTrees.txt", header=TRUE, sep="\t", stringsAsFactors = FALSE)
soilData.dict<-read.table("DATA/e8_plothalfSoilData_dictionary.txt", header=TRUE, sep="\t", stringsAsFactors = FALSE)
vegData.dict<-read.table("DATA/e8_plothalfVegData_dictionary.txt", header=TRUE, sep="\t", stringsAsFactors = FALSE)
plotLoc.dict<-read.table("DATA/e8_plotLoc_dictionary.txt", header=TRUE, sep="\t", stringsAsFactors = FALSE)
plotTrees.dict<-read.table("DATA/e8_plotTrees_dictionary.txt", header=TRUE, sep="\t", stringsAsFactors = FALSE)
timeline<-read.table("DATA/e8_timeline.txt", header=TRUE, sep="\t", stringsAsFactors = FALSE)
phData<-read.table("DATA/e8_ph.txt", header=TRUE, sep="\t", stringsAsFactors = FALSE)

#CLEAN AND MERGE
source('CODE/script_cleanMerge.R')
#saves plot 'pHist_depth.png'
#saves data 'data_a.txt' # aggregated mean(depth) for 2012 and 2013
#saves data 'data_d.txt' # removed variables that were only measured in 2011 (i.e. full soil depth 0-15cm measurements)
data.choice<-data_d #decide which dataset to use

#REPLACE PERCPAR WITH PERCPAR.AGG
data.choice<-data.choice[data.choice$variable != 'percpar',]
data.choice[data.choice$variable == 'percpar.AggY','variable']<-'percpar'



#CUSTOM FUNCTIONS
source('CODE/fxn_InvEffect.R') #used in Q1
source('CODE/fxn_ggbiplot_q1.R') #used in Q1
source('CODE/fxn_ExplainDiffVar.R') #used in Q2
source('CODE/fxn_PCAhelpers.R') #used in Q2
source('CODE/fxn_InteractionPlot_DF.R') #used in Q2
source('CODE/fxn_Interaction_MakeNewDat.R') #used in Q2
source('CODE/fxn_XYPlot_DF.R') #used in Q2
source('CODE/fxn_ggbiplot_q3.R') #used in Q3
source('CODE/fxn_XYPlot_DF2.R') #used in Q3
```

_________________________________________________________________
# 1. Q1: Do soil N pools and fluxes shift in response to the presence of Microstegium? 
A. Do an ordination of soil N pools and fluxes and test the role of invasion status with permMANOVA
B. Investigate individual relationships using mixed effects models with year+site as a random effect and identify N variables that increase/decrease across sites.
```{r q1, echo=FALSE, message=FALSE, warning=FALSE}

##############
#A. Do an ordination of soil N pools and fluxes.
##############

#1) Subset and reshape
vars
data.vars<-data.choice[data.choice$variable %in% vars, c('plotid','plothalfid1','inv','year','variable','value')]
data.vars$variable<-factor(data.vars$variable, levels=vars)
data.vars.wide<-dcast(data.vars, plothalfid1 + inv+ year ~ variable, value.var='value')
data.vars.wide$plotInvYear<-paste(data.vars.wide$plothalfid1, data.vars.wide$year, sep="_") #use this to identify rows
data.vars.wide$plotYear<-paste(data.vars.wide$plotid, data.vars.wide$year, sep="_") #use this to block by plotid*year
row.names(data.vars.wide)<-data.vars.wide$plotInvYear
NonValCols<-c('plothalfid1','plotInvYear', 'plotYear','inv','year')
ValCols<-colnames(data.vars.wide)[!(colnames(data.vars.wide) %in% NonValCols)]
data.vars.wide.rm<-data.vars.wide[!rowSums(is.na(data.vars.wide))>0,] #remove rows with missing data
#cor(data.vars.wide.rm[,ValCols]) #look at correlation matrix

#2) Ordinate and save plot
df.ord<-data.vars.wide.rm[,ValCols]
colnames(df.ord)<-varNames
df.ord.scaled<-scale(df.ord)
PCA.res<-prcomp(df.ord.scaled)
data.PCA<-data.frame(plotInvYear=rownames(PCA.res$x), PCA.res$x)
data.vars.PCA<-merge(data.vars.wide.rm, data.PCA[,c(1:3)]) #add Mv biomass to this dataframe
data.vars.PCA$plotid<-ldply(strsplit(data.vars.PCA$plothalfid1, "_", fixed=TRUE))$V2
data.vars.PCA$year<-factor(data.vars.PCA$year)
plots<-ggbiplot_q1(pcobj=PCA.res, df=data.vars.PCA)
plots[['pEllipseIN']]
newfilename<-'pPCA_q1.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*2.5, height = fig.height*2, res=fig.res)
plots[['pEllipseIN']] + xlim(c(-2.3,4))
dev.off()
#variable contributions to PC1 and PC2
PCvar<-PCA.var.contrib_q1(pca.obj=PCA.res)
newfilename<-'PCvar_q1.txt'
write.table(PCvar, file=paste(figuresPath,newfilename, sep='/'), sep='\t')

#3) Test the role of invasion status with permMANOVA
data.vars.wide.rm$inv<-factor(data.vars.wide.rm$inv, levels=c('N','I'))
sum(rownames(data.vars.wide.rm) != rownames(df.ord.scaled)) # if this is 0, then rownames match
permMANOVA<-adonis(df.ord.scaled ~ inv, data = data.vars.wide.rm, method='eu')
aov.tab.permmanova<-data.frame(permMANOVA$aov.tab)
aov.tab.permmanova
newfilename<-'permMANOVA_q1.txt'
write.table(aov.tab.permmanova, file=paste(figuresPath,newfilename, sep='/'), sep='\t')


##############
#B. Investigate individual relationships using mixed effects models with year+site as a random effect.
##############

#1) Run models
Yvars<-vars
YvarNames<-varNames
df<-data.vars.PCA
result<-InvEffect(Yvars=Yvars, YvarNames=YvarNames, df=df)

#2) Calculate means and save
data.vars.PCA.long<-melt(data.vars.PCA, measure.vars=vars, id.vars = c('inv','year','plotid'))
meanSummary<-ddply(data.vars.PCA.long, ~variable+inv+year, summarize,
                   mean=mean(value),
                   n=length(value),
                   se=sd(value)/sqrt(n))
meanSummary[,c('mean','se')]<-round(meanSummary[,c('mean','se')], digits=2)
colnames(meanSummary)[colnames(meanSummary) == 'variable']<-'vars'
newfilename<-'meanSummary_q1.txt'
write.table(meanSummary, file=paste(figuresPath,newfilename, sep='/'), sep='\t')

#3) Save coefficient and anova summary tables
#data.frame(result[['summarySummary']])
newfilename<-'summarySummary_q1.txt'
write.table(data.frame(result[['summarySummary']]), file=paste(figuresPath,newfilename, sep='/'), sep='\t')
#data.frame(result[['posthocSummary']])
newfilename<-'posthocSummary_q1.txt'
write.table(data.frame(result[['posthocSummary']]), file=paste(figuresPath,newfilename, sep='/'), sep='\t')

#4) Plot
#i) prep dataframe and params
meanSummary.pretty<-merge(meanSummary, vars.indx)
meanSummary.pretty$varNames<-factor(meanSummary.pretty$varNames, levels=varNames)
limits <- aes(ymax = mean + se, ymin=mean - se)
meanSummary.pretty$depthYear<-paste(meanSummary.pretty$depth, meanSummary.pretty$year, sep="_")
meanSummary.pretty$depthYear<-factor(meanSummary.pretty$depthYear, levels=depthYearLevels)
meanSummary.pretty$depthYear<-mapvalues(meanSummary.pretty$depthYear, from = depthYearLevels, to = depthYearNames)
meanSummary.pretty$inv<-mapvalues(meanSummary.pretty$inv, from = inv_order, to = invNames)
basic.varNames2<-paste(basic.varNames, units)
lineVec<-c(1,1,2,2)
shapeVec<-c(16,17,16,17)
#ii) loop through each soil response variable
figure.list<-list()
i<-0
for(i in 1:length(basic.vars)){
  df.current<-meanSummary.pretty[meanSummary.pretty$basic.vars ==  basic.vars[i],]
  p<-ggplot(df.current, aes(x=inv, y=mean, shape=depthYear, linetype=depthYear, group=depthYear)) + 
    geom_point(size=3) + geom_errorbar(limits, width=0.2) + geom_line() + 
    mytheme + xlab(NULL) + ylab(basic.varNames2[i]) + 
    scale_linetype_manual(name='Depth & Year', values=lineVec) + 
    scale_shape_manual(name='Depth & Year', values=shapeVec) +
    guides(shape=FALSE, linetype=FALSE) 
  figure.list[[i]]<-p
}
names(figure.list)<-basic.vars
#iii) extract the legend
pleg <- ggplot(df.current, aes(x=inv, y=mean, shape=depthYear, linetype=depthYear, group=depthYear)) + 
    geom_point(size=3) + geom_errorbar(limits, width=0.2) + geom_line() + 
    mytheme + xlab(NULL) + ylab(basic.varNames2[i]) + 
    scale_linetype_manual(name='Depth & Year', values=lineVec) + 
    scale_shape_manual(name='Depth & Year', values=shapeVec) 
leg1Grob<-g_legend(pleg)
#iv) put panels together and save
grid.arrange(
  figure.list[['nhi']] + ylim(c(0,4)),
  figure.list[['noi']] + ylim(c(0,4)),
  leg1Grob,
  figure.list[['ammonifd']] + ylim(c(-0.2,0.55)),
  figure.list[['nitrifd']] + ylim(c(-0.2,0.55)),
  figure.list[['minzd']] + ylim(c(-0.2,0.55)),
  nrow=2, ncol=3
)
newfilename<-'pScat_q1.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*3, height = fig.height*2, res=fig.res)
grid.arrange(
  figure.list[['nhi']] + ylim(c(0,4)),
  figure.list[['noi']] + ylim(c(0,4)),
  leg1Grob,
  figure.list[['ammonifd']] + ylim(c(-0.2,0.55)),
  figure.list[['nitrifd']] + ylim(c(-0.2,0.55)),
  figure.list[['minzd']] + ylim(c(-0.2,0.55)),
  nrow=2, ncol=3
)
dev.off()

##############
#D. Identify N variables that increase/decrease across sites.
##############
data.frame(result[['posthocSummary']])
paste('Net potential ammonification is higher in the invaded plots in the second year. In other words, more ammonium is being released than immobilized on average.')
paste('Although net ammonification is higher in invaded plots, ammonium pools do not differ.  This may be because (1) this is an ammonification potential measure and/or (2) plant uptake is a strong control on standing ammonium pools')

```

_________________________________________________________________
# 2. Q2: Do reference plot conditions and/or Microstegium biomass predict impact magnitudes?
A. Calculate impact magnitude for each target variable (nitrate, nitrification, other variables detected in Q1 ordination)
B. Test the role of reference plot conditions and Microstegium biomass on impacts individually using mixed effects models with year as a random effect
```{r q2, echo=FALSE, message=FALSE, warning=FALSE}

##############
#A. Calculate impact magnitude for each target variable (nitrate, nitrification, ammonification)
##############

#reshape dataframe
data.vars.wideIN <- dcast(data.vars, plotid + year + variable ~ inv, value.var="value")
#calculate diff
data.vars.wideIN$Diff<-data.vars.wideIN$I - data.vars.wideIN$N
#subset select diff variables and reshape
diffVars<-c('noi_T','noi_B','ammonifd_T','ammonifd_B','nitrifd_T','nitrifd_B','minzd_T','minzd_B')
data.diffVars<-data.vars.wideIN[data.vars.wideIN$variable %in% diffVars, c('plotid','year','variable','Diff')]
data.diffVars.wide<-dcast(data.diffVars, plotid + year ~ variable, value.var='Diff')
colnames(data.diffVars.wide)[-c(1:2)]<-paste('Diff', colnames(data.diffVars.wide)[-c(1:2)], sep="_")

##############
#B. Test the role of reference plot conditions and Microstegium biomass on impacts individually using mixed effects models with year as a random effect
##############

#0. Prep dataset
#i) Identify reference plot condition variables
refVars
data.refVars<-data.choice[data.choice$variable %in% refVars, c('plotid','plothalfid1','inv','year','variable','value')]
data.refVars$variable<-factor(data.refVars$variable, levels=refVars)
data.refVars<-subset(data.refVars, inv == 'N')
data.refVars.wide<-dcast(data.refVars, plotid + year ~ variable, value.var='value')
#ii) Identify microstegium biomass
data.mvVar<-data.choice[data.choice$variable %in% mvVar, c('plotid','plothalfid1','inv','year','variable','value')]
data.mvVar<-subset(data.mvVar, inv == 'I')
data.mvVar.wide<-dcast(data.mvVar, plotid + year ~ variable, value.var='value')
pHist.mv<-ggplot(data.mvVar.wide, aes(x=log(mv_g.m2)))+geom_histogram() #log-transform mv biomass to improve normality
#pHist.mv
data.mvVar.wide$mv_g.m2_logt<-log(data.mvVar.wide$mv_g.m2)
#iii) Merge the reference plot condition columns and the microstegium biomass columns
data.q2.indp<-merge(data.refVars.wide, data.mvVar.wide)
#iv) Merge the impact variables and the independant variables
data.q2<-merge(data.diffVars.wide, data.q2.indp)
data.q2$plotYear<-paste(data.q2$plotid,data.q2$year, sep="_")


##############
#1. Nitrate diff model
result<-ExplainDiffVar(diffVarShort='noi_T', refVars=refVars, df=data.q2)
pPCA.noi<-result[['pPCA.ref']]
PCvar.noi<-PCA.var.contrib_q2(result.list=result, diffVarShort='noi_T')
summ.noiT<-data.frame(result[['summaryMod']]$coefficients, depth=rep('0-5',dim(result[['summaryMod']]$coefficients)[1]))
result<-ExplainDiffVar(diffVarShort='noi_B', refVars=refVars, df=data.q2)
summ.noiB<-data.frame(result[['summaryMod']]$coefficients, depth=rep('5-15',dim(result[['summaryMod']]$coefficients)[1]))
summ.noi<-rbind(summ.noiT, summ.noiB)
#model summary table
summ.noi
newfilename<-'summaryTable_noiDiff.txt'
write.table(summ.noi, file=paste(figuresPath,newfilename, sep='/'), sep='\t')
paste('Differences in nitrate in 0-5cm depths are mediated by a) PC1 x PC2 (marginally significant), b) PC2 x Mv biomass')
paste('Differences in nitrate in 5-15cm depths not mediated by factors measured')

#plot: diff noi_T ~ PC2 by PC1 levels
diffVarShort = 'noi_T'
xVar = 'PC2'
factorVar = 'PC1'
df = data.q2
factorYear.names = c('Max, 2012','Min, 2012','Max, 2013','Min, 2013')
df.pred<-InteractionPlot_DF(diffVarShort, df, factorVar, xVar, factorYear.names)
colorLevels<-c('black','black','blue','blue')
linetypeLevels<-c(1,2,1,2)
shapeLevels<-c(16,17,16,17)
pScat.noiDiff_PC1PC2<-ggplot(df.pred, aes(x=PC2, y=ypred, color=factorYear, linetype=factorYear, shape=factorYear))  +  mytheme +
  geom_line() + geom_abline(intercept=0,slope=0, linetype=3, color=1) + 
  ylab('Nitrate (0-5cm) invasion effect') + xlab('PC2 (Light availability)') +
  scale_color_manual(name='PC1 (Moisture & OM)', values=colorLevels) +
  scale_linetype_manual(name='PC1 (Moisture & OM)', values=linetypeLevels) + 
  scale_shape_manual(name='PC1 (Moisture & OM)', values=shapeLevels) + 
  geom_point(aes(x=PC2, y=yObs), color='darkgray')
pScat.noiDiff_PC1PC2 




##############
#2. Nitrification diff model
result<-ExplainDiffVar(diffVarShort='nitrifd_T', refVars=refVars, df=data.q2)
pPCA.nitrifd<-result[['pPCA.ref']]
PCvar.nitrifd<-PCA.var.contrib_q2(result.list=result, diffVarShort='nitrifd_T')
summ.T<-data.frame(result[['summaryMod']]$coefficients, depth=rep('0-5',dim(result[['summaryMod']]$coefficients)[1]))
result<-ExplainDiffVar(diffVarShort='nitrifd_B', refVars=refVars, df=data.q2)
summ.B<-data.frame(result[['summaryMod']]$coefficients, depth=rep('5-15',dim(result[['summaryMod']]$coefficients)[1]))
summ.nitrifd<-rbind(summ.T, summ.B)
#model summary table
summ.nitrifd
newfilename<-'summaryTable_nitrifdDiff.txt'
write.table(summ.nitrifd, file=paste(figuresPath,newfilename, sep='/'), sep='\t')
paste('Differences in nitrification in 0-5cm depths are not mediated by factors measured')
paste('Differences in nitrification in 5-15cm depths are not mediated by factors measured')



##############
#3. Ammonification diff model
result<-ExplainDiffVar(diffVarShort='ammonifd_T', refVars=refVars, df=data.q2)
pPCA.ammonifd<-result[['pPCA.ref']]
PCvar.ammonifd<-PCA.var.contrib_q2(result.list=result, diffVarShort='ammonifd_T')
summ.T<-data.frame(result[['summaryMod']]$coefficients, depth=rep('0-5',dim(result[['summaryMod']]$coefficients)[1]))
result<-ExplainDiffVar(diffVarShort='ammonifd_B', refVars=refVars, df=data.q2)
summ.B<-data.frame(result[['summaryMod']]$coefficients, depth=rep('5-15',dim(result[['summaryMod']]$coefficients)[1]))
summ.ammonifd<-rbind(summ.T, summ.B)
#model summary table
summ.ammonifd
newfilename<-'summaryTable_ammonifdDiff.txt'
write.table(summ.ammonifd, file=paste(figuresPath,newfilename, sep='/'), sep='\t')
paste('Differences in ammonification in 0-5cm depths are mediated by Mv biomass (marginally)')
paste('Differences in ammonification in 5-15cm depths are not mediated by factors measured')


#plot: diff ammonifd_T ~ Mv by PC1 levels
diffVarShort = 'ammonifd_T'
xVar = 'mv_g.m2_logt'
df = data.q2
df.pred<-XYPlot_DF(diffVarShort, df, xVar)
linetypeLevels<-c(1,2)
shapeLevels<-c(16,17)
pScat.ammonifdDiff_MvPC1<-ggplot(df.pred, aes(x=mv_g.m2_logt, y=ypred, linetype=year, shape=year))  +  mytheme +
  geom_line() + geom_abline(intercept=0,slope=0, linetype=3, color=1) + 
  ylab('Ammonif. (0-5cm) invasion effect') + xlab('Microstegium biomass (log g/m2)') +
  scale_linetype_manual(name='PC1 (Moisture & OM)', values=linetypeLevels)+ 
  scale_shape_manual(name='PC1 (Moisture & OM)', values=shapeLevels) + 
  geom_point(aes(x=mv_g.m2_logt, y=yObs), color='darkgray')
pScat.ammonifdDiff_MvPC1 


##############
#4. Mineralization diff model
result<-ExplainDiffVar(diffVarShort='minzd_T', refVars=refVars, df=data.q2)
pPCA.minzd<-result[['pPCA.ref']]
PCvar.minzd<-PCA.var.contrib_q2(result.list=result, diffVarShort='minzd_T')
summ.T<-data.frame(result[['summaryMod']]$coefficients, depth=rep('0-5',dim(result[['summaryMod']]$coefficients)[1]))
result<-ExplainDiffVar(diffVarShort='minzd_B', refVars=refVars, df=data.q2)
summ.B<-data.frame(result[['summaryMod']]$coefficients, depth=rep('5-15',dim(result[['summaryMod']]$coefficients)[1]))
summ.minzd<-rbind(summ.T, summ.B)
#model summary table
summ.minzd
newfilename<-'summaryTable_minzdDiff.txt'
write.table(summ.minzd, file=paste(figuresPath,newfilename, sep='/'), sep='\t')
paste('Differences in mineralization in 0-5cm depths are mediated by PC1 xPC2')
paste('Differences in mineralization in 5-15cm depths are not mediated by factors tested')

#plot: diff minzd_T ~ Mv by PC1 levels
diffVarShort = 'minzd_T'
xVar = 'PC2'
factorVar = 'PC1'
df = data.q2
factorYear.names = c('Max, 2012','Min, 2012','Max, 2013','Min, 2013')
df.pred<-InteractionPlot_DF(diffVarShort, df, factorVar, xVar, factorYear.names)
colorLevels<-c('black','black','blue','blue')
linetypeLevels<-c(1,2,1,2)
shapeLevels<-c(16,17,16,17)
pScat.minzdDiff_PC1PC2<-ggplot(df.pred, aes(x=PC2, y=ypred, color=factorYear, linetype=factorYear, shape=factorYear))  +  mytheme +
  geom_line() + geom_abline(intercept=0,slope=0, linetype=3, color=1) + 
  ylab('Mineraliz. (0-5cm) invasion effect') + xlab('PC2') +
  scale_color_manual(name='PC1 (Moisture & OM)', values=colorLevels) +
  scale_linetype_manual(name='PC1 (Moisture & OM)', values=linetypeLevels) + 
  scale_shape_manual(name='PC1 (Moisture & OM)', values=shapeLevels) + 
  geom_point(aes(x=PC2, y=yObs), color='darkgray')
pScat.minzdDiff_PC1PC2 


######
#Reference condition PCAs
grid.arrange(pPCA.noi + guides(color=FALSE) + ggtitle('For nitrate invasion effect'), 
             pPCA.nitrifd + guides(color=FALSE) + ggtitle('For nitrif. invasion effect'),
             pPCA.ammonifd + guides(color=FALSE) + ggtitle('For ammonif. invasion effect'),
             pPCA.minzd + guides(color=FALSE) + ggtitle('For mineraliz. invasion effect'))
newfilename<-'pPCAref_q2.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*4, height = fig.height*4, res=fig.res)
grid.arrange(pPCA.noi + guides(color=FALSE) + ggtitle('For nitrate invasion effect'), 
             pPCA.nitrifd + guides(color=FALSE) + ggtitle('For nitrif. invasion effect'),
             pPCA.ammonifd + guides(color=FALSE) + ggtitle('For ammonif. invasion effect'),
             pPCA.minzd + guides(color=FALSE) + ggtitle('For mineraliz. invasion effect'))
dev.off()
#variable contributions
PCvar<-rbind(PCvar.noi, PCvar.nitrifd, PCvar.ammonifd, PCvar.minzd)
PC1var<-PCvar[PCvar$PC=='PC1',]
PC2var<-PCvar[PCvar$PC=='PC2',]
PC1var.c<-dcast(PC1var, diffVar+PC+var ~ valueType, value.var = 'value')
PC1var.c.o<-orderBy(~diffVar-contrib, PC1var.c)
PC2var.c<-dcast(PC2var, diffVar+PC+var ~ valueType, value.var = 'value')
PC2var.c.o<-orderBy(~diffVar-contrib, PC2var.c)
newfilename<-'PC1var_q2.txt'
write.table(PC1var.c.o, file=paste(figuresPath,newfilename, sep='/'), sep='\t')
newfilename<-'PC2var_q2.txt'
write.table(PC2var.c.o, file=paste(figuresPath,newfilename, sep='/'), sep='\t')


#Scatter plots

pScat.noiDiff_PC1PC2
pScat.ammonifdDiff_MvPC1 

#PC1 levels as the legend
legend<-g_legend(pScat.noiDiff_PC1PC2)
newfilename<-"pScat_PC1legend.png"
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*2, height = fig.height*2, res=fig.res)
grid.arrange(pScat.noiDiff_PC1PC2 + guides(linetype=FALSE, color=FALSE, shape=FALSE)+ ggtitle('a'), legend,
             pScat.ammonifdDiff_PC1PC2 + guides(linetype=FALSE, color=FALSE, shape=FALSE)+ ggtitle('b'),
              pScat.ammonifdDiff_MvPC1 + guides(linetype=FALSE, color=FALSE, shape=FALSE)+ ggtitle('c'),
             nrow=2, ncol=2)
dev.off()

#PC2 levels as the legend
newfilename<-"pScat.noiDiff_PC2Mv.png"
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*1.6, height = fig.height*1, res=fig.res)
pScat.noiDiff_MvPC2
dev.off()

#Minz (5-15) vs PC2
newfilename<-'pScat.minzdDiffB_PC2.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*1.6, height = fig.height*1, res=fig.res)
pScat.minzdDiffB_PC2
dev.off()

```

_________________________________________________________________
# 3. Q3: Do reference plot conditions predict Microstegium biomass?
A. Do an ordination of reference conditions and test the relationship between Microstegium biomass and reference conditions using permMANOVA.
B. Investigate relationship between PC scores and Microstegium biomass using mixed effects models with year as a random effect.
```{r q3, echo=FALSE, message=FALSE, warning=FALSE}
#A. Do an ordination of reference conditions and test the relationship between Microstegium biomass and reference conditions using permMANOVA.
#1) Identify dataframe with (x) reference plot condition variables and (y) Microstegium biomass
#refVars
data.q3<-data.q2.indp
data.q3$plotYear<-paste(data.q3$plotid, data.q3$year, sep="_")

#2) Ordinate reference conditions
data.q3.rm<-data.q3[!rowSums(is.na(data.q3))>0,]
tmp<-data.q3.rm[,refVars]
colnames(tmp)<-refVarNames
#cor(tmp) #look at correlation matrix
row.names(tmp)<-data.q3.rm$plotYear
tmp.scaled<-scale(tmp)
PCA.res<-prcomp(tmp.scaled)
pPCA_q3<-ggbiplot_q3(pcobj=PCA.res, df=data.q3.rm)
pPCA_q3[['pBasic']]
#save plot
newfilename<-'pPCA_q3.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*2.5, height = fig.height*2, res=fig.res)
pPCA_q3[['pBasic']] + xlim(c(-2, 2.8))
dev.off()
#variable contributions to PC1 and PC2
PCvar<-PCA.var.contrib_q1(pca.obj=PCA.res)
newfilename<-'PCvar_q3.txt'
write.table(PCvar, file=paste(figuresPath,newfilename, sep='/'), sep='\t')
#make dataframe
df.PCA<-data.frame(plotYear=row.names(PCA.res$x), PCA.res$x)
data.q3.PCA<-merge(data.q3.rm, df.PCA[,c(1:3)])

#3) Do reference area and plot characteristics explain variation in Mv biomass? - perMANOVA on mv biomass
perMANOVA<-adonis(tmp.scaled ~ mv_g.m2_logt, data = data.q3.PCA, method='eu')
aov.tab.permanova<-data.frame(perMANOVA$aov.tab)
aov.tab.permanova
#save anova table
newfilename<-'permMANOVA_q3.txt'
write.table(aov.tab.permanova, file=paste(figuresPath,newfilename, sep='/'), sep='\t')


#B. Do PC scores from the reference condition ordination predict mv biomass?
#1) Fit model
data.q3.PCA$year<-factor(data.q3.PCA$year)
mod<-lmer(mv_g.m2_logt~PC1*PC2 + (1|year), data=data.q3.PCA)
summary(mod)$coefficients
#save anova table
newfilename<-'summaryTable_q3.txt'
write.table(summary(mod)$coefficients, file=paste(figuresPath,newfilename, sep='/'), sep='\t')

#2) Plot
yVar = 'mv_g.m2_logt'
xVar = 'PC2'
df = data.q3.PCA
mod<-lmer(mv_g.m2_logt~PC1*PC2 + (1|year), data=data.q3.PCA)
otherVars<-'PC1'
df.pred<-XYPlot_DF2(yVar, xVar, df, mod, otherVars)
linetypeLevels<-c(1,2)
shapeLevels<-c(16,1)
pScat.Mv_PC2<-ggplot(df.pred, aes(x=PC2, y=ypred, linetype=as.factor(year), shape=as.factor(year)))  +  mytheme +
  geom_line() + geom_abline(intercept=0,slope=0, linetype=3, color=1) + 
  ylab('Microstegium biomass (transformed)') + xlab('PC2') +
  scale_linetype_manual(name='Year', values=linetypeLevels) + 
  scale_shape_manual(name='Year', values=shapeLevels) + 
  geom_point(aes(x=PC2, y=yObs))
pScat.Mv_PC2
#save plot
newfilename<-'pScat_q3.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*1.5, height = fig.height*1, res=fig.res)
pScat.Mv_PC2
dev.off()

#3) Investigate how Mv biomass corresponds with variables associated with PC2
df.mod.scaled<-data.q3.PCA
df.mod.scaled[,c('percpar','nTrees',
                 'PercBA_AM','nat_g.m2',
                 'litter_g.m2')]<-scale(df.mod.scaled[,c('percpar','nTrees',
                                                         'PercBA_AM','nat_g.m2',
                                                         'litter_g.m2')])
mod<-lmer(mv_g.m2_logt~percpar+nTrees+PercBA_AM+nat_g.m2+litter_g.m2+ (1|year), data=df.mod.scaled) 
summaryMod<-summary(mod)
summaryMod

#plot
p1<-ggplot(data.q3.PCA, aes(x=percpar, y=mv_g.m2_logt, color=year))+geom_point() +
  mytheme + scale_color_manual(name='Year',values=c('black','darkblue')) +
  ylab(NULL) + xlab('Light availability') + guides(color=FALSE)
p2<-ggplot(data.q3.PCA, aes(x=nTrees, y=mv_g.m2_logt, color=year))+geom_point() +
  mytheme + scale_color_manual(name='Year',values=c('black','darkblue'))+
  ylab(NULL) + xlab('Number of trees') + guides(color=FALSE)
p3<-ggplot(data.q3.PCA, aes(x=PercBA_AM, y=mv_g.m2_logt, color=year))+geom_point() + 
  mytheme + scale_color_manual(name='Year',values=c('black','darkblue'))+
  ylab(NULL) + xlab('%AM basal area') + guides(color=FALSE)
p4<-ggplot(data.q3.PCA, aes(x=litter_g.m2, y=mv_g.m2_logt, color=year))+geom_point() + 
  mytheme + scale_color_manual(name='Year',values=c('black','darkblue'))+
  ylab(NULL) + xlab('Litter biomass') + guides(color=FALSE)
p5<-ggplot(data.q3.PCA, aes(x=nat_g.m2, y=mv_g.m2_logt, color=year))+geom_point() + 
  mytheme + scale_color_manual(name='Year',values=c('black','darkblue'))+
  ylab(NULL) + xlab('Understory plant biomass') + guides(color=FALSE)
ylabel<-textGrob('Microstegium biomass (log trans. g/m2)', rot=90)
xlabel<-textGrob('')
grid.arrange(
  ylabel, 
  arrangeGrob(p1,p2,p3,p4,p5),
  textGrob(""),
  xlabel,
      widths = unit.c(unit(2, "lines"), unit(1, "npc") - unit(2, "lines")), 
      heights = unit.c(unit(1, "npc") - unit(0, "lines"), unit(0, "lines")), 
      nrow=2, ncol=2
)
#save plots
newfilename<-'pScatvars_q3.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*2, height = fig.height*3, res=fig.res)
grid.arrange(
  ylabel, 
  arrangeGrob(p1,p2,p3,p4,p5),
  textGrob(""),
  xlabel,
      widths = unit.c(unit(2, "lines"), unit(1, "npc") - unit(2, "lines")), 
      heights = unit.c(unit(1, "npc") - unit(0, "lines"), unit(0, "lines")), 
      nrow=2, ncol=2
)
dev.off()

```

_________________________________________________________________
# 4. Q4: What is the relative importance of reference conditions on impact - direct and indirectly
A. Nitrate model
```{r q4, echo=FALSE, message=FALSE, warning=FALSE}
data.q4<-data.q2

#Identify the nitrate dataframe
df<-data.q4
diffVarShort<-'noi_T'

PathAnalysis<-function(df, diffVarShort){
  
  #select the impact variable
  select.diffVar<-paste('Diff',diffVarShort, sep='_')
  
  #make reference ordination
  refVars<-refVars[refVars != 'percpar']
  select.refVars<-refVars[!refVars %in% diffVarShort]
  df.ref<-data.frame(df[,select.refVars], year=df$year)
  rownames(df.ref)<-df$plotYear
  df.ref.rm<-df.ref[!rowSums(is.na(df.ref)),]
  tmp<-df.ref.rm[,!(colnames(df.ref.rm) == 'year')]
  tmp.scaled<-scale(tmp)
  PCA.ref<-prcomp(tmp.scaled) #same as in q2
  
  #set up dataframe for path analysis
  df.PCA.ref<-data.frame(plotYear=rownames(PCA.ref$x), PCA.ref$x)
  df.sub<-data.frame(plotYear=df$plotYear, year=df$year, 
                   select.diffVar=df[,select.diffVar], mv_g.m2_logt=df$mv_g.m2_logt)
  df.mod<-merge(df.sub, df.PCA.ref[,c(1:3)])
  
  #path analysis
  myModel <- '# direct effects
              select.diffVar ~ c1*PC1 + c2*PC2

              #mediator
              mv_g.m2_logt ~ a1*PC1 + a2*PC2
              select.diffVar ~ b*mv_g.m2_logt

              #indirect effects via PC1
              a1b := a1*b

              #indirect effects via PC2
              a2b := a2*b

              #indirect effects 
              a1a2b := a1*b + a2*b

              #total effects
              c1c2a1a2b := c1 + c2 + a1*b + a2*b
             '

  fit <- sem(myModel, data=df.mod)
  result<-summary(fit)
  
  return(result)
}

PathAnalysis(df=data.q4, diffVarShort = 'noi_T')
PathAnalysis(df=data.q4, diffVarShort = 'nitrifd_T')
PathAnalysis(df=data.q4, diffVarShort = 'ammonifd_T')
PathAnalysis(df=data.q4, diffVarShort = 'minzd_T')

```

_________________________________________________________________
# Trends over time
a. Does Microstegium biomass increase over time?
b. Do soil N pools and fluxes in reference (and invaded) plots shift over time?
c. Do impact magnitudes shift over time?
d. Does the influence of reference conditions on Microstegium biomass shift over time?

_________________________________________________________________
# Invasion front study design
a. What environmental factors besides soil N pools and fluxes differ among paired invaded and reference plots?

_________________________________________________________________
# %AM
a. Does Microstegium biomass vary with %AM?
b. Does %AM vary with multivariate soil N conditions in reference plots?









