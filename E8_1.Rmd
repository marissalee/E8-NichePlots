---
title: 'E8: Part1'
author: "Marissa Lee"
date: "October 23, 2015"
output: pdf_document
---

**Filename: E8_1.Rmd'**
**This markdown file does the following tasks:**
0. Clean and merge
1. Q1: How does invader biomass vary across resource availability in the reference plots?

```{r libraries, echo=TRUE}
knitr::opts_chunk$set(cache=TRUE)

library(plyr)
library(reshape2)
library(ggplot2)
library(ggthemes)
library(GGally)
library(gridExtra)
library(lme4)
library(lmerTest)
library(ggbiplot)
source('CODE/mytheme.R')
source('CODE/fxn_FitPlot.R')

figuresPath<-file.path(getwd()[1], "FIGURES_TABLES") #where to put the saved plots
fig.height<-2.5 #inches
fig.width<- 2.5 #inches
fig.res<-300

synthdataPath<-file.path(getwd()[1], "DATA", "DATA_SYNTHESIZED") #where to put the clean dataframes

soilData<-read.table("DATA/e8_plothalfSoilData.txt", header=TRUE, sep="\t", stringsAsFactors = FALSE)
vegData<-read.table("DATA/e8_plothalfVegData.txt", header=TRUE, sep="\t", stringsAsFactors = FALSE)
plotLoc<-read.table("DATA/e8_plotLoc.txt", header=TRUE, sep="\t", stringsAsFactors = FALSE)
plotTrees<-read.table("DATA/e8_plotTrees.txt", header=TRUE, sep="\t", stringsAsFactors = FALSE)

soilData.dict<-read.table("DATA/e8_plothalfSoilData_dictionary.txt", header=TRUE, sep="\t", stringsAsFactors = FALSE)
vegData.dict<-read.table("DATA/e8_plothalfVegData_dictionary.txt", header=TRUE, sep="\t", stringsAsFactors = FALSE)
plotLoc.dict<-read.table("DATA/e8_plotLoc_dictionary.txt", header=TRUE, sep="\t", stringsAsFactors = FALSE)
plotTrees.dict<-read.table("DATA/e8_plotTrees_dictionary.txt", header=TRUE, sep="\t", stringsAsFactors = FALSE)
timeline<-read.table("DATA/e8_timeline.txt", header=TRUE, sep="\t", stringsAsFactors = FALSE)

```

_________________________________________________________________
# 0. Clean and merge
Add identifiers, remove extra columns, merge raw datasets
Deal with soil N data in years where 0-5cm and 5-15cm layers were measured separately.  
```{r merge, echo=TRUE, message=FALSE, warning=FALSE}
##############
#A. Clean and merge
##############

# SOIL DATA
soilData$plothalfid1<-paste(soilData$inv,soilData$plotid, sep="_") #add new identifiers
removeCols<-c('plothalfid','site','rep') #prune columns
soilData.pruned<-soilData[,!colnames(soilData) %in% removeCols]
#reshape so that each depth x meas has its own column
soilData_melted <- melt(soilData.pruned,
                        id.vars=c("plotid","plothalfid1",
                                  "inv","depth","year"),
                        variable.name = "measCat")
soilData_melted$measCat2<-paste(soilData_melted$measCat, soilData_melted$depth, sep = '_')
soilData_cast <- dcast(soilData_melted, plotid + plothalfid1 + inv + year ~ measCat2, value.var="value")
soilData_c<-soilData_cast 

# VEG DATA
vegData$plothalfid1<-paste(vegData$inv,vegData$plotid, sep="_") #add new identifiers
vegData.pruned<-vegData[,!colnames(vegData) %in% removeCols] #prune columns
vegData.pruned$total<-vegData.pruned$mv+vegData.pruned$nat #make a total understory biomass variable
vegData.dict[c(2,4),c('v7','v8','v9')]
paste('Dry biomass values are currently in units of g/.1875m2')
ConvertBiom<-function(currVal){newVal <- currVal / 0.1875}
vegData.pruned$mv_g.m2<-ConvertBiom(vegData.pruned$mv)
vegData.pruned$nat_g.m2<-ConvertBiom(vegData.pruned$nat)
vegData.pruned$litter_g.m2<-ConvertBiom(vegData.pruned$litter)
vegData.pruned$total_g.m2<-ConvertBiom(vegData.pruned$total)
colsOldUnits<-c('mv','nat','litter','total')
vegData_c<-vegData.pruned[,!colnames(vegData.pruned) %in% colsOldUnits] #prune columns

#add vegData
soilVegData<-merge(soilData_c, vegData_c) #merge soilData_cast and vegData

# TREE DATA
plotTrees$basalArea.m2<-(plotTrees$dbh * plotTrees$dbh) * 0.00007854 #calculate basal area/m2 from each tree's dbh value
#summarize the total basal area/m2 per plot and that which is made up by either AM- or ECM-associated trees
plotTrees.summ<-ddply(plotTrees, ~plotid, summarize,
                      nTrees=length(plotid),
                      BA_total=sum(basalArea.m2, na.rm=T),
                      BA_AM=sum(basalArea.m2[myc=='A'], na.rm=T),
                      BA_ECM=sum(basalArea.m2[myc=='E'], na.rm=T),
                      PercBA_AM=(BA_AM/BA_total)*100,
                      PercBA_ECM=(BA_ECM/BA_total)*100)
#update the number of trees (there was a cell that was counted even for plots where there were no trees
plotTrees.summ[plotTrees.summ$plotid %in% c(12,15),'nTrees']<-0
plotTrees.summ[plotTrees.summ$plotid %in% c(12,15),c('PercBA_AM','PercBA_ECM')]<-NA
tmp<-plotTrees.summ[,c('plotid','nTrees','BA_total','PercBA_AM')]
trees_c<-tmp

#add tree data 
data<-merge(soilVegData, trees_c) 

#get rid of the plots without trees
data<-data[data$nTrees != 0,]
#str(data)


##############
#B. Deal with soil N data in years where 0-5cm and 5-15cm layers were measured separately 
##############
# Plot histogram of values by depth

#subset by year
data.1213<-subset(data, year %in% c(2012, 2013))

#reshape
data.1213_melted <- melt(data.1213,id.vars=c("plotid","plothalfid1","inv","year"))
data.1213_melted$value<-as.numeric(data.1213_melted$value)

#subset by _B and _T
data.1213_melted_soilVars<-data.1213_melted[grepl("_B",data.1213_melted$variable) | grepl("_T",data.1213_melted$variable),]

#add back the separate measCat and depth columns
tmp<-ldply(strsplit(as.character(data.1213_melted_soilVars$variable),"_", fixed=T))
colnames(tmp)<-c('measCat','depth')
data.1213_melted_soilVars<-cbind(data.1213_melted_soilVars, tmp)

#correct the dataframe structure
data.1213_melted_soilVars$measCat<-factor(data.1213_melted_soilVars$measCat, levels=measCat_order)
data.1213_melted_soilVars$depth<-factor(data.1213_melted_soilVars$depth, levels=depth_order)
data.1213_melted_soilVars$inv<-factor(data.1213_melted_soilVars$inv, levels=inv_order)

#plot
pHist.depth<-ggplot(data.1213_melted_soilVars, aes(x=value, fill=depth)) + 
  geom_bar() + mytheme + facet_wrap(measCat~year, scales='free') +
  ggtitle("Histogram of soil measurement values by soil depth and year")
pHist.depth  

#save plot
newfilename<-'pHist_depth.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*4, height = fig.height*4, res=fig.res)
pHist.depth
dev.off()


##############
#C. DATASET A : Aggregate values, put aggregated values into full dataset and replace empty _F rows
##############

#aggregate by depth
summ.data.1213_melted_soilVars<-ddply(data.1213_melted_soilVars, ~plotid+plothalfid1+inv+year+measCat, summarize,
                      new.value=mean(value, na.rm=T),
                      n=length(plothalfid1),
                      note='aggregated by depth')

#make a dataset without the dis-aggregated data
data_melted <- melt(data,id.vars=c("plotid","plothalfid1","inv","year")) #melt down the full dataset, including 2011 data
data_melted$value<-as.numeric(data_melted$value) #make values numeric again
uniqWo.B<-unique(data_melted$variable)[!grepl("_B",unique(data_melted$variable))] #isolate only the variables that do NOT included the non-aggregated data
uniqWo.BT<-uniqWo.B[!grepl("_T",uniqWo.B)] #ditto
data_m_woBT<-data_melted[data_melted$variable %in% uniqWo.BT,] #subset data by 'correct' variables
selectvars<-unique(data_m_woBT$variable)[grepl("_F",unique(data_m_woBT$variable))] #select measCat variables with "_F"
data_m_woBT_e<-data_m_woBT[!(data_m_woBT$year %in% c(2012,2013) & data_m_woBT$variable %in% selectvars), ] #remove rows without data because it has not yet been aggregated
data_m_woBT_e$note<-NA

#make a dataset with the correctly-aggregated data and comparable column names to data_m_woBT
summ.data.1213_melted_soilVars<-rename(summ.data.1213_melted_soilVars, replace=c("new.value" = "value")) #rename new.value -> value
summ.data.1213_melted_soilVars$variable<-paste(summ.data.1213_melted_soilVars$measCat, '_F',sep="")#measCat items should be ammended with '_F' to indicate that the values are representative of the full soil core depth... put this in a new column called 'variable'
summ.data.1213_melted_soilVars<-summ.data.1213_melted_soilVars[,c('plotid','plothalfid1','inv','year','variable','value','note')]#get rid of 'n' and 'measCat' columns

#merge
data_a<-rbind(data_m_woBT_e, summ.data.1213_melted_soilVars)
#ddply(data_a, ~year+variable, summarize, n=length(plotid)) #check the dataframe structure
#ddply(data_a, ~inv+variable, summarize, n=length(plotid)) #check the dataframe structure

#add a column that categorizes the variable types
data_a$varType<-NA
data_a[grepl("_F", data_a$variable),'varType']<-'measCat'
data_a[data_a$variable %in% c('mv_g.m2','nat_g.m2','litter_g.m2','total_g.m2'),'varType']<-'understoryBiom'
data_a[data_a$variable %in% c('percpar','soiltemp','soilBasin'),'varType']<-'environParam'
data_a[data_a$variable %in% c('nTrees','BA_total','PercBA_AM'),'varType']<-'overstoryParam'

#add a column that identifies whether the variable type is measured on the plot half or the plot level
plotlevel.vars<-c('soilBasin','nTrees','BA_total','PercBA_AM')
plothalflevel.vars<-unique(data_a$variable)[!unique(data_a$variable) %in% plotlevel.vars]
data_a$measLevel<-NA
data_a[data_a$variable %in% plotlevel.vars,'measLevel']<-'plot'
data_a[data_a$variable %in% plothalflevel.vars,'measLevel']<-'plothalf'

#Ammend variable names with "_N" or "_I" depending on the plothalf
data_a$variable1<-paste(data_a$variable, data_a$inv, sep="_")
data_a[data_a$measLevel=='plot','variable1']<-as.character(data_a[data_a$measLevel=='plot','variable'])

#save and export
newfilename<-'data_a.txt'
write.table(data_a, file=paste(synthdataPath,newfilename, sep='/'), sep='\t')


##############
#D. DATASET D : Keep 2012 and 2013 values dis-aggregated and remove 2011 _F values, remove biomass values from 2011 since time point was past peak biomass
##############
#start with data.1213_melted
data_d<-data.1213_melted[!grepl("_F", data.1213_melted$variable),] #remove variables that were only measured in 2011
data_d<-data_d[data_d$variable != 'soiltemp',] #remove variables that were only measured in 2011

#add a column that categorizes the depth types
data_d$depth<-NA
data_d[grepl("_B", data_d$variable),'depth']<-'B'
data_d[grepl("_T", data_d$variable),'depth']<-'T'

#add a column that categorizes the variable types
data_d$varType<-NA
data_d[grepl("_B", data_d$variable),'varType']<-'measCat'
data_d[grepl("_T", data_d$variable),'varType']<-'measCat'
data_d[data_d$variable %in% c('mv_g.m2','nat_g.m2','litter_g.m2','total_g.m2'),'varType']<-'understoryBiom'
data_d[data_d$variable %in% c('percpar'),'varType']<-'environParam'
data_d[data_d$variable %in% c('nTrees','BA_total','PercBA_AM'),'varType']<-'overstoryParam'

#add a column that identifies whether the variable type is measured on the plot half or the plot level
plotlevel.vars<-c('nTrees','BA_total','PercBA_AM')
plothalflevel.vars<-unique(data_d$variable)[!unique(data_d$variable) %in% plotlevel.vars]
data_d$measLevel<-NA
data_d[data_d$variable %in% plotlevel.vars,'measLevel']<-'plot'
data_d[data_d$variable %in% plothalflevel.vars,'measLevel']<-'plothalf'

#Ammend variable names with "_N" or "_I" depending on the plothalf
data_d$variable1<-paste(data_d$variable, data_d$inv, sep="_")
data_d[data_d$measLevel=='plot','variable1']<-as.character(data_d[data_d$measLevel=='plot','variable'])

#save and export
newfilename<-'data_d.txt'
write.table(data_d, file=paste(synthdataPath,newfilename, sep='/'), sep='\t')


#######
# DATA CHOICE : decide which dataset to use
data.choice<-data_a
#######

```


_________________________________________________________________
# 1. Q1: What environmental factors predict Microstegium biomass?
```{r q1, echo=TRUE, message=FALSE, warning=FALSE}
#1. Decide which plot variables to use to predict mv biomass, look at how they are correlated, ordinate
#a) name the independent vars
measCat_F_N<-paste(measCat_F, "N", sep="_")
percpar_N<-paste('percpar','N',sep="_")
biomVars<-c('nat_g.m2','litter_g.m2')
biomVars_N<-paste(biomVars, "N", sep="_")
indp.varsF<-c(measCat_F_N, percpar_N, biomVars_N, P_vars) #make vector of terms

#b) subset
data.q1.indp<-data.choice[data.choice$variable1 %in% indp.varsF, c('plotid','plothalfid1','year','variable1','value')]
data.q1.indp<-ddply(data.q1.indp, ~plotid+plothalfid1+year+variable1, summarize, value=unique(value)) #had to do this to get rid of the extra rows from plot data shown with the same values for invaded and reference areas
data.q1.indp$variable1<-factor(data.q1.indp$variable1, levels=indp.varsF)
data.q1.indp1<-subset(data.q1.indp, variable1 %in% c(indp.varsF))
q1.indp<-dcast(data.q1.indp1, plotid + plothalfid1 + year ~ variable1, value.var='value')
q1.indp$plothalfyear<-paste(q1.indp$plothalfid1, q1.indp$year, sep="_")
row.names(q1.indp)<-q1.indp$plothalfyear
NonValCols<-c('plotid','plothalfid1','plothalfyear', 'year')
ValCols<-colnames(q1.indp)[!(colnames(q1.indp) %in% NonValCols)]

#c) look at correlation matrix
#is.na(q1.indp)
q1.indp<-q1.indp[!rowSums(is.na(q1.indp))>0,]
cor(q1.indp[,ValCols])

#d) ordinate
tmp<-q1.indp[,ValCols]
colnames(tmp)<-prettyColNames
PCA.res<-prcomp(tmp, scale.=T)
summary(PCA.res)
ggbiplot(PCA.res, groups=factor(q1.indp$year), ellipse = T) + 
  mytheme + ylim(c(-2.4,2.5))

#2. Do PC1 and/or PC2 scores predict microstegium biomass?
#a) subset
data_mv.I<-subset(data.choice, variable=='mv_g.m2' & inv=='I')
data_mv.I<-rename(data_mv.I, replace=c("value"="mv_g.m2_I"))
data_mv.I<-data_mv.I[,c('plotid','year','mv_g.m2_I')]

#b) look at the distribution of mv biomass
pHist.mv<-ggplot(data_mv.I,aes(x=mv_g.m2_I, fill=factor(year))) + 
  geom_histogram(bin=10) + mytheme + 
  facet_wrap(~year, scales='fixed', ncol=1) +
  ggtitle('Histogram of Mv biomass by year') + xlab('Microstegium biomass (g/m2)') + ylab('Count')
pHist.mv
#log-transform mv biomass
data_mv.I$mv_g.m2_I_logt<-log(data_mv.I$mv_g.m2_I)
#plot again
pHist.mv.OR.logt<-ggplot(data_mv.I, aes(x=mv_g.m2_I_logt, fill=factor(year))) + 
  geom_histogram(bin=0.25) + mytheme + 
  facet_wrap(~year, scales='fixed', ncol=1) +
  ggtitle('Histogram of Mv biomass by year\nLog-transformed') + xlab('Microstegium biomass (g/m2)') + ylab('Count')
pHist.mv.OR.logt
shapiro.test(data_mv.I$mv_g.m2_I_logt) #normally distributed (aggregated by year)
paste('Log-transformed Mv biomass values are close to normally distributed with Shapiro-Wilk normality test p-value = 0.07')
 
#c) visualize with fancy ordination plot
q1.indp.mv<-merge(q1.indp,data_mv.I)
row.names(q1.indp.mv)<-q1.indp.mv$plothalfyear
tmp<-q1.indp.mv[,ValCols]
colnames(tmp)<-prettyColNames
PCA.res<-prcomp(tmp, scale.=T)
plot<-ggbiplot(PCA.res, groups=q1.indp.mv$mv_g.m2_I_logt) + 
  mytheme + ylim(c(-2.4,2.5)) + ggtitle('Plots in reference area environmental space\n -- Microstegium (Log-transformed g/m2)')
plot

#d) run regression models
data.reg<-data.frame(plothalfyear=rownames(PCA.res$x), PCA.res$x)
data.reg<-merge(data.reg[,c(1:3)],
        q1.indp.mv[,c('plothalfyear','year','mv_g.m2_I','mv_g.m2_I_logt')])
colnames(data.reg)
mod<-lmer(mv_g.m2_I_logt~PC1*PC2 + (1|year), data=data.reg)
anova(mod)
summary(mod)
# mv biomass increases with PC2 (not PC1 or interaction)
```

_________________________________________________________________
# 2. Q2: What understory environmental factors shift in response to the presence of Microstegium? 
```{r q2, echo=TRUE, message=FALSE, warning=FALSE}
#1. Decide which plothalf variables to use to predict invasion status, look at how they are correlated, ordinate
#a) name the independent vars
indp.varsF<-c(measCat_F, 'percpar', biomVars) #make vector of terms

#b) subset
data.q2.indp<-data.choice[data.choice$variable %in% indp.varsF, c('plotid','plothalfid1','inv','year','variable','value')]
data.q2.indp$variable<-factor(data.q2.indp$variable, levels=indp.varsF)
data.q2.indp1<-subset(data.q2.indp, variable %in% c(indp.varsF))
q2.indp<-dcast(data.q2.indp1, plothalfid1 + inv+ year ~ variable, value.var='value')
q2.indp$plothalfyear<-paste(q2.indp$plothalfid1, q2.indp$year, sep="_")
row.names(q2.indp)<-q2.indp$plothalfyear
NonValCols<-c('plothalfid1','plothalfyear', 'inv','year')
ValCols<-colnames(q2.indp)[!(colnames(q2.indp) %in% NonValCols)]

#c) look at correlation matrix
#is.na(q2.indp)
q2.indp<-q2.indp[!rowSums(is.na(q2.indp))>0,]
cor(q2.indp[,ValCols])

#d) ordinate
tmp<-q2.indp[,ValCols]
colnames(tmp)<-prettyColNames[1:10]
PCA.res<-prcomp(tmp, scale.=T)
plot<-ggbiplot(PCA.res, groups=q2.indp$inv, ellipse=T) + 
  mytheme + 
  ggtitle('Plot-halves in environmental space\n -- Invasion status')
plot  

#2. Do differences in understory environmental factors correspond to the presence/absence of Microstegium?
#a) test??????
```

_________________________________________________________________
# 3. Q3: Are there plot-level environmental factors that predict the relative/absolute impact of Microstegium on soil N pools and fluxes?
```{r q3, echo=TRUE, message=FALSE, warning=FALSE}
#1. Calculate the absolute and relative difference in soil N pools, soil N fluxes, non-Mv biomass, litter biomass (response variables) ... or maybe just do this in multivariate environmental space...
#a) name the response vars
#abs. diff measCat_F (minus som) and diff biomVars
#rel. diff measCat_F (minus som) and diff biomVars
resp.varsF<-c(measCat_F[-7], biomVars) #make vector of terms

#b) subset
data.q3.resp<-data.choice[data.choice$variable %in% resp.varsF,
                          c('plotid','inv','year','variable','value')]
data.q3.resp$variable<-factor(data.q3.resp$variable, levels=resp.varsF)
q3.resp<-dcast(data.q3.resp, plotid + inv+ year ~ variable, value.var='value')
q3.resp$plothalfyear<-paste(q3.resp$plotid, q3.resp$inv, q3.resp$year, sep="_")
row.names(q3.resp)<-q3.resp$plothalfyear
NonValCols<-c('plotid','plothalfyear', 'inv','year')
ValCols<-colnames(q3.resp)[!(colnames(q3.resp) %in% NonValCols)]

#b2) look at correlation matrix
#is.na(q3.indp)
q3.resp<-q3.resp[!rowSums(is.na(q3.resp))>0,]
cor(q3.resp[,ValCols])

#b3) ordinate
tmp<-q3.resp[,ValCols]
#colnames(tmp)<-prettyColNames[1:10]
PCA.res<-prcomp(tmp, scale.=T)
plot<-ggbiplot(PCA.res, groups=q3.resp$inv, ellipse=T) + 
  mytheme + 
  ggtitle('Plot-halves in environmental space\n -- Invasion status')
plot  

#c-1) calculate absolute and relative differences
#c-2) look at correlations among the absolute and relative difference measures
#c-3) calculate multivariate vector length between invaded and reference plothalfs in multivariate space
data.res<-data.frame(plothalfyear=rownames(PCA.res$x), PCA.res$x)
data.res<-merge(data.res, q3.resp[,c('plothalfyear','inv', 'plotid','year')])
data.res.I<-subset(data.res, inv=='I')
data.res.N<-subset(data.res, inv=='N')
PCcols<-paste('PC',1:8, sep='')
i<-0
euclid.list<-list()
dim(data.res.I)
for(i in 1:dim(data.res.I)[1]){
  euclid.dist<-sqrt(sum((data.res.I[i,PCcols]-data.res.N[i,PCcols])^2))
  euclid.list[[i]]<-data.frame(data.res.I[i,c('plotid','year')], euclid.dist)
}
df.euclid<-ldply(euclid.list)
df.euclid

#2. Decide which plot-level environmental factors to use to predict magnitude and direction of understory shifts, look at how they are correlated, ordinate
#a) name the independent vars
indp.varsF<-c(measCat_F[7], P_vars) #make vector of terms

#b) subset
data.q3.indp<-data.choice[data.choice$variable %in% indp.varsF,
                          c('plotid','inv','year','variable','value')]
data.q3.indp$variable<-factor(data.q3.resp$variable, levels=indp.varsF)
q3.indp<-dcast(data.q3.indp, plotid + inv+ year ~ variable, value.var='value')
q3.indp<-subset(q3.indp, inv=='N')
q3.indp$plothalfyear<-paste(q3.indp$plotid, q3.indp$year, sep="_")
row.names(q3.indp)<-q3.indp$plothalfyear
NonValCols<-c('plotid','plothalfyear', 'inv','year')
ValCols<-colnames(q3.indp)[!(colnames(q3.indp) %in% NonValCols)]

#c) look at correlation matrix
#is.na(q3.indp)
q3.indp<-q3.indp[!rowSums(is.na(q3.indp))>0,]
cor(q3.indp[,ValCols]) #not highly correlated

#2. Do q3.indp vars predict understory difference values (multivariate vector length?
#a) test
data.reg<-merge(df.euclid, q3.indp)
data.reg<-merge(data.reg,data_mv.I)

mod<-lmer(euclid.dist~som_F + (1|year), data=data.reg)
anova(mod)
mod<-lmer(euclid.dist~nTrees + (1|year), data=data.reg)
anova(mod)
mod<-lmer(euclid.dist~BA_total + (1|year), data=data.reg)
anova(mod)
mod<-lmer(euclid.dist~PercBA_AM + (1|year), data=data.reg)
anova(mod)
mod<-lmer(euclid.dist~mv_g.m2_I_logt+ (1|year), data=data.reg)
anova(mod)

pImp.som<-ggplot(data.reg, aes(x=som_F, y=euclid.dist)) + 
  geom_point() + mytheme + xlab("Soil organic matter (%)") +
  ylab("Invasion impact (euclidean distance)")

pImp.nTrees<-ggplot(data.reg, aes(x=nTrees, y=euclid.dist)) + 
  geom_point() + mytheme + xlab("Number of trees") +
  ylab("Invasion impact (euclidean distance)")

pImp.BA<-ggplot(data.reg, aes(x=BA_total, y=euclid.dist)) + 
  geom_point() + mytheme + xlab("Tree basal area (m2)") +
  ylab("Invasion impact (euclidean distance)")

pImp.AM<-ggplot(data.reg, aes(x=PercBA_AM, y=euclid.dist)) + 
  geom_point() + mytheme + xlab("Tree basal area (m2)") +
  ylab("Invasion impact (euclidean distance)")

pImp.mv<-ggplot(data.reg, aes(x=mv_g.m2_I_logt, y=euclid.dist)) + 
  geom_point() + mytheme + xlab("Microstegium biomass (log g/m2)") +
  ylab("Invasion impact (euclidean distance)")

grid.arrange(pImp.som, pImp.nTrees, pImp.BA, pImp.AM, pImp.mv)

#b) visualize

```


#SCRAPS
```{r scraps, echo=TRUE, message=FALSE, warning=FALSE}
#plot ES ~ 1) meas_N values, 2) percpar, 3) plot trees, 4) mvBiom, 5) year

#c) subset plot variables
data_plot<-subset(data.choice, measLevel=='plot')
summ.data_plot<-ddply(data_plot, ~plotid + year + variable, summarize,
      uniq.value=paste(unique(value),collapse = "_"))
data_plot.cast<-dcast(summ.data_plot, plotid + year ~ variable, value.var='uniq.value')

#3. subset plothalf variables, reshape by inv
data_plothalf<-subset(data.choice, measLevel=='plothalf')
data_plothalf.IN<-dcast(data_plothalf, plotid + year + variable ~ inv, value.var='value')
data_plothalf.N<-data_plothalf.IN[,c('plotid','year','variable','N')]
data_plothalf.N<-rename(data_plothalf.N, replace=c("N"="value"))

#3b. add percpar aggregated by plot (inv + nat /2) as a variable
percpar_plothalf.IN<-subset(data_plothalf.IN, variable == 'percpar')
percpar_plothalf.IN$percparPlot<-(percpar_plothalf.IN$I + percpar_plothalf.IN$N)/2
colnames(percpar_plothalf.IN)[colnames(percpar_plothalf.IN)=='I']<-'percparI'
colnames(percpar_plothalf.IN)[colnames(percpar_plothalf.IN)=='N']<-'percparN'
percpar_plothalf<-percpar_plothalf.IN[,!colnames(percpar_plothalf.IN) %in% 'variable']
percpar_plothalf.m<-melt(percpar_plothalf, id.vars=c('plotid','year'))
tmp<-subset(percpar_plothalf.m, variable != 'percparN')
data_plothalfplus<-rbind(data_plothalf.N,tmp)

#4. merge dataframes
tmp1<-merge(data_mv.I,data_plot.cast)
tmp2<-merge(tmp1, data_plothalfplus)

#5. make plothalf variables wide and then melt everything down
tmp2_cast<-dcast(tmp2, plotid + year + mv_g.m2_I + mv_g.m2_I_logt + nTrees + BA_total + PercBA_AM ~ variable, value.var='value')
data_mvI <- melt(tmp2_cast,id.vars=c("plotid","year","mv_g.m2_I","mv_g.m2_I_logt")) #melt down the full dataset
data_mvI$value<-as.numeric(data_mvI$value)

#6. Factor labels
vars<-c(measCat_T, measCat_B, "mv_g.m2_I_logt", otherPH_vars, P_vars)
var_names<-c(paste(measCat_names,"T", sep="_"), paste(measCat_names,"B", sep="_"), "Log-transformed Microstegium biomass",otherPH_names, P_names)
factor.indx<-data.frame(variable=vars, var_names)
data_mvI<-merge(data_mvI, factor.indx)
data_mvI$variable<-factor(data_mvI$variable, levels=vars)
data_mvI$var_names<-factor(data_mvI$var_names, levels=var_names)

#prep dataset
data_mvI<-subset(data_mvI, variable != 'total_g.m2') #this is typically the same as nat in reference plots
data_mvI<-subset(data_mvI, variable != 'mv_g.m2') #there are only 3 observations of Mv biomass in reference plots and the values are small
data_mvI$variable<-droplevels(data_mvI$variable)
vars1<-vars[!vars %in% c('total','mv')]
factor.indx1<-factor.indx[!factor.indx$variable %in% c('total','mv'),]
var_names1<-factor.indx1$var_names 
data_mvI$plotid<-factor(data_mvI$plotid)
data_mvI$year<-factor(data_mvI$year)
data_mvI$measCat<-NA
data_mvI$depth<-NA
i<-0
for(i in 1:length(measCat_order)){
  data_mvI[data_mvI$variable==measCat_B[i],'measCat']<-measCat_order[i]
  data_mvI[data_mvI$variable==measCat_T[i],'measCat']<-measCat_order[i]
  data_mvI[data_mvI$variable==measCat_B[i],'depth']<-'B'
  data_mvI[data_mvI$variable==measCat_T[i],'depth']<-'T'
}
data_mvI$measCat<-factor(data_mvI$measCat, levels=measCat_order)
data_mvI$depth<-factor(data_mvI$depth)

#run a linear model to determine the role of year and variable on mvI_logt
#mod1 <- lm(mvI_logt ~ year + value + year:value, data=df)
#mod2 <- lm(mvI_logt ~ value + year + value:year, data=df)
MvYrMods<-FitPlot.MvYr(data_mvI)
MvYrMods_table<-ldply(MvYrMods[['mod1L']])
MvYrMods_table$.id<-factor(MvYrMods_table$.id, levels = vars)
MvYrMods_table<-dcast(MvYrMods_table, .id ~ terms, value.var = 'pvals.a') #these are anova p-values from sequential term removal 
MvYrMods_table #no effect of year or year:value
#save and export
newfilename<-'MvYrMods_table.txt'
write.table(MvYrMods_table, file=paste(synthdataPath,newfilename, sep='/'), sep='\t')

#run a mixed effects model to determine the role of year and measCat on mvI_logt, with depth as a random effect
#mod <- lmer(mvI_logt ~ year + value + year:value + (1|depth), data=df)
MvYrDpMods<-FitPlot.MvYrDp(data_mvI)
MvYrDpMods_table<-ldply(MvYrDpMods[['results']])
MvYrDpMods_table$.id<-factor(MvYrDpMods_table$.id, levels = measCat_order)
MvYrDpMods_table<-dcast(MvYrDpMods_table, .id ~ terms, value.var = 'pvals.a') #these are anova p-values from sequential term removal 
MvYrDpMods_table #no effects
#save and export
newfilename<-'MvYrDpMods_table.txt'
write.table(MvYrDpMods_table, file=paste(synthdataPath,newfilename, sep='/'), sep='\t')

#run mixed effects models where year is a random effect and each variable is a fixed effect
#mod <- lmer(mvI_logt ~ value + (1|year), data = df)
MvMods<-FitPlot.Mv(data_mvI)
MvMods_table<-ldply(MvMods[['results']])
MvMods_table
#save and export
newfilename<-'MvMods_table.txt'
write.table(MvMods_table, file=paste(synthdataPath,newfilename, sep='/'), sep='\t')
MvFE_table<-ldply(MvMods[['coef']])
MvFE_table
#save and export
newfilename<-'MvFE_table.txt'
write.table(MvFE_table, file=paste(synthdataPath,newfilename, sep='/'), sep='\t')
#save plot
newfilename<-'pScat_mvI_logt.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*5, height = fig.height*5, res=fig.res)
grid.arrange(
      textGrob('Microstegium biomass (log-transformed)', y=0.5, x=unit(1,'lines'), rot=90), # ylabel topleft
      do.call(arrangeGrob,  MvMods[['figures']]),
      textGrob(" "), #bottom left
      textGrob("Variable value", x=0.5, y=unit(1,'lines')), #bottom right
      widths = unit.c(unit(2.5, "lines"), unit(1, "npc") - unit(2.5, "lines")), 
      heights = unit.c(unit(1, "npc") - unit(2.5, "lines"), unit(2.5, "lines")), 
      nrow=2, ncol=2
    )
dev.off()

# #check out the relationships between nTrees, BA_total, PercBA_ECM, percpar
# # add back the mvI biomass data from 2011
data.2011<-subset(data, year == 2011)
mv.2011<-data.2011[data.2011$inv == 'I',c('plotid','inv','year','mv_g.m2')]
mv.2011<-rename(mv.2011, c(mv_g.m2='mv_g.m2_I'))
mv.2011<-mv.2011[,!colnames(mv.2011)=='inv']
mv.2011$mv_g.m2_I_logt<-log(mv.2011$mv_g.m2_I)

data_mv.I1<-merge(data_mv.I, mv.2011, all = TRUE) #all years of mv biomass in invaded area

data_plot.tmp<-merge(data_plot.cast,percpar_plothalf, all=TRUE) #all the other factors I'm interested in
tmp<-ddply(data_plot.tmp, ~plotid, summarise,
      nTrees=unique(nTrees),
      BA_total=unique(BA_total),
      PercBA_AM=unique(PercBA_AM))
tmp$year<-2011
data_plot.tmp1<-merge(data_plot.tmp, tmp, all=TRUE)

data_tmp<-merge(data_plot.tmp1,data_mv.I1, all=TRUE) #merge mv biomass data with the other factors
data_tmp$nTrees<-as.numeric(data_tmp$nTrees) #for some reason, these where auto-coded as characters (probably because of the NAs)
data_tmp$BA_total<-as.numeric(data_tmp$BA_total)
data_tmp$PercBA_AM<-as.numeric(data_tmp$PercBA_AM)
data_tmp$year<-factor(data_tmp$year)
#get rid of mv biomass outlier in 2011
data_tmp[data_tmp$mv_g.m2_I>500,c('mv_g.m2_I','mv_g.m2_I_logt')]<-NA
data_tmp.11<-subset(data_tmp, year=2011)

#LOOK AT CORRELEATIONS

# mvI vs Trees
ylabTitle<-'M.v. (g/m2, log-trans)'
mv.nTrees<-ggplot(data_tmp, aes(x=nTrees, y=mv_g.m2_I_logt, shape=year, linetype=year)) +
  geom_point(show_guide=FALSE) + geom_smooth(method='lm', show_guide=FALSE) + 
  mytheme + ylab(ylabTitle) + xlab("Number of trees") + scale_shape_manual(values=yearShape) + scale_linetype_manual(values=yearLine)
mv.BA<-ggplot(data_tmp, aes(x=BA_total, y=mv_g.m2_I_logt, shape=year, linetype=year)) + 
  geom_point(show_guide=FALSE) + geom_smooth(method='lm',show_guide=FALSE) + 
  mytheme + ylab(ylabTitle) + xlab("Basal area") + scale_shape_manual(values=yearShape) + scale_linetype_manual(values=yearLine)
mv.AM<-ggplot(data_tmp, aes(x=PercBA_AM, y=mv_g.m2_I_logt, shape=year, linetype=year)) + 
  geom_point(show_guide=FALSE)+
  mytheme + ylab(ylabTitle) + xlab("%AM basal area") + scale_shape_manual(values=yearShape) + scale_linetype_manual(values=yearLine)
nTrees.BA<-ggplot(data_tmp.11, aes(x=nTrees, y=BA_total)) + 
  geom_point() + geom_smooth(method='lm') + 
  mytheme + ylab("Basal area") + xlab("Number of trees")
nTrees.AM<-ggplot(data_tmp.11, aes(x=nTrees, y=PercBA_AM)) + 
  geom_point() + 
  mytheme + ylab("%AM basal area") + xlab("Number of trees")
BA.AM<-ggplot(data_tmp.11, aes(x=BA_total, y=PercBA_AM)) + 
  geom_point() + 
  mytheme + ylab("%AM basal area") + xlab("Basal area")
dummyPlot<-ggplot(data_tmp, aes(x=nTrees, y=mv_g.m2_I_logt, shape=year, linetype=year)) +
  geom_point() + geom_smooth(method='lm') + 
  mytheme + ylab(ylabTitle) + xlab("") + scale_shape_manual(values=yearShape) + scale_linetype_manual(values=yearLine)
thisLegend<-g_legend(dummyPlot)
#save plot
newfilename<-'pScat_mv_Trees.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*3, height = fig.height*3, res=fig.res)
grid.arrange(mv.nTrees, mv.BA, mv.AM, 
             nTrees.BA, nTrees.AM, BA.AM, 
             thisLegend, nrow=3, ncol=3)
dev.off()

# mvI vs PAR
mv.percparI<-ggplot(data_tmp, aes(x=percparI, y=mv_g.m2_I_logt, shape=year, linetype=year)) +
  geom_point(show_guide=FALSE) + geom_smooth(method='lm', show_guide=FALSE) + 
  mytheme + ylab(ylabTitle) + xlab("%PAR invaded area") + scale_shape_manual(values=yearShape) + scale_linetype_manual(values=yearLine)
mv.percparN<-ggplot(data_tmp, aes(x=percparN, y=mv_g.m2_I_logt, shape=year, linetype=year)) +
  geom_point(show_guide=FALSE) + geom_smooth(method='lm', show_guide=FALSE) + 
  mytheme + ylab(ylabTitle) + xlab("%PAR reference area") + scale_shape_manual(values=yearShape) + scale_linetype_manual(values=yearLine)
percparI.percparN<-ggplot(data_tmp, aes(x=percparN, y=percparI, shape=year, linetype=year)) +
  geom_point(show_guide=FALSE) + geom_smooth(method='lm', show_guide=FALSE) + 
  mytheme + ylab("%PAR invaded area") + xlab("%PAR reference area") + scale_shape_manual(values=yearShape) + scale_linetype_manual(values=yearLine)
#save plot
newfilename<-'pScat_mv_percpar.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*2, height = fig.height*2, res=fig.res)
grid.arrange(mv.percparN, mv.percparI, 
             percparI.percparN, thisLegend, nrow=2)
dev.off()


# Trees vs PAR
nTrees.percparI<-ggplot(data_tmp, aes(x=nTrees, y=percparI)) + 
  geom_point() + 
  mytheme + ylab("%PAR invaded area") + xlab("Number of trees")
BA.percparI<-ggplot(data_tmp, aes(x=BA_total, y=percparI)) + 
  geom_point() + 
  mytheme + ylab("%PAR invaded area") + xlab("Basal area")
AM.percparI<-ggplot(data_tmp, aes(x=PercBA_AM, y=percparI)) + 
  geom_point() + 
  mytheme + ylab("%PAR invaded area") + xlab("%AM basal area")
nTrees.percparN<-ggplot(data_tmp, aes(x=nTrees, y=percparN)) + 
  geom_point() +  
  mytheme + ylab("%PAR reference area") + xlab("Number of trees")
BA.percparN<-ggplot(data_tmp, aes(x=BA_total, y=percparN)) + 
  geom_point() + 
  mytheme + ylab("%PAR reference area") + xlab("Basal area")
AM.percparN<-ggplot(data_tmp, aes(x=PercBA_AM, y=percparN)) + 
  geom_point() + 
  mytheme + ylab("%PAR reference area") + xlab("%AM basal area")
#save plot
newfilename<-'pScat_Trees_PAR.png'
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*3, height = fig.height*3, res=fig.res)
grid.arrange(nTrees.percparI, BA.percparI, AM.percparI, 
             nTrees.percparN, BA.percparN, AM.percparN, nrow=2)
dev.off()

#########################################

#reshape so that I and N measures are different columns
data.choice.cast<-dcast(data.choice, plotid+year+variable+depth+varType+measLevel ~ inv, value.var='value')

#subset soil measurements
data.choice.cast.meas<-subset(data.choice.cast, variable %in% c(measCat_B, measCat_T))
data.choice.cast.meas$variable<-droplevels(data.choice.cast.meas$variable)
data.choice.cast.meas$variable<-factor(data.choice.cast.meas$variable,
                                       levels=c(measCat_T, measCat_B))
data.choice.cast.meas$plotid<-factor(data.choice.cast.meas$plotid)
data.choice.cast.meas$year<-factor(data.choice.cast.meas$year)

#plot
list.figures<-FitPlot.IN(data.choice.cast.meas)
grid.arrange(
      textGrob('Invaded area value', y=0.5, x=unit(1,'lines'), rot=90), # ylabel topleft
      do.call(arrangeGrob,  list.figures),
      textGrob(" "), #bottom left
      textGrob("Reference area value", x=0.5, y=unit(1,'lines')), #bottom right
      widths = unit.c(unit(2.5, "lines"), unit(1, "npc") - unit(2.5, "lines")), 
      heights = unit.c(unit(1, "npc") - unit(2.5, "lines"), unit(2.5, "lines")), 
      nrow=2, ncol=2
    )

#first, transform rates so that all values are positive
ggplot(data.choice.cast.meas, aes(x=I)) + ggtitle('Histogram of raw Invaded area values') +
  geom_histogram() + facet_wrap(~variable, scales='free') + mytheme
ggplot(data.choice.cast.meas, aes(x=N)) + ggtitle('Histogram of raw Reference area values') +
  geom_histogram() + facet_wrap(~variable, scales='free') + mytheme
summ.cast.meas<-ddply(data.choice.cast.meas, ~variable, summarize,
      minI=min(I, na.rm=T),
      minN=min(N, na.rm=T),
      minGrand=min(minI,minN),
      amtAdd=minGrand*-1)
amtAdd.indx<-data.frame(variable=summ.cast.meas[summ.cast.meas$minGrand<0,'variable'],
                        amtAdd=summ.cast.meas[summ.cast.meas$minGrand<0,'amtAdd'])
data.choice.cast.meas<-merge(data.choice.cast.meas, amtAdd.indx, all=T)
data.choice.cast.meas[is.na(data.choice.cast.meas$amtAdd),'amtAdd']<-0
data.choice.cast.meas$I_posT<-data.choice.cast.meas$I + data.choice.cast.meas$amtAdd
data.choice.cast.meas$N_posT<-data.choice.cast.meas$N + data.choice.cast.meas$amtAdd

#calculate difference in soil meas for each plotid (I-N)
data.choice.cast.meas$Diff<-data.choice.cast.meas$I_posT - data.choice.cast.meas$N_posT

#make sure ES values are normally distributed or transform
ggplot(data.choice.cast.meas, aes(x=Diff)) + 
  geom_histogram() + facet_wrap(~variable, scales='free') + mytheme

qplot(sample = Diff, data = data.choice.cast.meas) +
  facet_wrap(~variable, scales='free') + mytheme

summ.tmp<-ddply(data.choice.cast.meas, ~variable, summarize,
      Diff.min=min(Diff, na.rm=T),
      Diff.amtAdd=Diff.min*-1)
amtAdd.Diff.indx<-summ.tmp[,c('variable','Diff.amtAdd')]
data.choice.cast.meas<-merge(data.choice.cast.meas, amtAdd.Diff.indx, all=T)
data.choice.cast.meas$Diff_posT<-data.choice.cast.meas$Diff + data.choice.cast.meas$Diff.amtAdd
data.choice.cast.meas$Diff_logT<-log(data.choice.cast.meas$Diff_posT+1)

measDiff.normality<-ddply(data.choice.cast.meas, ~variable, summarise,
      ShapTest = round(shapiro.test(Diff)$p.value, digits=3),
      ShapTest_logT = round(shapiro.test(Diff_logT)$p.value, digits=3))
measDiff.normality #pretty much none are normally distributed... tried sqrt too


#simplify dataframe
data.q2<-data.choice.cast.meas[,c('plotid','year','variable','Diff', 'N')]
#add back: a) other N variables, percpar, plot trees
data.choice.cast.other<-subset(data.choice.cast, variable %in% c(otherPH_vars, P_vars))
data.choice.cast.other$variable<-droplevels(data.choice.cast.other$variable)

data.choice.cast.other.N<-data.choice.cast.other[,c('plotid','year','variable','N')]
data.choice.cast.other.mvI<-data.choice.cast.other[data.choice.cast.other$variable=='mv_g.m2',
                                                   c('plotid','year','variable','I')]

```

